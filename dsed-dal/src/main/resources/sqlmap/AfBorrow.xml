<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ald.fanbei.api.dal.dao.AfBorrowDao">
	<sql id="queryFields">
		id rid,gmt_create, gmt_modified,borrow_no,user_id,type,name,amount,status,remark,nper,nper_repayment,overdue_num,order_id,
		nper_amount,repay_prin_amount,order_no,card_number,card_name,borrow_rate,calculate_method,free_nper,version
	</sql>
	
	<select id="getBorrowById" resultType="AfBorrowDo">
		SELECT 
			<include refid="queryFields"/>
		FROM af_borrow WHERE is_delete = 0 AND id = #{id}
    </select>
    
    <select id="getBorrowByOrderId" resultType="AfBorrowDo">
		SELECT 
			<include refid="queryFields"/>
		FROM af_borrow WHERE is_delete = 0 AND order_id = #{orderId} LIMIT 1
    </select>
    
    <select id="getBorrowByOrderIdAndStatus" resultType="AfBorrowDo">
		SELECT 
			<include refid="queryFields"/>
		FROM af_borrow WHERE is_delete = 0 AND order_id = #{orderId} and status = #{status} LIMIT 1
    </select>
    
    

	<insert id="addBorrow" keyProperty="rid" useGeneratedKeys="true" parameterType="AfBorrowDo">
		INSERT INTO af_borrow (
			gmt_create,
			gmt_modified,
			user_id,
			type,
			borrow_no,
			name,
			remark,
			amount,
			status,
			nper,
			nper_amount,
			card_number,
			card_name,
			order_id,
			order_no,
			gmt_transed,
			borrow_rate,
			calculate_method,
			version,
			free_nper
			)
			VALUES
			(
			#{gmtCreate},
			#{gmtCreate},
			#{userId},
			#{type},
			#{borrowNo},
			#{name},
			#{remark},
			#{amount},
			#{status},
			#{nper},
			#{nperAmount},
			#{cardNumber},
			#{cardName},
			#{orderId},
			#{orderNo},
			#{gmtTransed},
			#{borrowRate},
			#{calculateMethod},
			#{version},
			#{freeNper}
			)
	</insert>
	
	<insert id="addBorrowBillInfo" keyProperty="rid" useGeneratedKeys="true" parameterType="AfBorrowBillDo">
		  INSERT INTO af_borrow_bill (
		  gmt_create,
		  gmt_modified,
		  user_id,
		  borrow_id,
		  borrow_no,
		  name,
		  status,
		  type,
		  gmt_borrow,
		  bill_year,
		  bill_month,
		  nper,
		  bill_nper,
		  bill_amount,
		  principle_amount,
		  interest_amount,
		  poundage_amount
		) 
		VALUES
	    (
	    	NOW(),
	    	NOW(),
	  		#{userId}, 
	  		#{borrowId},
	  		#{borrowNo},  
	  		#{name}, 
	  		#{status},
	  		#{type},
	  		#{gmtBorrow}, 
	  		#{billYear},
	  		#{billMonth},
	  		#{nper}, 
	  		#{billNper}, 
	  		#{billAmount}, 
	  		#{principleAmount},
	  		#{interestAmount},
	  		#{poundageAmount}
	  	)
   </insert>
   
	<insert id="addBorrowBill" parameterType="java.util.List">
		  INSERT INTO af_borrow_bill (
		  gmt_create,
		  gmt_modified,
		  user_id,
		  borrow_id,
		  borrow_no,
		  name,
		  status,
		  type,
		  gmt_borrow,
		  bill_year,
		  bill_month,
		  nper,
		  bill_nper,
		  bill_amount,
		  principle_amount,
		  interest_amount,
		  poundage_amount,
		  is_free_interest,
		  gmt_out_day,
		  gmt_pay_time
		) 
		VALUES
	    <foreach collection = "list" separator = "," item = "item" index = "index" > 
	    (
	    	NOW(),
	    	NOW(),
	  		#{item.userId}, 
	  		#{item.borrowId},
	  		#{item.borrowNo},  
	  		#{item.name}, 
	  		#{item.status},
	  		#{item.type},
	  		#{item.gmtBorrow}, 
	  		#{item.billYear},
	  		#{item.billMonth},
	  		#{item.nper}, 
	  		#{item.billNper}, 
	  		#{item.billAmount}, 
	  		#{item.principleAmount},
	  		#{item.interestAmount},
	  		#{item.poundageAmount},
	  		#{item.isFreeInterest},
			#{item.gmtOutDay},
			if(#{item.gmtPayTime}>NOW(),#{item.gmtPayTime},ADDDATE(DATE(now()),INTERVAL 59+59*60+23*60*60 SECOND))
	  	)
	  	</foreach> 
   </insert>
   
   <update id="updateBorrow">
		UPDATE
			af_borrow
		SET
			gmt_modified = NOW(),
			total_interest = #{totalInterest},
			total_poundage = #{totalPoundage}
		WHERE
			id = #{id}
	</update>

	<update id="updateBorrowVersion">
		UPDATE
		af_borrow
		SET
		gmt_modified = NOW(),
		version = #{version}
		WHERE
		id = #{id}
	</update>
	
	<select id="getCurrentLastBorrowNo" resultType="java.lang.String">
		select borrow_no from af_borrow WHERE borrow_no LIKE CONCAT(#{orderNoPre},"%") ORDER BY id DESC LIMIT 1;
	</select>
	
	<update id="updateBorrowStatus">
		UPDATE
			af_borrow
		SET
			gmt_modified = NOW(),
			status = #{status}
		WHERE
			id = #{id}
	</update>
	
	<select id="getBorrowNumByUserId" resultType="java.lang.Integer">
		select count(*) from `af_borrow` WHERE `status` in ('TRANSED','FINISH') and `user_id` =#{userId}; 
	</select>
	
	<select id="getBorrowInfoByBorrowNo" resultType="AfBorrowDo">
		SELECT 
			<include refid="queryFields"/>
		FROM af_borrow WHERE is_delete = 0 AND borrow_no = #{borrowNo} LIMIT 1
	</select>

	<select id="getUserNotInBorrow" resultType="AfBorrowDto">
		SELECT
			a.id rid,
			a.NAME name,
			a.amount amount,
			c.gmt_pay payDate
		FROM
			af_borrow a
		LEFT JOIN af_borrow_extend b ON a.id = b.id
		LEFT JOIN af_order c on c.id = a.order_id
		WHERE
			a.is_delete = 0
		AND a.user_id = #{userId}
		AND b.in_bill = 0
		AND a.status = 'TRANSED'
		order by a.gmt_create desc
	</select>

	<select id="getUserSummary" resultType="java.util.HashMap">
		SELECT IFNULL(TIMESTAMPDIFF(HOUR,(SELECT gmt_risk  FROM af_user_auth WHERE user_id =c.user_id   LIMIT 1 ),(SELECT min(gmt_create)  FROM af_borrow_cash WHERE user_id =c.user_id  and `status`='FINSH' )),0) hourBetweenVerifyBorrow,
IFNULL(COUNT(if(overdue_day>=4,true,null))/COUNT(id),0) as rateAfter4Day,
IFNULL(TIMESTAMPDIFF(HOUR,MIN(gmt_create),MAX(gmt_create))/COUNT(id),0) frequency,
IFNULL(COUNT(if(type='SEVEN' OR type='10',true,null))/COUNT(id),0) as rateBorrow7d,
IFNULL(COUNT(if(overdue_status='Y',true,null))/COUNT(id),0) as rateOverdue,
IFNULL(sum(c.repay_amount),0)  totalAmount  ,
COUNT(if(overdue_status='Y',true,null))   countOverdue  ,
IFNULL((SELECT  c1.amount    FROM  af_borrow_cash c1 WHERE  c1.user_id  =c.user_id    and  c1.`status`='FINSH'    order  by  c1.gmt_create  desc  LIMIT  1  ) ,0) lastAmount,
IFNULL((SELECT  c1.overdue_day    FROM  af_borrow_cash c1  WHERE  c1.user_id  =c.user_id    and  c1.`status`='FINSH'    order  by  c1.gmt_create  desc  LIMIT  1  ),0)  lastOverdueDay,
IFNULL(MAX(c.overdue_day  ),0)  maxOverdueDay,
DATE_FORMAT(min(c.gmt_create),'%Y-%m-%d %H:%i:%s') firstBorrowTime
FROM af_borrow_cash c WHERE  `status`='FINSH' and user_id =#{userId}
	</select>
	<select id="getUserNotInBorrowCount" resultType="java.lang.Integer">
		SELECT
			count(1)
		FROM
			af_borrow a
		LEFT JOIN af_borrow_extend b ON a.id = b.id
		LEFT JOIN af_order c on c.id = a.order_id
		WHERE
			a.is_delete = 0
		AND a.user_id = #{userId}
		AND a.status = 'TRANSED'
		AND b.in_bill = 0
	</select>

	<select id="getUserNotInBorrowMoney" resultType="java.math.BigDecimal">
		SELECT
			COALESCE (SUM(a.amount), 0)
		FROM
			af_borrow a
		LEFT JOIN af_borrow_extend b ON a.id = b.id
		LEFT JOIN af_order c on c.id = a.order_id
		WHERE
			a.is_delete = 0
		AND a.user_id = #{userId}
		AND a.status = 'TRANSED'
		AND b.in_bill = 0
	</select>

	<select id="getUserSummaryOrderById" resultType="java.util.HashMap">
		SELECT (SELECT DATE_FORMAT(MIN(bi.`gmt_pay_time`), '%Y-%m-%d')  FROM `af_borrow_bill` bi WHERE  bi.`status`!='C' and bi.`user_id` =o.`user_id`) firstDueDate,o.`order_type` orderType,o.`pay_type` payType,o.`sec_type` secType,o.`order_no` orderNo,o.`user_coupon_id` userCouponId,o.`goods_id` goodsId,o.`goods_name` goodsName,o.`count` count,o.`actual_amount` actualAmount,o.`borrow_amount` borrowAmount,o.`bank_amount` bankAmount
, o.`shop_name`  shopName
,o.`rebate_amount` rebateAmount ,o.`commission_amount`  commissionAmount,o.`rebate_allowance_amount` rebateAllowanceAmount,o.`nper` nper,o.`borrow_rate` borrowRate,o.`coupon_amount` couponAmount,o.`au_amount` auAmount,o.`used_amount` usedAmount ,
(SELECT c.`name`  FROM `af_goods` g LEFT JOIN `af_goods_category` c on g.`primary_category_id`  = c.`id` WHERE g.`id` = o.`goods_id`     LIMIT 1) categoryOne,
(SELECT c.`name`  FROM `af_goods` g LEFT JOIN `af_goods_category` c on g.`category_id`   = c.`id` WHERE g.`id` = o.`goods_id`    LIMIT 1 ) categoryTwo,
(SELECT (SELECT s.`name`  FROM `af_goods_category` s WHERE s.`id`  = c.`parent_id`   LIMIT 1) FROM `af_goods` g LEFT JOIN `af_goods_category` c on g.`category_id`  = c.`id` WHERE g.`id` = o.`goods_id`   ) categoryThree,
'' typeName,
o.`ip` ,o.`lat` ,o.`lng`
,  o.`address`  address
,  o.`province`   province
, o.`city`   city
, o.`district`   district
,  o.`consignee_mobile`   consigneeMobile
, o.`consignee`  consignee,o.`gmt_deliver` ,
'' area,
'' phone,

''  quantity,
'' gasPhone,
'' oilRechargeNum,
(SELECT br.`calculate_method`  FROM `af_borrow` br WHERE br.`order_id` = o.`id`   LIMIT 1 ) calculateMethod,
(SELECT br.`free_nper`   FROM `af_borrow` br WHERE br.`order_id` = o.`id`    LIMIT 1) freeNper,
(SELECT br.`nper_amount`   FROM `af_borrow` br WHERE br.`order_id` = o.`id`    LIMIT 1) nperAmount,
(SELECT br.`card_number`   FROM `af_borrow` br WHERE br.`order_id` = o.`id`    LIMIT 1) cardNumber,
(SELECT br.`card_name`   FROM `af_borrow` br WHERE br.`order_id` = o.`id`    LIMIT 1) cardName,
if(o.`consignee_mobile`=NULL OR o.`consignee_mobile`='',0,(SELECT COUNT(distinct(uu.`user_id`))   FROM `af_order`   uu WHERE uu.`consignee_mobile` = o.`consignee_mobile` and uu.`is_delete` =0 )) phoneCorrespondingPersion

,'' unpayedCanUseRatio
,'' userThisOrderSum
,'' userTemporaryLimitRatio
,'0' oilRechargeNum
,(SELECT af_user.user_name from af_user where af_user.id=o.user_id) thisOrderUnanimous
,o.gps_address gpsUnanimous
FROM `af_order` o  WHERE o.`id`  =#{id}
	</select>
	<select id="getBolumeSumDataById" resultType="java.util.HashMap">
		SELECT wm.`restaurant_name` shopName,wm.`contact_addr` address, wm.`contact_mobile` consigneeMobile,wm.`contact_name` consignee ,wm.`quantity`   quantity,
(SELECT sh.`area`  FROM `af_boluome_shouji` sh WHERE sh.`third_order_no` = oo.`third_order_no`   LIMIT 1) area,
(SELECT sh.`phone`   FROM `af_boluome_shouji` sh WHERE sh.`third_order_no` =oo.`third_order_no`  LIMIT 1) phone,
(SELECT jy.`phone`  FROM `af_boluome_jiayouka` jy WHERE jy.`third_order_no` = oo.`third_order_no`   LIMIT 1) gasPhone,
(SELECT (SELECT count(DISTINCT(jy1.user_id))  FROM `af_boluome_jiayouka` jy1 WHERE jy1.card_id = jy.card_id)  FROM `af_boluome_jiayouka` jy WHERE jy.`third_order_no` = oo.`third_order_no`  LIMIT 1) oilRechargeNum,
(SELECT fo.`type`  FROM `af_trade_order` tr LEFT JOIN `af_trade_business_info` fo on tr.`business_id`   = fo.`business_id` WHERE  tr.`order_id` = #{id}   LIMIT 1 ) typeName
FROM `af_order` oo LEFT JOIN `af_boluome_waimai` wm on wm.`third_order_no` =oo.`third_order_no`  WHERE oo.`id` =#{id}  LIMIT 1
	</select>

	<select id="countNperRepaymentByBorrowId" resultType="java.lang.Integer">
		SELECT
			COUNT(1)
		FROM
			af_borrow_bill
		WHERE
			borrow_id = #{id}
		AND is_delete = 0
		AND `status` = 'Y'
	</select>
	<select id="getUserSummaryForCapital" resultType="java.util.HashMap">
		SELECT IF(sum(renewal_num)>0,'false','true') first,IF(sum(renewal_num)>0,IFNULL(sum(overdue_day ),0),max(overdue_day)) allDays,IFNULL(SUM(IF(renewal_num>0,overdue_day,0)),0) allDays1 FROM af_borrow_cash
		WHERE user_id =#{userId} AND `status`='FINSH'
	</select>
	
	<select id="getBorrowInfoById" parameterType="java.lang.Long" resultType="com.ald.fanbei.api.dal.domain.dto.AfBorrowDto">
	  select `ab`.`id` AS `borrow_id`,
	        min(`abb`.`id`) AS `min_borrow_bill_id`,
	       `abb`.`gmt_create` AS `gmt_create`,
	       `au`.`id` AS `user_id`,
		   `ab`.`borrow_no` AS `borrow_no`,
	       `au`.`real_name` AS `real_name`,
	       `aua`.`id_number` AS `id_number`,
	       `au`.`user_name` AS `user_name`,
	       `ab`.`amount` AS `amount`,
	       `ab`.`nper_amount` AS `nper_amount`,
	       `abb`.`nper` AS `nper`
	   from `af_borrow` `ab`
	   left join `af_order` `ao` on `ab`.`order_id`= `ao`.`id`
	   left join `af_borrow_bill` `abb` on`abb`.`borrow_id`= `ab`.`id`
	   left join `af_user` `au` on`ab`.`user_id`= `au`.`id`
	   left join `af_user_account` `aua` on`au`.`id`= `aua`.`user_id`
	   where ab.id=#{borrowId}
	</select>
	
	<select id="getOverdueBorrowInfoByUserId" resultType="AfBorrowDo">
		SELECT 
			<include refid="queryFields"/>
		FROM af_borrow 
		WHERE is_delete = 0
		AND user_id = #{userId}
		AND overdue_num <![CDATA[ > ]]> 0 
		order by id desc 
		limit 1
    </select>
	
</mapper>
