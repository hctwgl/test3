<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ald.fanbei.api.dal.dao.AfUserAccountLogDao">
	<sql id="queryAllFields">
		id,gmt_create,user_id,type,amount,ref_id
	</sql>

	<insert id="addUserAccountLog" parameterType="AfUserAccountLogDo" useGeneratedKeys="true" keyProperty="rid">
		INSERT INTO af_user_account_log(gmt_create , user_id , type , amount , ref_id)
		VALUES (
    		NOW(),
    		#{userId},
    		#{type},
    		#{amount},
    		#{refId}
		)
	</insert>

	<select id="getLimitDetailList" resultType="AfLimitDetailDto">
		SELECT 
		  l.id limit_id,
		  l.type,
		  l.gmt_create,
		  b.name borrow_name,
		  b.amount borrow_amount,
		  b.borrow_no,
		  r.name repayment_name,
		  r.repayment_amount,
		  r.repay_no repayment_no,
		  l.ref_id
		FROM
		  af_user_account_log l 
		  LEFT JOIN af_borrow b 
		    ON l.type IN ('CASH', 'CONSUME','AP_REFUND') 
		    AND b.is_delete = 0 
		    AND l.`ref_id` = b.id 
		  LEFT JOIN af_repayment r 
		    ON l.type = 'REPAYMENT' 
		    AND r.is_delete = 0 
		    AND l.`ref_id` = r.id 
		WHERE l.user_id = #{userId}
		  AND b.`user_id` = #{userId}
		  AND l.is_delete = 0 
		  AND l.type IN ('CASH', 'CONSUME', 'REPAYMENT','AP_REFUND') 
		ORDER BY l.gmt_create DESC 
	</select>
	
	<select id="getUserAmountByType" resultType="java.math.BigDecimal" parameterType="AfUserAccountLogDo">
		SELECT 
		 	 sum(al.amount)
		FROM
		  af_user_account_log al
		WHERE 
			al.user_id = #{userId}
		AND 
		  	al.is_delete = 0 
		AND 
			al.type=#{type} 
	</select>
	<select id="getByRefAndType" resultType="com.ald.fanbei.api.dal.domain.AfUserAccountLogDo" >
		SELECT
		al.id
		FROM af_user_account_log as al
		 where  al.ref_id=  #{rid} and al.type= #{type}
		limit 0,1
	</select>
</mapper>
