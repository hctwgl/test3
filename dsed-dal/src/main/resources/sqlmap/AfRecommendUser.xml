<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ald.fanbei.api.dal.dao.AfRecommendUserDao">

	<sql id="queryFields">
				id,
				user_id,
				parentId,
				is_delete,
				origin,
				is_loan,
				loan_time,
				gmt_create,
				prize_money,
				loan_user_count,
				recommend_count,
				gmt_modified,
				type,
				is_selfsupport_rebate,
				first_selfsupport_order,
				first_boluome_order,
				source
				
	</sql>


	<insert id="addRecommendUser" parameterType="AfRecommendUserDo" keyProperty="id" useGeneratedKeys="true" >
		INSERT INTO
			af_recommend_user
			(
				user_id,
				parentId,
				is_delete,
				origin,
				is_loan,
				loan_time,
				gmt_create,
				prize_money,
				loan_user_count,
				recommend_count,
				gmt_modified,
				source
			)
		VALUES
		    (
				#{userId},
				#{parentId},
				#{isDelete},
				#{origin},
				#{isLoan},
				NOW(),
				NOW(),
				#{prizeMoney},
				#{loanUserCount},
				#{recommendCount},
				NOW(),
				#{source}
			)
	</insert>
	
	<select id="getARecommendUserById" resultType="AfRecommendUserDo">
		select
			<include refid="queryFields" />
		from af_recommend_user where is_delete =0 and user_id = #{user_id}
	</select>

	<select id="getARecommendUserByIdAndType" resultType="AfRecommendUserDto">
		SELECT
		ru.id,ru.user_id,ru.is_loan,ru.loan_time,ru.origin,ru.parentId,ru.type,ru.recommend_count,ru.gmt_create,ru.is_selfsupport_rebate,au.risk_status
		FROM af_recommend_user  ru
		INNER JOIN af_user_auth au ON  au.user_id = ru.user_id	
		WHERE ru.user_id = #{user_id} AND ru.type = #{type}
	</select>

	<update id="updateLoanById" parameterType="AfRecommendUserDo">
		UPDATE af_recommend_user
		set
		prize_money = prize_money + #{prizeMoney}
		<if test="loanTime != null">
			,is_loan = 1
			,loan_user_count =1
			,loan_time = #{loanTime}
		</if>
		where id = #{id}
	</update>


	<select id="getRecommedData" resultType="HashMap">
		select sum(prize_money) sum_prize_money,sum(loan_user_count) sum_loan_user_count,sum(recommend_count) sum_recommend_count from af_recommend_user where parentId = #{userId}
	</select>

	<select id="getRecommendListByUserId" resultType="HashMap">
		select
		a.id,a.user_id,a.parentId,a.is_delete,a.origin,a.is_loan,a.loan_time,a.gmt_create,a.prize_money,
        a.loan_user_count,a.recommend_count,a.gmt_modified,b.user_name
		from af_recommend_user a  left join af_user b on a.user_id = b.id
		where parentId = #{userId} and origin = 0 ORDER BY gmt_create desc limit #{pageIndex},#{pageSize}
	</select>

	<select id="getRecommendListSort" resultType="HashMap">
		select b.user_name, user_id,SUM(a.prize_money) sum_money from af_recommend_user a left join af_user b on a.parentId = b.id
		where a.loan_time &gt;= #{startTime} and a.loan_time &lt;= #{endTime}
		GROUP BY a.parentId ORDER BY SUM(a.prize_money) desc LIMIT 20;
	</select>

	<select id="getPrizeUser" resultType="HashMap">
		select a.*,b.user_name,c.`name` from af_recommend_prize_user a
						left join af_user b on a.user_id = b.id
						left join af_resource c on a.prize_id = c.id
						where date_month = #{datamonth} and a.is_delete = 0 limit 0,10
	</select>


	<insert id="addRecommendShared" parameterType="AfRecommendShareDo">
		INSERT INTO af_recommend_shared (
			id,
			gmt_create,
			user_id,
			recommend_code,
			type,
			source,
			sourceType,
			shareUrl
		)
		VALUES (
			#{id},
			NOW(),
			#{user_id},
			#{recommend_code},
			#{type},
			#{source},
			#{sourceType},
			#{shareUrl}
		)
	</insert>

	<select id="getRecommendSharedById" resultType="HashMap">
		SELECT  a.*,b.user_name from af_recommend_shared a left join af_user b  on a.user_id = b.id where a.id = #{id}
	</select>

	<select id="getSumPrizeMoney" resultType="double">
		select IFNULL(sum(money),0) from af_recommend_money where parent_id = #{userId}
		<if test="activityTime != null">
		    and gmt_create <![CDATA[>=]]> #{activityTime}
		  </if>
	</select>

	<select id="firstRewardQuery" resultType="AfRecommendUserDto">
	    select a.user_id userId,a.parentId parentId,IFNULL(sum(b.money),0.00) prizeMoney from  af_recommend_user a left join af_recommend_money b on a.user_id=b.user_id
        where a.is_delete=0 and a.parentId = #{userId} and a.type =1 and (b.parent_id =#{userId} or b.parent_id is null)
        <if test="activityTime != null">
		    and a.gmt_create <![CDATA[>=]]> #{activityTime}
		  </if>
       
        GROUP BY a.user_id
        limit #{pageNo},#{pageSize}
	</select>
	<select id="twoLevelRewardQuery" resultType="AfRecommendUserDto">
	   select a.user_id userId,a.parentId parentId,IFNULL(sum(b.money),0.00) prizeMoney from  af_recommend_user a left join af_recommend_money b on a.user_id=b.user_id
	   where  b.parent_id = #{userId} and a.parentId in (SELECT user_id from af_recommend_user where is_delete=0 and parentId =#{userId} and type =1)
         <if test="activityTime != null">
		    and a.gmt_create <![CDATA[>=]]> #{activityTime}
		  </if>
        GROUP BY a.user_id
       limit #{pageNo},#{pageSize}
	</select>

	<select id="firstRewardQueryCount" resultType="int">
        select count(1) from  af_recommend_user a left join af_recommend_money b on a.user_id=b.user_id
        where a.is_delete=0 and a.parentId = #{userId} and a.type =1 and (b.parent_id =#{userId} or b.parent_id is null)
	</select>
	<select id="twoLevelRewardQueryCount" resultType="int">
	   select count(1) from  af_recommend_user a left join af_recommend_money b on a.user_id=b.user_id
	   where b.parent_id = #{userId} and a.parentId in (SELECT user_id from af_recommend_user where is_delete=0 and parentId =#{userId} and type =1)
	</select>

	<insert id="addRecommendMoney" parameterType="AfRecommendMoneyDo" useGeneratedKeys="true" keyProperty="rid">
		INSERT INTO af_recommend_money(user_id , parent_id , gmt_create , type , money)
		VALUES (
		#{userId},
		#{parentId},
		NOW(),
		#{type},
		#{money}
		)
	</insert>

	<insert id="insertShareWithData">
		INSERT INTO af_recommend_shared(id,gmt_create,user_id,type,recommend_code)
		VALUES(#{uuid},NOW(),#{userId},#{type},#{invitationCode})
	</insert>
	
	<select id="getListByParentIdAndType" parameterType="AfRecommendUserDo" resultType="AfRecommendUserDo">
	   	SELECT
		        a.id,a.user_id,a.parentId,a.is_delete,a.origin,a.is_loan,a.loan_time,a.gmt_create,a.prize_money,
                a.loan_user_count,a.recommend_count,a.gmt_modified,b.user_name
		FROM af_recommend_user a  
		LEFT JOIN af_user b 
		ON a.user_id = b.id
		WHERE a.parentId = #{parentId}
		and type = #{type}
		and a.is_delete = 0
		<if test="gmtCreate != null">
		and a.gmt_create <![CDATA[ >= ]]> #{gmtCreate}
		</if>
		ORDER BY a.gmt_create DESC
	  
	</select>
	
	<select id="findRefUserId" parameterType="AfRecommendUserDo" resultType="java.lang.Long">
	    select  parentId
	   from af_recommend_user
	   where is_delete =0 
	   and user_id = #{userId}
	   and type =#{type}
	   <if test="gmtCreate != null">
		  and gmt_create <![CDATA[ >= ]]> #{gmtCreate}
		</if>
	</select>
	
	
	<select id="getSumSubmitRealname" parameterType="java.lang.Long" resultType="java.lang.Integer">
	 SELECT COUNT(0)
	    FROM af_recommend_user ru
		  LEFT JOIN 
		  af_user_auth au
		  ON au.user_id = ru.user_id 
		  WHERE 
		  TO_DAYS(au.gmt_realname) = TO_DAYS(NOW())
		  AND au.realname_status = 'Y'
		  AND au.is_delete = 0
		  AND ru.is_delete = 0
		  AND ru.parentId = #{pid}
	</select>
	
	<update id="updateRecommendUserById" parameterType="AfRecommendUserDo">
		UPDATE af_recommend_user
		set
		<if test="firstBoluomeOrder != null">
			first_boluome_order = #{firstBoluomeOrder},
		</if>
		<if test="firstSelfsupportOrder != null">
			first_selfsupport_order = #{firstSelfsupportOrder},
		</if>
		<if test="isSelfsupportRebate != null">
			is_selfsupport_rebate = #{isSelfsupportRebate},
		</if>
		       gmt_modified = now()
		where id = #{id}
	</update>

	<select id="getTodayShareTimes" parameterType="java.lang.Long" resultType="java.lang.Integer">
		select  count(1)
		from af_recommend_shared
		where user_id = #{userId}
		and to_days(gmt_create) = to_days(now())
	</select>
	
</mapper>