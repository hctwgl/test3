<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ald.fanbei.api.dal.dao.AfCouponDao">
	<sql id="queryAllFields">
		id rid,gmt_create,gmt_modified,gmt_start,gmt_end,name,status,limit_amount,amount,use_rule,valid_days,type,limit_count,expiry_type,quota_already,quota,use_range,is_global,activity_id,activity_type,goods_ids
	</sql>
	
	<sql id="queryPickAllFields">
		c.id
		rid,c.gmt_create,c.gmt_modified,c.gmt_start,c.gmt_end,c.name,c.status,c.limit_amount,c.amount,
		c.use_rule,c.valid_days,c.type,c.limit_count,c.expiry_type,c.quota_already,c.quota
		,COUNT(uc.id) user_already
	</sql>

	<!-- 余额兑换成券 -->
	<insert id="addCoupon" parameterType="AfCouponDo" keyProperty="rid" useGeneratedKeys="true">
		INSERT INTO af_coupon
		(
		creator ,
		modifier ,
		name ,
		type ,
		limit_amount ,
		amount ,
		use_rule ,
		gmt_end ,
		gmt_start ,
		quota ,
		limit_count,
		use_range,
		activity_id,
		activity_type
		<if test="isGlobal != null and isGlobal != ''">
			,is_global
		</if>
		<if test="shopUrl != null and shopUrl != ''">
			,shop_url
		</if>
		)
		VALUES (
		#{creator},
		#{modifier},
		#{name},
		#{type},
		#{limitAmount},
		#{amount},
		#{useRule},
		#{gmtEnd},
		#{gmtStart},
		#{quota},
		#{limitCount},
		#{useRange},
		#{activityId},
		#{activityType}
		<if test="isGlobal != null and isGlobal != ''">
			,#{isGlobal}
		</if>
		<if test="shopUrl != null and shopUrl != ''">
			,#{shopUrl}
		</if>
		)
	</insert>
	
	<select id="selectCouponByCouponIds" resultType="AfCouponDto">
		SELECT
			<include refid="queryPickAllFields" />
		FROM
			af_coupon c
		LEFT JOIN 
			af_user_coupon uc ON c.id =uc.coupon_id   AND uc.user_id =#{userId}
		WHERE
			c.is_delete = 0
		AND
			c.status ='O'

		AND
			c.id in (${ids})
		AND
			( ( c.expiry_type='R'and c.gmt_end >NOW())
			OR
			c.expiry_type='D')
		GROUP BY c.id
		ORDER BY
			(c.quota - c.quota_already) DESC,
			c.gmt_modified DESC 
	</select>
	
	
	
	<select id="getCouponById" resultType="AfCouponDo">
	    SELECT
	    	<include refid="queryAllFields" />
	    FROM
	   		 af_coupon
	    WHERE
	    	is_delete = 0
	    AND
	    
			id = #{couponId}
		AND
			status ='O'
	</select>
	
	<select id="getCouponInfoById" resultType="AfCouponDo">
	    SELECT
	    	<include refid="queryAllFields" />
	    FROM
	   		 af_coupon
	    WHERE
	    	is_delete = 0
	    AND
			id = #{couponId}
	</select>
	
	<update id="updateCouponquotaAlreadyById" parameterType="AfCouponDo">
		UPDATE
			af_coupon
		SET
			gmt_modified = NOW()
		<if test="quotaAlready != null">
    	  ,quota_already=quota_already + #{quotaAlready}
	   </if>
		WHERE
			is_delete = 0
		AND
			id = #{rid}
	</update>
	
	<update id="updateCouponNotGlobalById" parameterType="java.lang.String">
		UPDATE
			af_coupon
		SET
			gmt_modified = NOW(),
			is_global = 1
		WHERE
			is_delete = 0
		AND
			id = #{couponId}
	</update>
	<update id="updateCouponquotaAndCouponquotaAlreadyById" parameterType="AfCouponDo">
		UPDATE
			af_coupon
		SET
			gmt_modified = NOW()
			<if test="quota != null">
    	  ,quota=quota-#{quota}
	   </if>
		<if test="quotaAlready != null">
    	  ,quota_already=quota_already + #{quotaAlready}
	   </if>
		WHERE
			is_delete = 0
		And
			quota >=1
		AND
			id = #{rid}
	</update>
	<select id="getCouponNames" resultType="String">
		SELECT
	   		name
	    FROM
	   		 af_coupon
	    WHERE
	    	is_delete = 0
		AND `status` ='O'
		AND id in 
    		<foreach collection="ids" item="id" open="(" close=")"
    			separator=",">
    				#{id}
    		</foreach>
	</select>

	<select id="getCouponByActivityIdAndType" resultType="AfCouponDto">
		SELECT
		<include refid="queryAllFields"></include>
		FROM af_coupon
		WHERE is_delete=0
		AND activity_id = #{activityId}
		AND activity_type = #{activityType}
		AND type = 'FULLVOUCHER'
		AND now() >= gmt_start
		AND gmt_end >= now()
		AND status = 'O'
	</select>
	
		<select id="listCouponByIds" resultType="AfCouponDo">
		SELECT
	    	<include refid="queryAllFields" />
	    FROM
	   		 af_coupon
	    WHERE
	    	is_delete = 0
		AND 
			id IN
		<foreach collection="items"  separator="," item="item" index="index" open="(" close=")">
			#{item}
		</foreach>
	</select>
	
	<select id="getByActivityType" resultType="AfCouponDto">
		SELECT
		<include refid="queryAllFields"></include>
		FROM
			af_coupon
		WHERE
			activity_type = #{activityType}
		AND
			type = 'FULLVOUCHER'
		AND
			now() >= gmt_start
		AND
			gmt_end >= now()
		AND
			status = 'O'
	</select>


	<select id="getCouponByName" resultType="AfCouponDo">
		SELECT
		<include refid="queryAllFields" />
		FROM
		af_coupon
		WHERE
		is_delete = 0
		AND
		name = #{name}
	</select>

	<select id="getCouponByIds" resultType="AfCouponDo">
		SELECT
		<include refid="queryAllFields" />
		FROM
		af_coupon
		WHERE
		is_delete = 0
		AND
		id in (
		<foreach collection="ids" item="item" index="index" separator="," >
			#{item}
		</foreach>
		)
	</select>
</mapper>
