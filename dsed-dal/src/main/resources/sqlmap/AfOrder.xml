<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ald.fanbei.api.dal.dao.AfOrderDao">
	<sql id="queryFields">
		id rid,gmt_create,gmt_modified,user_id,order_no,third_order_no,third_detail_url,
		status,user_coupon_id,order_type,sec_type,goods_id,open_id,num_id,goods_name,goods_icon,count,
		price_amount,sale_amount,actual_amount,shop_name,pay_status,pay_type,pay_trade_no,gmt_pay,trade_no,
		gmt_rebated,mobile,gmt_finished,rebate_amount,commission_amount,bank_id,gmt_pay_end,service_provider,nper,risk_order_no,
		borrow_rate,coupon_amount,interest_free_json,consignee,address,consignee_mobile,invoice_header,logistics_info,pre_status,
		goods_price_id,goods_price_name,logistics_company,logistics_no,gmt_deliver,gmt_closed,cancel_reason,cancel_detail,closed_reason,closed_detail,status_remark,bank_amount,borrow_amount,province,city,district,black_box,
		lat,lng,support_credit_status,weak_risk_order_no,rela_order_no
	</sql>
	<sql id="queryAllFields">
		id rid,gmt_create,gmt_modified,user_id,order_no,third_order_no,third_detail_url,
		status,user_coupon_id,order_type,sec_type,goods_id,open_id,num_id,goods_name,goods_icon,count,
		price_amount,sale_amount,actual_amount,shop_name,pay_status,pay_type,pay_trade_no,gmt_pay,trade_no,
		gmt_rebated,mobile,gmt_finished,rebate_amount,commission_amount,bank_id,gmt_pay_end,service_provider,nper,risk_order_no,
		borrow_rate,coupon_amount,interest_free_json,consignee,address,consignee_mobile,invoice_header,logistics_info,pre_status,
		goods_price_id,goods_price_name,logistics_company,logistics_no,gmt_deliver,gmt_closed,cancel_reason,cancel_detail,closed_reason,
		closed_detail,status_remark,bank_amount,borrow_amount,province,city,district,black_box,bqs_black_box,iagent_status,
		support_credit_status,weak_risk_order_no,rela_order_no
	</sql>
	<insert id="createOrder" keyProperty="rid" useGeneratedKeys="true"  parameterType="AfOrderDo">
		INSERT INTO af_order(
			<if test="userId != null">
		    	user_id , 
			</if>
			order_no , 
			<if test="userCouponId != null">
		    	user_coupon_id, 
			</if>
			<if test="couponAmount != null">
				coupon_amount,
			</if>
			<if test="payTradeNo != null">
		    	pay_trade_no, 
			</if>
			order_type ,
			<if test="goodsId != null">
				goods_id ,
			</if>
			<if test="openId != null">
				open_id ,
			</if>
		    <if test="numId != null" >
				num_id,
			</if>
			<if test="goodsName != null">
				goods_name ,
			</if>
			<if test="goodsIcon != null">
				goods_icon ,
			</if>
			<if test="count != null">
				count ,
			</if>
			<if test="priceAmount != null">
				price_amount ,
			</if>
			<if test="saleAmount != null">
				sale_amount ,
			</if>
			<if test="actualAmount != null">
				actual_amount ,
			</if>
			<if test="shopName != null">
				shop_name ,
			</if>
			<if test="rebateAmount != null">
				rebate_amount ,
			</if>
			<if test="commissionAmount != null" >
				commission_amount,
			</if>
			<if test="nper != null" >
				nper,
			</if>
			<if test="mobile != null">
				mobile,
			</if>
			<if test="bankId != null">
				bank_id,
			</if>
			<if test="gmtPayEnd != null" >
				gmt_pay_end,
			</if>
			<if test="secType != null" >
				sec_type,
			</if>
			<if test="thirdOrderNo != null" >
				third_order_no,
			</if>
			<if test="thirdDetailUrl != null" >
				third_detail_url,
			</if>
			<if test="consignee != null" >
				consignee,
			</if>
			<if test="address != null" >
				address,
			</if>
			<if test="consigneeMobile != null" >
				consignee_mobile,
			</if>
			<if test="invoiceHeader != null" >
				invoice_header,
			</if>
			<if test="logisticsInfo != null" >
				logistics_info,
			</if>
			<if test="borrowRate != null" >
				borrow_rate,
			</if>
			<if test="serviceProvider != null">
				service_provider,
			</if>
			<if test="payType != null">
    			pay_type,
			</if>
			<if test="interestFreeJson != null">
				interest_free_json,
			</if>
			<if test="goodsPriceId != null">
	            goods_price_id,
	        </if>
	        <if test="goodsPriceName != null">
	            goods_price_name,
	        </if>
			<if test="auAmount != null">
	            au_amount,
	        </if>
	        <if test="usedAmount != null">
	            used_amount,
	        </if>	        
	        <if test="province != null">
	            province,
	        </if>
	        <if test="city != null">
	            city,
	        </if>
	        <if test="district != null">
	            district,
	        </if>
	        <if test="blackBox != null">
				black_box,
	        </if>
			<if test="bqsBlackBox != null">
				bqs_black_box,
			</if>
	        <if test="ip != null">
	            ip,
	        </if>
	        <if test="lc != null and '' != lc">
	            lc,
	        </if>
	        <if test="supportCreditStatus != null and '' != supportCreditStatus">
	            support_credit_status,
	        </if>
	        <if test="weakRiskOrderNo != null and '' != weakRiskOrderNo">
	            weak_risk_order_no,
	        </if>
	        <if test="relaOrderNo != null and '' != relaOrderNo">
	            rela_order_no,
	        </if>
			gmt_create ,
			gmt_modified
		)
		VALUES (
		    <if test="userId != null">
		    	#{userId},
			</if>
		    #{orderNo},
		    <if test="userCouponId != null">
		    	 #{userCouponId},
			</if>
			<if test="couponAmount != null">
				#{couponAmount},
			</if>
			<if test="payTradeNo != null">
		    	 #{payTradeNo},
			</if>
		    #{orderType},
			<if test="goodsId != null">
				#{goodsId},
			</if>
	    	<if test="openId != null">
				#{openId},
			</if>
	    	<if test="numId != null" >
				#{numId},
			</if>
			<if test="goodsName != null">
				#{goodsName},
			</if>
		    <if test="goodsIcon != null">
				#{goodsIcon},
			</if>
		    <if test="count != null">
				#{count},
			</if>
		    <if test="priceAmount != null">
				#{priceAmount},
			</if>
		    <if test="saleAmount != null">
				#{saleAmount},
			</if>
		    <if test="actualAmount != null">
				#{actualAmount},
			</if>
		    <if test="shopName != null">
				#{shopName},
			</if>
		    <if test="rebateAmount != null">
				#{rebateAmount},
			</if>
		    <if test="commissionAmount != null" >
		    	#{commissionAmount},
		    </if>
		    <if test="nper != null" >
				#{nper},
			</if>
			<if test="mobile != null">
				#{mobile},
			</if>
		    <if test="bankId != null">
				#{bankId},
			</if>
		    <if test="gmtPayEnd != null">
		    	#{gmtPayEnd},
		    </if>
		    <if test="secType != null">
		    	#{secType},
		    </if>
		    <if test="thirdOrderNo != null" >
				#{thirdOrderNo},
			</if>
			<if test="thirdDetailUrl != null" >
				#{thirdDetailUrl},
			</if>
			<if test="consignee != null" >
				#{consignee},
			</if>
			<if test="address != null" >
				#{address},
			</if>
			<if test="consigneeMobile != null" >
				#{consigneeMobile},
			</if>
			<if test="invoiceHeader != null" >
				#{invoiceHeader},
			</if>
			<if test="logisticsInfo != null" >
				#{logisticsInfo},
			</if>
			<if test="borrowRate != null" >
				#{borrowRate},
			</if>
			<if test="serviceProvider != null">
				#{serviceProvider},
			</if>
			<if test="payType != null">
    			#{payType},
			</if>
			<if test="interestFreeJson != null">
				#{interestFreeJson},
			</if>
			<if test="goodsPriceId != null">
	            #{goodsPriceId},
		     </if>
			<if test="goodsPriceName != null">
	            #{goodsPriceName},
	        </if>
			<if test="auAmount != null">
	            #{auAmount},
		     </if>
			<if test="usedAmount != null">
	            #{usedAmount},
	        </if>
			<if test="province != null">
	            #{province},
	        </if>
			<if test="city != null">
	            #{city},
	        </if>
			<if test="district != null">
	            #{district},
	        </if>
			<if test="blackBox != null">
	            #{blackBox},
	        </if>
			<if test="bqsBlackBox != null">
				#{bqsBlackBox},
			</if>
			<if test="ip != null">
	            #{ip},
	        </if>
			<if test="lc != null and '' != lc">
				#{lc},
			</if>
			<if test="supportCreditStatus != null and '' != supportCreditStatus">
	            #{supportCreditStatus},
	        </if>
	        <if test="weakRiskOrderNo != null and '' != weakRiskOrderNo">
	            #{weakRiskOrderNo},
	        </if>
	        <if test="relaOrderNo != null and '' != relaOrderNo">
	            #{relaOrderNo},
	        </if>
			NOW(),
			NOW()
		)
	</insert>
	
	<insert id="createOrderList" parameterType="java.util.List" >
		INSERT INTO af_order(
			gmt_create , 
			gmt_modified , 
			user_id , 
			order_no , 
			third_order_no , 
			third_detail_url , 
			status , 
			user_coupon_id , 
			order_type , 
			sec_type , 
			goods_id , 
		       goods_price_name,
	            goods_price_id,
			open_id , 
			num_id , 
			goods_name , 
			goods_icon , 
			count , 
			price_amount , 
			sale_amount , 
			actual_amount , 
			shop_name , 
			pay_status , 
			pay_type , 
			pay_trade_no , 
			gmt_pay , 
			trade_no , 
			gmt_rebated , 
			mobile , 
			gmt_finished , 
			rebate_amount , 
			commission_amount ,
			bank_id,
            au_amount,
            used_amount,
			gmt_pay_end
			)
		VALUES
		<foreach collection="items" separator="," item="item">
			(
    		NOW(),
    		NOW(),
    		#{item.userId},
    		#{item.orderNo},
    		#{item.thirdOrderNo},
    		#{item.thirdDetailUrl},
    		#{item.status},
    		#{item.userCouponId},
    		#{item.orderType},
    		#{item.secType},
    		#{item.goodsId},
            #{item.goodsPriceName},
            #{item.goodsPriceId},
    		#{item.openId},
    		#{item.numId},
    		#{item.goodsName},
    		#{item.goodsIcon},
    		#{item.count},
    		#{item.priceAmount},
    		#{item.saleAmount},
    		#{item.actualAmount},
    		#{item.shopName},
    		#{item.payStatus},
    		#{item.payType},
    		#{item.payTradeNo},
    		#{item.gmtPay},
    		#{item.tradeNo},
    		#{item.gmtRebated},
    		#{item.mobile},
    		#{item.gmtFinished},
    		#{item.rebateAmount},
    		#{item.commissionAmount},
    		#{item.bankId},
    		<choose>
		        <when test="item.auAmount !=null and item.auAmount != ''">
		            #{item.auAmount},
		        </when>
		        <otherwise>
		            0,
		        </otherwise>
		    </choose>
		    <choose>
		        <when test="item.usedAmount !=null and item.usedAmount != ''">
		            #{item.usedAmount},
		        </when>
		        <otherwise>
		            0,
		        </otherwise>
		    </choose>
    		#{item.gmtPayEnd}
		)
		</foreach>
	</insert>

	<update id="updateOrderByOutTradeNo" parameterType="AfOrderDo">
		update af_order  set gmt_modified=NOW()
		<if test="userId != null">
		    ,user_id=#{userId}
		</if>
		<if test="orderNo != null">
		    ,order_no=#{orderNo}
		</if>
		<if test="status != null">
		    ,status=#{status}
		</if>
		<if test="userCouponId != null">
		    ,user_coupon_id=#{userCouponId}
		</if>
		<if test="orderType != null">
		    ,order_type=#{orderType}
		</if>
		<if test="goodsId != null">
		    ,goods_id=#{goodsId}
		</if>
		<if test="goodsPriceId != null">
            ,goods_price_id=#{goodsPriceId}
        </if>
		<if test="openId != null">
		    ,open_id=#{openId}
		</if>
		<if test="goodsName != null">
		    ,goods_name=#{goodsName}
		</if>
		<if test="goodsPriceName != null">
            ,goods_price_name=#{goodsPriceName}
        </if>
		<if test="goodsIcon != null">
		    ,goods_icon=#{goodsIcon}
		</if>
		<if test="count != null">
		    ,count=#{count}
		</if>
		<if test="priceAmount != null">
		    ,price_amount=#{priceAmount}
		</if>
		<if test="saleAmount != null">
		    ,sale_amount=#{saleAmount}
		</if>
		<if test="actualAmount != null">
		    ,actual_amount=#{actualAmount}
		</if>
		<if test="shopName != null">
		    ,shop_name=#{shopName}
		</if>
		<if test="payStatus != null">
		    ,pay_status=#{payStatus}
		</if>
		<if test="payType != null">
		    ,pay_type=#{payType}
		</if>
		<if test="payTradeNo != null">
		    ,pay_trade_no=#{payTradeNo}
		</if>
		<if test="gmtPay != null">
		    ,gmt_pay=#{gmtPay}
		</if>
		<if test="tradeNo != null">
		    ,trade_no=#{tradeNo}
		</if>
		<if test="rebateAmount != null">
		    ,rebate_amount=#{rebateAmount}
		</if>
		<if test="gmtRebated != null">
		    ,gmt_rebated=#{gmtRebated}
		</if>
		<if test="mobile != null">
		    ,mobile=#{mobile}
		</if>
		<if test="gmtFinished != null">
		    ,gmt_finished=#{gmtFinished}
		</if>
		<if test="commissionAmount != null">
		    ,commission_amount=#{commissionAmount}
		</if>
		<if test="gmtClosed != null">
		    ,gmt_closed=#{gmtClosed}
		</if>
		<if test="preStatus != null">
		    ,pre_status=#{preStatus}
		</if>
		<if test="cancelReason != null">
		    ,cancel_reason=#{cancelReason}
		</if>
		<if test="cancelDetail != null">
		    ,cancel_detail=#{cancelDetail}
		</if>
		<if test="closedReason != null">
		    ,closed_reason=#{closedReason}
		</if>
		<if test="closedDetail != null">
		    ,closed_detail=#{closedDetail}
		</if>
		<if test="statusRemark != null">
		    ,status_remark=#{statusRemark}
		</if>
		<if test="borrowAmount != null">
		    ,borrow_amount=#{borrowAmount}
		</if>
		<if test="bankAmount != null">
		    ,bank_amount=#{bankAmount}
		</if>	
		<if test="lat != null">
		    ,lat=#{lat}
		</if>	
		<if test="lng != null">
		    ,lng=#{lng}
		</if>
		<if test="iagentStatus != null">
			,iagent_status=#{iagentStatus}
		</if>
		<if test="supportCreditStatus != null">
			,support_credit_status=#{supportCreditStatus}
		</if>
		<if test="weakRiskOrderNo != null">
			,weak_risk_order_no=#{weakRiskOrderNo}
		</if>
		<if test="relaOrderNo != null">
            ,rela_order_no=#{relaOrderNo}
        </if>
		where is_delete=0 and pay_trade_no = #{payTradeNo}
	</update>

	<update id="updateOrderByOrderNo" parameterType="AfOrderDo">
		update af_order  set gmt_modified=NOW()
		<if test="userId != null">
		    ,user_id=#{userId}
		</if>
		<if test="orderNo != null">
		    ,order_no=#{orderNo}
		</if>
		<if test="status != null">
		    ,status=#{status}
		</if>
		<if test="userCouponId != null">
		    ,user_coupon_id=#{userCouponId}
		</if>
		<if test="orderType != null">
		    ,order_type=#{orderType}
		</if>
		<if test="goodsId != null">
		    ,goods_id=#{goodsId}
		</if>
		<if test="goodsPriceId != null">
	        ,goods_price_id=#{goodsPriceId}
        </if>
        <if test="goodsPriceName != null">
            ,goods_price_name=#{goodsPriceName}
        </if>
		<if test="openId != null">
		    ,open_id=#{openId}
		</if>
		<if test="goodsName != null">
		    ,goods_name=#{goodsName}
		</if>
		<if test="goodsIcon != null">
		    ,goods_icon=#{goodsIcon}
		</if>
		<if test="count != null">
		    ,count=#{count}
		</if>
		<if test="priceAmount != null">
		    ,price_amount=#{priceAmount}
		</if>
		<if test="saleAmount != null">
		    ,sale_amount=#{saleAmount}
		</if>
		<if test="actualAmount != null">
		    ,actual_amount=#{actualAmount}
		</if>
		<if test="shopName != null">
		    ,shop_name=#{shopName}
		</if>
		<if test="payStatus != null">
		    ,pay_status=#{payStatus}
		</if>
		<if test="payType != null">
		    ,pay_type=#{payType}
		</if>
		<if test="payTradeNo != null">
		    ,pay_trade_no=#{payTradeNo}
		</if>
		<if test="gmtPay != null">
		    ,gmt_pay=#{gmtPay}
		</if>
		<if test="tradeNo != null">
		    ,trade_no=#{tradeNo}
		</if>
		<if test="rebateAmount != null">
		    ,rebate_amount=#{rebateAmount}
		</if>
		<if test="gmtRebated != null">
		    ,gmt_rebated=#{gmtRebated}
		</if>
		<if test="mobile != null">
		    ,mobile=#{mobile}
		</if>
		<if test="gmtFinished != null">
		    ,gmt_finished=#{gmtFinished}
		</if>
		<if test="commissionAmount != null">
		    ,commission_amount=#{commissionAmount}
		</if>
		<if test="gmtClosed != null">
		    ,gmt_closed=#{gmtClosed}
		</if>
		<if test="preStatus != null">
		    ,pre_status=#{preStatus}
		</if>
		<if test="cancelReason != null">
		    ,cancel_reason=#{cancelReason}
		</if>
		<if test="cancelDetail != null">
		    ,cancel_detail=#{cancelDetail}
		</if>
		<if test="closedReason != null">
		    ,closed_reason=#{closedReason}
		</if>
		<if test="closedDetail != null">
		    ,closed_detail=#{closedDetail}
		</if>
		<if test="statusRemark != null">
		    ,status_remark=#{statusRemark}
		</if>
		<if test="borrowAmount != null">
		    ,borrow_amount=#{borrowAmount}
		</if>
		<if test="bankAmount != null">
		    ,bank_amount=#{bankAmount}
		</if>		
		<if test="lat != null">
		    ,lat=#{lat}
		</if>	
		<if test="lng != null">
		    ,lng=#{lng}
		</if>	
		<if test="supportCreditStatus != null">
		    ,support_credit_status=#{supportCreditStatus}
		</if>	
		<if test="weakRiskOrderNo != null">
		    ,weak_risk_order_no=#{weakRiskOrderNo}
		</if>	
		<if test="relaOrderNo != null">
		    ,rela_order_no=#{relaOrderNo}
		</if>
		where is_delete=0 and order_no = #{orderNo} 
	</update>
	
	<select id="getCurrentLastOrderNo" resultType="java.lang.String">
		select order_no from af_order WHERE #{endDate} >= gmt_create AND gmt_create >=#{startDate} AND order_type = #{orderType} ORDER BY id DESC LIMIT 1;
	</select>
	
	<select id="getOrderInfoById" resultType="AfOrderDo">
		SELECT
			o.id rid,o.gmt_create,o.gmt_modified,o.user_id,order_no,third_order_no,third_detail_url,
			o.status,user_coupon_id,order_type,sec_type,goods_id,o.open_id,o.num_id,goods_name,o.goods_icon,o.count,
			o.price_amount,o.sale_amount,o.actual_amount,o.shop_name,pay_status,pay_type,pay_trade_no,gmt_pay,trade_no,
			gmt_rebated,mobile,gmt_finished,o.rebate_amount,o.commission_amount,bank_id,gmt_pay_end,service_provider,nper,risk_order_no,
			borrow_rate,coupon_amount,interest_free_json,consignee,address,consignee_mobile,invoice_header,logistics_info,pre_status,
			goods_price_id,goods_price_name,logistics_company,logistics_no,gmt_deliver,gmt_closed,cancel_reason,cancel_detail,closed_reason,
			closed_detail,status_remark,bank_amount,borrow_amount,province,city,district,black_box,bqs_black_box,iagent_status,
			ifnull(c.fee_amount,0) feeAmount, c.card_type,g.`status` goodsStatus,IFNULL(a.`status`,0) supStatus,o.support_credit_status,o.weak_risk_order_no,o.rela_order_no
		FROM
			af_order o left join af_order_bankcard c on o.id = c.order_id and o.pay_type in ( 'BANK','CP')
			LEFT JOIN af_goods g on o.goods_id = g.id
			LEFT JOIN af_shop_sup_allot a on a.order_id = o.id
		WHERE
			o.is_delete=0 AND o.id = #{rid} AND o.user_id = #{userId}
			order by c.gmt_create desc
			limit 1
	</select>
	
	<select id="getOrderInfoByIdWithoutDeleted" resultType="AfOrderDo">
		SELECT
			o.id rid,o.gmt_create,o.gmt_modified,o.user_id,order_no,third_order_no,third_detail_url,
			status,user_coupon_id,order_type,sec_type,goods_id,open_id,num_id,goods_name,goods_icon,count,
			price_amount,sale_amount,actual_amount,shop_name,pay_status,pay_type,pay_trade_no,gmt_pay,trade_no,
			gmt_rebated,mobile,gmt_finished,rebate_amount,commission_amount,bank_id,gmt_pay_end,service_provider,nper,risk_order_no,
			borrow_rate,coupon_amount,interest_free_json,consignee,address,consignee_mobile,invoice_header,logistics_info,pre_status,
			goods_price_id,goods_price_name,logistics_company,logistics_no,gmt_deliver,gmt_closed,cancel_reason,cancel_detail,closed_reason,
			closed_detail,status_remark,bank_amount,borrow_amount,province,city,district,black_box,bqs_black_box,iagent_status,
			ifnull(c.fee_amount,0) feeAmount, c.card_type,o.support_credit_status,o.weak_risk_order_no,o.rela_order_no
		FROM
			af_order o left join af_order_bankcard c on o.id = c.order_id and o.pay_type in ( 'BANK','CP')
		WHERE
			o.id = #{rid} AND o.user_id = #{userId}
			order by c.gmt_create desc
			limit 1
	</select>
	
	<select id="getOrderInfoByOrderNo" resultType="AfOrderDo">
		SELECT
			<include refid="queryFields"/>
		FROM
			af_order
		WHERE
			is_delete=0 AND order_no = #{orderNo} and order_type !='AGENTBUY'
	</select>
	
	<select id="getOrderInfoByRiskOrderNo" resultType="AfOrderDo">
		SELECT
			<include refid="queryFields"/>
		FROM
			af_order
		WHERE
			is_delete=0 AND risk_order_no = #{riskOrderNo} 
	</select>
	
	<select id="getOrderInfoByPayOrderNo" resultType="AfOrderDo">
		SELECT
			<include refid="queryFields"/>
		FROM
			af_order
		WHERE
			is_delete=0 AND pay_trade_no = #{payTradeNo}
	</select>

	<select id="getNoFinishOrderCount" parameterType="java.lang.Long" resultType="java.lang.Integer">
		SELECT
			count(*)
		FROM
			af_order
		WHERE
			status = 'NEW'
		AND is_delete=0
		AND user_id = #{userId}
	</select>
	<select id="getALLNoFinishOrderCount" resultType="java.lang.Integer">
		SELECT
			count(*)
		FROM
			af_order
		WHERE
			(status = 'NEW'  or `status`= 'PAYFAIL')
		AND is_delete=0
		AND user_id = #{userId}
		<if test="excludeGoodsId != null">
		   and goods_id != #{excludeGoodsId}
		</if>
	</select>
	
	<select id="getThirdOrderInfoByOrderTypeAndOrderNo" flushCache="true" resultType="AfOrderDo">
		SELECT
			<include refid="queryFields"/>
		FROM
			af_order
		WHERE
			is_delete=0 
		AND 
			order_type = #{orderType}
		AND	
			third_order_no = #{thirdOrderNo}
	</select>
	<select id="getThirdOrderInfoBythirdOrderNo" flushCache="true" resultType="AfOrderDo">
		SELECT
			<include refid="queryFields"/>
		FROM
			af_order
		WHERE
			is_delete=0 
		AND 
			third_order_no = #{thirdOrderNo}
	</select>
	
	
	
	<select id="getOrderListByStatus" resultType="AfOrderDo" parameterType="AfOrderQuery">
		SELECT
			o.id rid,o.gmt_create,o.gmt_modified,o.user_id,order_no,third_order_no,third_detail_url,
			status,user_coupon_id,order_type,sec_type,goods_id,open_id,num_id,goods_name,goods_icon,count,
			price_amount,sale_amount,actual_amount,shop_name,pay_status,pay_type,pay_trade_no,gmt_pay,trade_no,logistics_no,
			gmt_rebated,mobile,gmt_finished,rebate_amount,commission_amount,bank_id,gmt_pay_end,service_provider,nper,risk_order_no,
			status_remark,goods_price_name,bank_amount,borrow_amount,
			ifnull(c.fee_amount,0) feeAmount, c.card_type,o.support_credit_status,o.weak_risk_order_no,o.rela_order_no
		FROM
			af_order o left join af_order_bankcard c on o.id = c.order_id and o.pay_type in ( 'BANK','CP')
		WHERE
        is_hide=0 AND o.is_delete=0 AND order_type != 'LEASE' and o.user_id = #{userId}
		<if test="orderStatus == 'WC'" >
			and (o.status = 'NEW' or o.status = 'PAID')
		</if>
		<if test="orderStatus == 'WR'">
			and o.status = 'FINISHED'
		</if>
		<if test="orderStatus == 'AR'">
			and o.status = 'REBATED'
		</if>
		<if test="orderStatus == 'NEW'">
			and o.status in('NEW','PAYFAIL')
		</if>
		<if test="orderStatus == 'DEALING'">
			and o.status = 'DEALING'
		</if>
		<if test="orderStatus == 'TOREVIEW'">
			and o.status = 'PAID' and order_type='AGENTBUY'
		</if>
		<if test="orderStatus == 'REVIEWING'">
			and o.status = 'REVIEW' and order_type='AGENTBUY'
		</if>
		<if test="orderStatus == 'TODELIVER'">
			and (( o.status = 'PAID' and order_type!='AGENTBUY' ) or o.status = 'AGENCYCOMPLETED')
		</if>
		<if test="orderStatus == 'DELIVERED'">
			and o.status = 'DELIVERED'
		</if>
		<if test="orderStatus == 'TOREBATE'">
			and o.status = 'FINISHED' and rebate_amount <![CDATA[ > ]]> 0
		</if>
		<if test="orderStatus == 'FINISHED'">
			and ((o.status = 'FINISHED' and rebate_amount <![CDATA[ = ]]> 0) or o.status = 'REBATED')
		</if>
		<if test="orderStatus == 'CLOSED'">
			and o.status = 'CLOSED'
		</if>
		<if test="orderStatus == 'WAIT_REFUND'">
			and o.status = 'WAIT_REFUND'
		</if>
		<if test="orderStatus == 'DEAL_REFUNDING'">
			and o.status = 'DEAL_REFUNDING'
		</if>
		order by o.gmt_create desc
	</select>
	
	<select id="getOrderCountByStatusAndUserId" resultType="java.lang.Integer" parameterType="AfOrderDo">
		SELECT
			count(0)
		FROM
			af_order
		WHERE
			is_delete=0 and user_id = #{userId} 
		<if test="orderStatus == 'WC'" >
			and (status = 'NEW' or status = 'PAID')
		</if>
		<if test="orderStatus == 'WR'">
			and status = 'FINISHED'
		</if>
		<if test="orderStatus == 'AR'">
			and status = 'REBATED'
		</if>
		<if test="orderStatus == 'NEW'">
			and status in('NEW','PAYFAIL')
		</if>
		<if test="orderStatus == 'DEALING'">
			and status = 'DEALING'
		</if>
		<if test="orderStatus == 'TOREVIEW'">
			and status = 'PAID' and order_type='AGENTBUY'
		</if>
		<if test="orderStatus == 'REVIEWING'">
			and status = 'REVIEW' and order_type='AGENTBUY'
		</if>
		<if test="orderStatus == 'TODELIVER'">
			and (( status = 'PAID' and order_type!='AGENTBUY' ) or status = 'AGENCYCOMPLETED')
		</if>
		<if test="orderStatus == 'DELIVERED'">
			and status = 'DELIVERED'
		</if>
		<if test="orderStatus == 'TOREBATE'">
			and status = 'FINISHED' and rebate_amount <![CDATA[ > ]]> 0
		</if>
		<if test="orderStatus == 'FINISHED'">
			and ((status = 'FINISHED' and rebate_amount <![CDATA[ = ]]> 0) or status = 'REBATED')
		</if>
		<if test="orderStatus == 'CLOSED'">
			and status = 'CLOSED'
		</if>
		<if test="orderStatus == 'WAIT_REFUND'">
			and status = 'WAIT_REFUND'
		</if>
		<if test="orderStatus == 'DEAL_REFUNDING'">
			and status = 'DEAL_REFUNDING'
		</if>
		
	</select>
	
	<update id="updateOrder" parameterType="AfOrderDo" >
		UPDATE 
			af_order 
		SET 
			gmt_modified = NOW()
			<if test="userId != null">
    			,user_id=#{userId}
			</if>
			<if test="orderNo != null">
    			,order_no=#{orderNo}
			</if>
			<if test="thirdOrderNo != null">
    			,third_order_no=#{thirdOrderNo}
			</if>
			<if test="thirdDetailUrl != null">
    			,third_detail_url=#{thirdDetailUrl}
			</if>
			<if test="status != null">
    			,status=#{status}
			</if>
			<if test="userCouponId != null">
    			,user_coupon_id=#{userCouponId}
			</if>
			<if test="orderType != null">
    			,order_type=#{orderType}
			</if>
			<if test="secType != null">
    			,sec_type=#{secType}
			</if>
			<if test="goodsId != null">
    			,goods_id=#{goodsId}
			</if>
			 <if test="goodsPriceId != null">
	            ,goods_price_id=#{goodsPriceId}
	        </if>
			<if test="openId != null">
    			,open_id=#{openId}
			</if>
			<if test="goodsName != null">
    			,goods_name=#{goodsName}
			</if>
			<if test="goodsPriceName != null">
	            ,goods_price_name=#{goodsPriceName}
	        </if>
			<if test="goodsIcon != null">
    			,goods_icon=#{goodsIcon}
			</if>
			<if test="count != null">
    			,count=#{count}
			</if>
			<if test="priceAmount != null">
    			,price_amount=#{priceAmount}
			</if>
			<if test="saleAmount != null">
    			,sale_amount=#{saleAmount}
			</if>
			<if test="actualAmount != null">
    			,actual_amount=#{actualAmount}
			</if>
			<if test="shopName != null">
    			,shop_name=#{shopName}
			</if>
			<if test="payStatus != null">
    			,pay_status=#{payStatus}
			</if>
			<if test="payType != null">
    			,pay_type=#{payType}
			</if>
			<if test="payTradeNo != null">
    			,pay_trade_no=#{payTradeNo}
			</if>
			<if test="gmtPay != null">
    			,gmt_pay=#{gmtPay}
			</if>
			<if test="tradeNo != null">
    			,trade_no=#{tradeNo}
			</if>
			<if test="gmtRebated != null">
    			,gmt_rebated=#{gmtRebated}
			</if>
			<if test="mobile != null">
    			,mobile=#{mobile}
			</if>
			<if test="gmtFinished != null">
    			,gmt_finished=#{gmtFinished}
			</if>
			<if test="rebateAmount != null">
    			,rebate_amount=#{rebateAmount}
			</if>
			<if test="commissionAmount != null">
    			,commission_amount=#{commissionAmount}
			</if>
			<if test="bankId != null">
    			,bank_id=#{bankId}
			</if>
			<if test="gmtPayEnd != null">
    			,gmt_pay_end=#{gmtPayEnd}
			</if>
			<if test="nper != null">
    			,nper=#{nper}
			</if>
			<if test="riskOrderNo != null">
    			,risk_order_no=#{riskOrderNo}
			</if>
			<if test="borrowRate != null">
    			,borrow_rate=#{borrowRate}
			</if>
			<if test="couponAmount != null">
    			,coupon_amount=#{couponAmount}
			</if>
			<if test="interestFreeJson != null">
    			,interest_free_json=#{interestFreeJson}
			</if>
			<if test="gmtClosed != null">
			    ,gmt_closed=#{gmtClosed}
			</if>
			<if test="preStatus != null">
			    ,pre_status=#{preStatus}
			</if>
			<if test="cancelReason != null">
			    ,cancel_reason=#{cancelReason}
			</if>
			<if test="cancelDetail != null">
			    ,cancel_detail=#{cancelDetail}
			</if>
			<if test="closedReason != null">
			    ,closed_reason=#{closedReason}
			</if>
			<if test="closedDetail != null">
			    ,closed_detail=#{closedDetail}
			</if>
			<if test="statusRemark != null">
			    ,status_remark=#{statusRemark}
			</if>
			<if test="borrowAmount != null">
			    ,borrow_amount=#{borrowAmount}
			</if>
			<if test="bankAmount != null">
			    ,bank_amount=#{bankAmount}
			</if>
			<if test="lat != null">
			    ,lat=#{lat}
			</if>	
			<if test="lng != null">
			    ,lng=#{lng}
			</if>
			<if test="gpsAddress != null">
				,gps_address=#{gpsAddress}
			</if>
			<if test="iagentStatus != null">
				,iagent_status=#{iagentStatus}
			</if>
			<if test="supportCreditStatus != null">
				,support_credit_status=#{supportCreditStatus}
			</if>
			<if test="weakRiskOrderNo != null">
				,weak_risk_order_no=#{weakRiskOrderNo}
			</if>
			<if test="relaOrderNo != null">
				,rela_order_no=#{relaOrderNo}
			</if>
		WHERE id = #{rid}
	</update>
	
	<select id="getOrderById" resultType="AfOrderDo">
        SELECT
        o.id rid,o.gmt_create,o.gmt_modified,o.user_id,order_no,third_order_no,third_detail_url,
        status,user_coupon_id,order_type,sec_type,goods_id,open_id,num_id,goods_name,goods_icon,count,
        price_amount,sale_amount,actual_amount,shop_name,pay_status,pay_type,pay_trade_no,gmt_pay,trade_no,
        gmt_rebated,mobile,gmt_finished,rebate_amount,commission_amount,bank_id,gmt_pay_end,service_provider,nper,risk_order_no,
        borrow_rate,coupon_amount,interest_free_json,consignee,address,consignee_mobile,invoice_header,logistics_info,pre_status,
        goods_price_id,goods_price_name,logistics_company,logistics_no,gmt_deliver,gmt_closed,cancel_reason,cancel_detail,closed_reason,
        closed_detail,status_remark,bank_amount,borrow_amount,province,city,district,black_box,bqs_black_box,iagent_status,
        ifnull(c.fee_amount,0) feeAmount, c.card_type,o.support_credit_status,o.weak_risk_order_no,o.rela_order_no
        FROM
        af_order o left join af_order_bankcard c on o.id = c.order_id and o.pay_type in ( 'BANK','CP')
        WHERE
        o.is_delete=0 AND o.id = #{orderId}
        order by c.gmt_create desc
        limit 1
	</select>
	
	<select id="getCurrentLastPayNo" resultType="java.lang.String">
		select pay_trade_no from af_order WHERE #{endDate} >= gmt_pay 
		AND gmt_pay >=#{startDate} 
		and gmt_pay is not null 
		and order_type IN('BOLUOME','AGENTBUY') 
		and status in ('PAID','REVIEW','AGENCYCOMPLETED','DELIVERED','FINISHED','REBATED','WAITING_REFUND','DEAL_REFUNDING') 
		and pay_trade_no !=''
		ORDER BY gmt_pay DESC LIMIT 1;
	</select>
	
	<select id="getNoBorrowOrder" resultType="AfOrderDo">
		select a.id rid,a.user_id,a.order_no,
		a.goods_name,
		a.price_amount,a.sale_amount,a.actual_amount,
		a.shop_name,a.nper
		from af_order a 
		left join af_borrow b on a.id = b.`order_id`  
		where a.order_type = 'BOLUOME' 
		and a.status in ('PAID','FINISHED','REBATED','WAITING_REFUND','DEAL_REFUNDING') 
		and a.pay_type = 'AP' and b.id is null
	</select>
	
	<select id="get20170801ExceptionOrder" resultType="AfOrderDo">
		SELECT 
			ao.id rid,ao.gmt_create,ao.gmt_modified,ao.user_id,ao.order_no,ao.third_order_no,ao.third_detail_url,ao.
		status,ao.user_coupon_id,ao.order_type,ao.sec_type,ao.goods_id,ao.open_id,ao.num_id,ao.goods_name,ao.goods_icon,ao.count,ao.
		price_amount,ao.sale_amount,ao.actual_amount,ao.shop_name,ao.pay_status,ao.pay_type,ao.pay_trade_no,ao.gmt_pay,ao.trade_no,ao.
		gmt_rebated,ao.mobile,ao.gmt_finished,ao.rebate_amount,ao.commission_amount,ao.bank_id,ao.gmt_pay_end,ao.service_provider,ao.nper,ao.risk_order_no,ao.
		borrow_rate,ao.coupon_amount,ao.interest_free_json,ao.consignee,ao.address,ao.consignee_mobile,ao.invoice_header,ao.logistics_info,ao.pre_status,ao.
		goods_price_id,ao.goods_price_name,ao.logistics_company,ao.logistics_no,ao.gmt_deliver,ao.gmt_closed,ao.cancel_reason,ao.cancel_detail,ao.closed_reason,ao.closed_detail,ao.status_remark,ao.bank_amount,ao.borrow_amount			
			 from af_order ao inner join `af_order_push_log` opl on ao.id = opl.`order_id`  where ao.order_type = 'BOLUOME' 
		and ao.status in  ('FINISHED','REBATED') and pay_type = '' and ao.`gmt_create` BETWEEN  '2017-08-01' and '2017-08-02' and opl.`type` = 'PAY_SUC' order by ao.`gmt_create` asc
	</select>
	
	<update id="deleteOrder" parameterType="java.lang.Long" >
		UPDATE af_order SET gmt_modified=NOW(),is_hide = 1 WHERE id=#{rid}
	</update>
	
	<select id = "getDealAmount" resultType="java.lang.Integer" >
		SELECT
			COUNT(*) 
		FROM
			af_order
		WHERE
			pay_type IN ('AP', 'CP')
		AND STATUS IN (
			'AGENCYCOMPLETED',
			'PAID',
			'FINISHED',
			'REBATED',
			'REVIEW',
			'DELIVERED'
		)
		
		and is_delete = 0
		and order_type = #{orderType}
		<![CDATA[
		AND gmt_create >=  DATE_SUB(NOW(),INTERVAL 24 HOUR)
		 ]]>
		
		AND user_id = #{userId};
	</select>
	
	<select id="getNotShopNameByAgentBuyOrder"  resultType="AfOrderDo">
		SELECT 	
				<include refid="queryFields"/>
 	 	FROM `af_order`
 	 	WHERE 
 	 	 	`order_type` ='AGENTBUY' AND shop_name =''  LIMIT #{pageNo}, 50
	</select>
	
	<select id="getStatusByGoodsAndUserId" parameterType="java.lang.Long" resultType="AfOrderDo">
		SELECT 	
				<include refid="queryFields"/>
 	 	FROM `af_order`
 	 	WHERE 
 	 		is_delete = 0
 	 	AND
 	 		status IN ("DEALING","PAID")
  	 	AND
 	 		goods_id=#{goodsId}
 	 	AND
 	 		user_id=#{userId}
	</select>



	<select id="getOrderByTimeAndType" resultType="AfOrderDo">
		SELECT
		<include refid="queryFields"/> FROM af_order WHERE is_delete = 0 AND gmt_create &gt;=#{startTime} and gmt_create &lt;=#{endTime}
	</select>
	
	<select id="getOldUserOrderAmount" resultType="java.lang.Integer">
		SELECT
			COUNT(0)
		FROM af_order 
		WHERE
			user_id=#{userId}
		AND 
			status IN ('DEALING','PAID','REVIEW','AGENCYCOMPLETED','FINISHED','REBATED','DELIVERED','WAIT_REFUND','DEAL_REFUNDING') 
		AND 
			order_type IN ('TAOBAO','TMALL','AGENTBUY','SELFSUPPORT','SELFBUILD')
	
	</select>
	
	
	<select id="getOverOrderByGoodsIdAndUserId" parameterType="java.lang.Long" resultType="AfOrderDo">
		SELECT
		<include refid="queryFields"/>
		FROM af_order
		WHERE
			goods_id=#{goodsId}
		AND
			user_id=#{userId}
		AND status IN ('DEALING','PAID','REVIEW','AGENCYCOMPLETED','FINISHED','REBATED','DELIVERED','WAIT_REFUND','DEAL_REFUNDING')
	</select>
	<select id="findFirstOrder" parameterType="java.lang.Long" resultType = "java.lang.Integer">
		SELECT
		      COUNT(1)
		    FROM
		    (
		            SELECT o.user_id,o.id,o.order_type,o.is_delete,o.status,
		             CASE   o.sec_type 
		       WHEN  'SUPGAME'  THEN   gg.type
		       ELSE   o.sec_type END 
		       sec_type  
		       FROM af_order  o
		       LEFT JOIN af_sup_game gg ON  gg.id = o.goods_id 
		        INNER JOIN af_boluome_rebate br ON br.order_id = o.id
		        <if test="activityTime != null">
				   and br.gmt_create <![CDATA[>=]]>  #{activityTime}
				</if>
		        WHERE o.`user_id` = #{userId}
		        AND o.`status` IN ('FINISHED','REBATED')
		    )ao
		    INNER JOIN (
		      SELECT
		        o.order_type,      
		       CASE   o.sec_type 
		       WHEN 'SUPGAME'  THEN   g.type
		       ELSE  o.sec_type END 
		       sec_type        
		      FROM
		        af_order o
		        LEFT JOIN af_sup_game g ON  g.id = o.goods_id
		      WHERE
		        o.id = #{orderId}
		    ) t ON t.order_type = ao.order_type
		    AND t.sec_type = ao.sec_type;
	</select>
	
	<select id="getCountFinishBoluomeOrderByUserId" parameterType="java.lang.Long" resultType = "java.lang.Integer">
		SELECT
			count(1)
		FROM
			af_order 
			where order_type = 'BOLUOME'
			AND user_id = #{userId} 
			AND is_delete = 0
			 AND status in ('FINISHED','REBATED') 
			<if test="activityTime != null">
		      and gmt_create <![CDATA[<]]> #{activityTime}
		  </if>
	</select>
	<select id="getCountBoluomeOrderByUserIdByActivityTime" parameterType="java.lang.Long" resultType = "java.lang.Integer">
		SELECT
			count(1)
		FROM
			af_order 
			where order_type = 'BOLUOME'
			AND user_id = #{userId} 
			AND is_delete = 0
			<if test="activityTime != null">
		    and gmt_create <![CDATA[<]]> #{activityTime}
		  </if>
	</select>
	
	
	
	<select id="getOverOrderByUserId" parameterType="java.lang.Long" resultType="AfOrderDo">
		SELECT
		<include refid="queryFields"/>
		FROM af_order
		WHERE
			user_id=#{userId}
		AND status IN ('DEALING','PAID','REVIEW','AGENCYCOMPLETED','FINISHED','REBATED','DELIVERED','WAIT_REFUND','DEAL_REFUNDING')
        AND 
			order_type IN ('TAOBAO','TMALL','AGENTBUY','SELFSUPPORT','SELFBUILD')
	
	</select>

	<select id="selectSumCountByGoodsId" resultType="AfOrderDto" parameterType="list" >
		SELECT sum(count) num ,goods_id from af_order where is_delete = 0
		AND goods_id in
		<foreach item="item" collection="list" separator="," open="(" close=")">
			#{item.rid}
		</foreach>
		and CAST(CAST(gmt_create AS DATE)AS DATETIME) = CAST(CAST(SYSDATE()AS DATE)AS DATETIME) GROUP BY goods_id
	</select>

	<select id="selectSumCountByGoodsIdAndType" resultType="java.lang.Integer" parameterType="AfOrderDo">
		SELECT sum(count) from af_order where is_delete = 0 and CAST(CAST(gmt_create AS DATE)AS DATETIME) = CAST(CAST(SYSDATE()AS DATE)AS DATETIME) AND goods_id = #{goodsId} AND user_id = #{userId}
	</select>
	
	<select id="getOrderByOrderNo" resultType="AfOrderDo">
		SELECT
			<include refid="queryAllFields"/>
		FROM
			af_order 
		WHERE
			is_delete=0 
		AND
			order_no=#{orderNo}
	</select>
	
	<select id="getDouble12OrderByGoodsIdAndUserId" parameterType="java.lang.Long" resultType="AfOrderDo">
		SELECT
		o.*
		FROM af_order o
		INNER JOIN af_goods_double_eggs de on de.goods_id = o.goods_id
		INNER JOIN af_activity a on a.id = de.activity_id
		WHERE
			o.is_delete = 0
 	 	AND
			o.goods_id=#{goodsId}
		AND
			o.user_id=#{userId}
		AND de.is_delete = 0
		AND NOW() &gt; de.start_time AND NOW() &lt; de.end_time
		AND a.is_delete = 0
		AND a.`status` = 2
		LIMIT 0,1
	</select>

	<select id="getCountPaidOrderByUserAndOrderType" resultType="HashMap">
		 SELECT 	
		 COUNT(1) 'count' FROM 
		 af_order WHERE 
		 user_id = #{userId}
		 AND order_type = #{orderType}
		 and pay_status in('P','R')
	<!-- 	 AND is_delete = 0 -->
	</select>
	<select id="getSelfsupportOrderByUserIdOrActivityTime" resultType="AfOrderDo">
		 SELECT 	
		<include refid="queryAllFields"/>
		 FROM 
		 af_order WHERE 
		 user_id = #{userId}
		 AND order_type ='SELFSUPPORT'
	<!-- 	 AND is_delete = 0 -->
		 and status = 'REBATED' 
		  <if test="activityTime != null">
		   and gmt_finished &gt; #{activityTime}
		</if>
		 ORDER BY gmt_rebated asc,gmt_finished asc
	</select>
	
	<select id="getAuthShoppingByUserId" resultType="java.lang.Integer">
		 SELECT 	
		 count(1)
		 FROM 
		 af_order WHERE 
		 user_id = #{userId}
		 AND order_type ='SELFSUPPORT'
<!-- 		 AND is_delete = 0 -->
		 and pay_status = 'P' 
		 and pay_type in('AP','CP')
		 <if test="activityTime != null">
		 and gmt_pay &lt; #{activityTime}
		</if>
	</select>
	
	<select id="getCountByUserId" resultType="java.lang.Integer">
		 SELECT 	
		 count(1)
		 FROM 
		 af_order
		 WHERE  user_id = #{userId}
		 AND is_delete = 0
	</select>

	<update id="updateAuAndUsed">
		UPDATE
		af_order
		SET
		au_amount = #{auAmount},
		used_amount = #{usedAmount}
		WHERE
		id = #{orderId}
	</update>

	<update id="updateOrderStatus">
		UPDATE
		af_order
		SET
		status = 'FINISHED'
		WHERE
		id = #{rid}
	</update>

	<insert id="addSceneAmount" parameterType="java.util.List">
		INSERT INTO af_order_scene_amount(order_id , user_id , scene , au_amount , used_amount , gmt_create)
		VALUES
		<foreach collection = "list" separator = "," item = "item" index = "index" >
			(
			#{item.orderId},
			#{item.userId},
			#{item.scene},
			#{item.auAmount},
			#{item.usedAmount},
			NOW()
			)
		</foreach>
	</insert>

	<select id="getSceneAmountByOrderId" parameterType="java.lang.Long" resultType="AfOrderSceneAmountDto">
		SELECT
		*
		FROM af_order_scene_amount
		WHERE
		order_id = #{orderId}
	</select>

	<select id="checkLeaseOrder" resultType="HashMap">
		SELECT b.`status`,b.id FROM af_order_lease a INNER JOIN af_order b ON a.order_id=b.id WHERE a.user_id=#{userId} AND a.lease_status NOT IN ('FINISHED','BUYOUT') AND b.goods_id=#{goodsId} AND b.`status` != 'CLOSED' AND a.is_delete=0
	</select>

	<insert id="addOrderLease" parameterType="AfOrderLeaseDo">
		INSERT INTO af_order_lease(is_delete , gmt_create , gmt_modified , user_id , order_id , monthly_rent, lease_status,rebate_status,user_name,verify_status,buyout,richie_amount,recover_rate,real_name,score,freeze_amount,order_no,quota_deposit,cash_deposit)
		VALUES
			(0,NOW(),NOW(),
			#{userId},
			#{orderId},
			#{monthlyRent},'','N',
			#{userName},
			'A',
			#{buyout},
			#{richieAmount},
			#{recoverRate},
			#{realName},
			#{score},
			#{freezeAmount},
			#{orderNo},
			#{quotaDeposit},
			#{cashDeposit}
			)
	</insert>

	<select id="getOrderLeaseByOrderId" resultType="AfOrderLeaseDo">
		SELECT * FROM af_order_lease WHERE order_id = #{orderId}
	</select>

	<update id="updateOrderLeaseByPay">
		UPDATE
		af_order_lease
		SET
		cash_deposit = #{cashDeposit},
		quota_deposit = #{quotadeposit}
		WHERE
		id = #{id}
	</update>

	<update id="closeOrder">
		UPDATE
		af_order
		SET
		status = 'CLOSED',
		closed_reason = #{closedReason},
		closed_detail = #{closedDetail}
		WHERE
		id = #{id} AND user_id=#{userId}
	</update>

	<update id="rebateOrderLease">
		UPDATE af_order_lease SET rebate_status = 'Y' WHERE order_id=#{orderId}
	</update>

	<select id="getOrderLeaseList" resultType="LeaseOrderListDto">
		SELECT a.gmt_end,a.monthly_rent,a.rebate_status,a.lease_status,b.id,b.status,b.goods_name,b.goods_icon,b.rebate_amount,b.closed_reason,b.gmt_create,b.gmt_pay_end,b.goods_price_name,b.price_amount FROM af_order_lease as a INNER JOIN af_order as b ON a.order_id=b.id
		WHERE a.is_delete=0 AND b.is_delete=0 AND a.is_show=0 AND a.user_id=#{userId}
		ORDER BY a.id DESC
		LIMIT #{pageIndex},#{pageSize}
	</select>

	<select id="getOrderLeasingList" resultType="LeaseOrderListDto">
		SELECT a.gmt_end,a.monthly_rent,a.rebate_status,a.lease_status,b.id,b.status,b.goods_name,b.goods_icon,b.rebate_amount,b.closed_reason,b.gmt_create,b.gmt_pay_end,b.goods_price_name,b.price_amount FROM af_order_lease as a INNER JOIN af_order as b ON a.order_id=b.id
		WHERE a.is_delete=0 AND b.is_delete=0 AND a.lease_status = '' AND  b.status != 'CLOSED' AND a.user_id=#{userId}
		ORDER BY a.id DESC
		LIMIT #{pageIndex},#{pageSize}
	</select>

	<select id="getAllOrderLeaseByOrderId" resultType="LeaseOrderDto">
		SELECT b.*,a.monthly_rent,a.lease_status,a.rebate_status,a.gmt_end,a.policy_number,a.unique,a.cash_deposit,a.gmt_start,a.quota_deposit,a.richie_amount,a.freeze_amount FROM af_order_lease as a INNER JOIN af_order as b ON a.order_id=b.id
		WHERE a.is_delete=0 AND b.is_delete=0 AND a.order_id = #{orderId} AND a.user_id=#{userId}
	</select>

	<update id="UpdateOrderLeaseTime">
		UPDATE af_order_lease SET gmt_start = #{gmtStart},gmt_end=#{gmtEnd} WHERE order_id=#{orderId}
	</update>

    <update id="UpdateOrderLeaseShow">
        UPDATE af_order_lease SET is_show = 1,gmt_modified=NOW() WHERE order_id=#{orderId} AND user_id=#{userId}
    </update>


	<select id="getTradeBusinessNameByOrderId" parameterType="java.lang.Long" resultType="java.lang.String">
			SELECT
			 d.name
			FROM af_order  a INNER JOIN af_trade_order b ON b.order_id = a.id
			INNER JOIN af_trade_business_info c ON c.business_id= b.business_id
			INNER JOIN af_business_type d ON d.id = c.type
			AND a.order_type = 'TRADE' AND d.`code` = 'TRAIN'
			AND d.level  = 2
			AND a.id = #{orderId}
	</select>
	<update id="updateIagentStatusByOrderId">
		UPDATE af_order SET iagent_status=#{iagentStatus,jdbcType=VARCHAR} ,gmt_modified=NOW() WHERE id=#{orderId}
	</update>

	<select id="getLeaseProtocol" resultType="HashMap">
		SELECT
			a.real_name realName,
			a.user_name userName,
			a.monthly_rent monthlyRent,
			a.`unique`,
			a.gmt_start gmtStart,
			a.gmt_end gmtEnd,
			a.gmt_create gmtCreate,
			a.cash_deposit cashDeposit,
			a.quota_deposit quotaDeposit,
			a.freeze_amount freezeAmount,
			b.goods_name goodsName,
			b.goods_price_name goodsPriceName,
			b.order_no orderNo,
			b.price_amount priceAmount,
			b.nper+1 nper,
			b.borrow_rate borrowRate,
			a.richie_amount richieAmount,
			CONCAT(
				b.province,
				b.city,
				b.district,
				b.address
			) address,
			c.id_number idNumber
		FROM
			af_order_lease AS a
		INNER JOIN af_order AS b ON a.order_id = b.id
		INNER JOIN af_user_account c ON a.user_id = c.user_id
		WHERE a.order_id=#{orderId}
	</select>

	<update id="updatepdfUrlByOrderId">
		UPDATE af_order_lease set lease_pdf_url = #{url},gmt_modified = now() where is_delete = 0 and order_id = #{orderId}
	</update>

	<select id="getSelfsupportPaySuccessOrderByUserId" resultType="java.lang.Integer">
		SELECT
		count(0)
		FROM af_order
		WHERE  is_delete=0
		AND order_type = 'SELFSUPPORT'
		AND user_id = #{userId}
		and pay_status in('P','R') 
	</select>

	<select id="selectTodayIagentStatus" resultType="AfOrderDo" >
		SELECT
		<include refid="queryAllFields" />
        FROM af_order
        WHERE user_id=#{userId} and is_delete=0 AND order_type='SELFSUPPORT' AND actual_amount>=#{amount}
        and DATE_FORMAT(gmt_create,'%Y-%m-%d') = DATE_FORMAT(now(),'%Y-%m-%d')
        and iagent_status is not NULL ORDER BY gmt_create ASC LIMIT 1
	</select>
	<select id="selectTodayIagentStatusCOrders" resultType="AfOrderDo" >
		SELECT
		<include refid="queryAllFields" />
		FROM af_order
		WHERE user_id=#{userId} and is_delete=0 AND order_type='SELFSUPPORT' AND status='PAID'
		and DATE_FORMAT(gmt_create,'%Y-%m-%d') = DATE_FORMAT(#{gmtCreate,jdbcType=TIMESTAMP},'%Y-%m-%d')
		and iagent_status ='C'
	</select>

	<select id="getUserFirstBigOrderDate" resultType="java.lang.String" >
		SELECT
		date_format(min(gmt_create),'%Y-%m-%d %H:%i:%s')
		FROM af_order
		WHERE user_id=#{userId} and actual_amount >= #{amount}
	</select>
	
	<select id="countSpecGoodsBuyNums" resultType="java.lang.Integer">
		SELECT
		count(0)
		FROM af_order
		WHERE order_type = 'SELFSUPPORT'
		AND user_id = #{userId}
		AND goods_id = #{goodsId}
		and status !='CLOSED' 
	</select>
	
	<update id="batchUpdateToPayOrderCreditStatus">
		update af_order set gmt_modified=NOW(),support_credit_status = 'Y'
			where is_delete=0 and support_credit_status = 'N' and status in ('NEW','PAYFAIL','DEALING') 
				 and user_id=#{userId}
	</update>
	
	<select id="getPayRelaOrderByGoodsIdAndUserid" resultType="AfOrderDo">
		SELECT
		<include refid="queryAllFields" />
		FROM af_order
		WHERE user_id=#{userId} and is_delete=0 AND order_type='SELFSUPPORT' AND goods_id = #{goodsId} 
		and status in ('NEW','PAYFAIL','DEALING')
		order by id desc limit 1
	</select>

	<select id="getFinishOrderCount" resultType="java.lang.Integer" parameterType="java.lang.Long">
		SELECT count(id) FROM af_order where is_delete = 0 AND order_type = 'SELFSUPPORT' AND status in ('FINISHED','REBATED') AND user_id = #{userId}
	</select>

	<select id="getSignFinishOrderCount" resultType="java.lang.Integer">
		SELECT count(id) FROM af_order where is_delete = 0 AND order_type = 'SELFSUPPORT' AND status in ('FINISHED','REBATED') AND user_id = #{userId} AND gmt_create > #{date}
	</select>

</mapper>
