<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- af_loan表 -->
<mapper namespace="com.ald.fanbei.api.dal.dao.AfLoanDao">
    
    <!--基本的sql查询字段 公共引用...-->
    <sql id="queryFields">
        id rid,user_id,loan_no,trade_no_out,periods,amount,arrival_amount,prd_type,card_no,card_name,overdue_days,overdue_amount,overdue_rate,overdue_status,review_name,review_no,review_details,review_status,risk_no,status,total_service_fee,service_rate,total_interest_fee,interest_rate,risk_daily_rate,au_amount,app_name,remark,loan_remark,repay_remark,gmt_create,gmt_modified,gmt_arrival,gmt_review,gmt_close,gmt_finish,latitude,longitude,province,city,county,address
    </sql>
    
    <!-- 基本的sql查询条件公共引用 -->
    <sql id="commonCondition">
    	WHERE is_delete = 0
        <if test="rid !=null">
            AND id  = #{rid,jdbcType=INTEGER}
        </if>
        <if test="userId != null and userId != ''">
            AND user_id = #{userId,jdbcType=INTEGER}
        </if>
        <if test="loanNo != null and loanNo != ''">
            AND loan_no = #{loanNo,jdbcType=VARCHAR}
        </if>
        <if test="tradeNoOut != null and tradeNoOut != ''">
            AND trade_no_out = #{tradeNoOut,jdbcType=VARCHAR}
        </if>
        <if test="periods != null and periods != ''">
            AND periods = #{periods,jdbcType=INTEGER}
        </if>
        <if test="amount != null and amount != ''">
            AND amount = #{amount,jdbcType=DECIMAL}
        </if>
        <if test="arrivalAmount != null and arrivalAmount != ''">
            AND arrival_amount = #{arrivalAmount,jdbcType=DECIMAL}
        </if>
        <if test="prdType != null and prdType != ''">
            AND prd_type = #{prdType,jdbcType=VARCHAR}
        </if>
        <if test="cardNo != null and cardNo != ''">
            AND card_no = #{cardNo,jdbcType=VARCHAR}
        </if>
        <if test="cardName != null and cardName != ''">
            AND card_name = #{cardName,jdbcType=VARCHAR}
        </if>
        <if test="overdueDays != null and overdueDays != ''">
            AND overdue_days = #{overdueDays,jdbcType=INTEGER}
        </if>
        <if test="overdueAmount != null and overdueAmount != ''">
            AND overdue_amount = #{overdueAmount,jdbcType=DECIMAL}
        </if>
        <if test="overdueRate != null and overdueRate != ''">
            AND overdue_rate = #{overdueRate,jdbcType=DECIMAL}
        </if>
        <if test="overdueStatus != null and overdueStatus != ''">
            AND overdue_status = #{overdueStatus,jdbcType=VARCHAR}
        </if>
        <if test="reviewName != null and reviewName != ''">
            AND review_name = #{reviewName,jdbcType=VARCHAR}
        </if>
        <if test="reviewNo != null and reviewNo != ''">
            AND review_no = #{reviewNo,jdbcType=VARCHAR}
        </if>
        <if test="reviewDetails != null and reviewDetails != ''">
            AND review_details = #{reviewDetails,jdbcType=VARCHAR}
        </if>
        <if test="reviewStatus != null and reviewStatus != ''">
            AND review_status = #{reviewStatus,jdbcType=VARCHAR}
        </if>
        <if test="riskNo != null and riskNo != ''">
            AND risk_no = #{riskNo,jdbcType=VARCHAR}
        </if>
        <if test="status != null and status != ''">
            AND status = #{status,jdbcType=VARCHAR}
        </if>
        <if test="totalServiceFee != null and totalServiceFee != ''">
            AND total_service_fee = #{totalServiceFee,jdbcType=DECIMAL}
        </if>
        <if test="serviceRate != null and serviceRate != ''">
            AND service_rate = #{serviceRate,jdbcType=DECIMAL}
        </if>
        <if test="totalInterestFee != null and totalInterestFee != ''">
            AND total_interest_fee = #{totalInterestFee,jdbcType=DECIMAL}
        </if>
        <if test="interestRate != null and interestRate != ''">
            AND interest_rate = #{interestRate,jdbcType=VARCHAR}
        </if>
        <if test="riskDailyRate != null and riskDailyRate != ''">
            AND risk_daily_rate = #{riskDailyRate,jdbcType=DECIMAL}
        </if>
        <if test="auAmount != null and auAmount != ''">
            AND au_amount = #{auAmount,jdbcType=DECIMAL}
        </if>
        <if test="appName != null and appName != ''">
            AND app_name = #{appName,jdbcType=VARCHAR}
        </if>
        <if test="remark != null and remark != ''">
            AND remark = #{remark,jdbcType=VARCHAR}
        </if>
        <if test="loanRemark != null and loanRemark != ''">
            AND loan_remark = #{loanRemark,jdbcType=VARCHAR}
        </if>
        <if test="repayRemark != null and repayRemark != ''">
            AND repay_remark = #{repayRemark,jdbcType=VARCHAR}
        </if>
        <if test="gmtCreate !=null">
            AND gmt_create = #{gmtCreate,jdbcType=TIMESTAMP}
        </if>
        <if test="gmtModified !=null">
            AND gmt_modified = #{gmtModified,jdbcType=TIMESTAMP}
        </if>
        <if test="gmtArrival !=null">
            AND gmt_arrival = #{gmtArrival,jdbcType=TIMESTAMP}
        </if>
        <if test="gmtReview !=null">
            AND gmt_review = #{gmtReview,jdbcType=TIMESTAMP}
        </if>
        <if test="gmtClose !=null">
            AND gmt_close = #{gmtClose,jdbcType=TIMESTAMP}
        </if>
        <if test="gmtFinish !=null">
            AND gmt_finish = #{gmtFinish,jdbcType=TIMESTAMP}
        </if>
        <if test="latitude != null and latitude != ''">
            AND latitude = #{latitude,jdbcType=DECIMAL}
        </if>
        <if test="longitude != null and longitude != ''">
            AND longitude = #{longitude,jdbcType=DECIMAL}
        </if>
        <if test="province != null and province != ''">
            AND province = #{province,jdbcType=VARCHAR}
        </if>
        <if test="city != null and city != ''">
            AND city = #{city,jdbcType=VARCHAR}
        </if>
        <if test="county != null and county != ''">
            AND county = #{county,jdbcType=VARCHAR}
        </if>
        <if test="address != null and address != ''">
            AND address = #{address,jdbcType=VARCHAR}
        </if>
    </sql>

    
    <insert id="saveRecord" parameterType="com.ald.fanbei.api.dal.domain.AfLoanDo" keyProperty="rid">
    	<selectKey resultType="java.lang.Long" keyProperty="rid" order="AFTER" >
	      SELECT LAST_INSERT_ID()
	    </selectKey>
    
        INSERT INTO af_loan
        <trim prefix="(" suffix=")" suffixOverrides="," >
	        <if test="userId != null">        
	            user_id,
	        </if>
	        <if test="loanNo != null">        
	            loan_no,
	        </if>
	        <if test="tradeNoOut != null">        
	            trade_no_out,
	        </if>
	        <if test="periods != null">        
	            periods,
	        </if>
	        <if test="amount != null">        
	            amount,
	        </if>
	        <if test="arrivalAmount != null">        
	            arrival_amount,
	        </if>
	        <if test="prdType != null">        
	            prd_type,
	        </if>
	        <if test="cardNo != null">        
	            card_no,
	        </if>
	        <if test="cardName != null">        
	            card_name,
	        </if>
	        <if test="overdueDays != null">        
	            overdue_days,
	        </if>
	        <if test="overdueAmount != null">        
	            overdue_amount,
	        </if>
	        <if test="overdueRate != null">        
                overdue_rate,
            </if>
	        <if test="overdueStatus != null">        
	            overdue_status,
	        </if>
	        <if test="reviewName != null">        
	            review_name,
	        </if>
	        <if test="reviewNo != null">        
	            review_no,
	        </if>
	        <if test="reviewDetails != null">        
	            review_details,
	        </if>
	        <if test="reviewStatus != null">        
	            review_status,
	        </if>
	        <if test="riskNo != null">        
	            risk_no,
	        </if>
	        <if test="status != null">        
	            status,
	        </if>
	        <if test="totalServiceFee != null">        
	            total_service_fee,
	        </if>
	        <if test="serviceRate != null">        
	            service_rate,
	        </if>
	        <if test="totalInterestFee != null">        
	            total_interest_fee,
	        </if>
	        <if test="interestRate != null">        
	            interest_rate,
	        </if>
	        <if test="riskDailyRate != null">        
	            risk_daily_rate,
	        </if>
	        <if test="auAmount != null">        
	            au_amount,
	        </if>
	        <if test="appName != null">        
	            app_name,
	        </if>
	        <if test="remark != null">        
	            remark,
	        </if>
	        <if test="loanRemark != null">        
	            loan_remark,
	        </if>
	        <if test="repayRemark != null">        
	            repay_remark,
	        </if>
	        <if test="gmtCreate != null">        
	            gmt_create,
	        </if>
	        <if test="gmtModified != null">        
	            gmt_modified,
	        </if>
	        <if test="gmtArrival != null">        
	            gmt_arrival,
	        </if>
	        <if test="gmtReview != null">        
	            gmt_review,
	        </if>
	        <if test="gmtClose != null">        
	            gmt_close,
	        </if>
	        <if test="gmtFinish != null">        
	            gmt_finish,
	        </if>
	        <if test="ip != null">        
                ip,
            </if>
	        <if test="latitude != null">        
	            latitude,
	        </if>
	        <if test="longitude != null">        
	            longitude,
	        </if>
	        <if test="province != null">        
	            province,
	        </if>
	        <if test="city != null">        
	            city,
	        </if>
	        <if test="county != null">        
	            county,
	        </if>
	        <if test="address != null">        
	            address,
	        </if>
        </trim>
        
        <trim prefix="values (" suffix=")" suffixOverrides="," >
		    <if test="userId != null" >
		       #{userId,jdbcType=INTEGER},
		    </if>
		    <if test="loanNo != null" >
		       #{loanNo,jdbcType=VARCHAR},
		    </if>
		    <if test="tradeNoOut != null" >
		       #{tradeNoOut,jdbcType=VARCHAR},
		    </if>
		    <if test="periods != null" >
		       #{periods,jdbcType=INTEGER},
		    </if>
		    <if test="amount != null" >
		       #{amount,jdbcType=DECIMAL},
		    </if>
		    <if test="arrivalAmount != null" >
		       #{arrivalAmount,jdbcType=DECIMAL},
		    </if>
		    <if test="prdType != null" >
		       #{prdType,jdbcType=VARCHAR},
		    </if>
		    <if test="cardNo != null" >
		       #{cardNo,jdbcType=VARCHAR},
		    </if>
		    <if test="cardName != null" >
		       #{cardName,jdbcType=VARCHAR},
		    </if>
		    <if test="overdueDays != null" >
		       #{overdueDays,jdbcType=INTEGER},
		    </if>
		    <if test="overdueAmount != null" >
		       #{overdueAmount,jdbcType=DECIMAL},
		    </if>
		    <if test="overdueRate != null" >
               #{overdueRate,jdbcType=DECIMAL},
            </if>
		    <if test="overdueStatus != null" >
		       #{overdueStatus,jdbcType=VARCHAR},
		    </if>
		    <if test="reviewName != null" >
		       #{reviewName,jdbcType=VARCHAR},
		    </if>
		    <if test="reviewNo != null" >
		       #{reviewNo,jdbcType=VARCHAR},
		    </if>
		    <if test="reviewDetails != null" >
		       #{reviewDetails,jdbcType=VARCHAR},
		    </if>
		    <if test="reviewStatus != null" >
		       #{reviewStatus,jdbcType=VARCHAR},
		    </if>
		    <if test="riskNo != null" >
		       #{riskNo,jdbcType=VARCHAR},
		    </if>
		    <if test="status != null" >
		       #{status,jdbcType=VARCHAR},
		    </if>
		    <if test="totalServiceFee != null" >
		       #{totalServiceFee,jdbcType=DECIMAL},
		    </if>
		    <if test="serviceRate != null" >
		       #{serviceRate,jdbcType=DECIMAL},
		    </if>
		    <if test="totalInterestFee != null" >
		       #{totalInterestFee,jdbcType=DECIMAL},
		    </if>
		    <if test="interestRate != null" >
		       #{interestRate,jdbcType=VARCHAR},
		    </if>
		    <if test="riskDailyRate != null" >
		       #{riskDailyRate,jdbcType=DECIMAL},
		    </if>
		    <if test="auAmount != null" >
		       #{auAmount,jdbcType=DECIMAL},
		    </if>
		    <if test="appName != null" >
		       #{appName,jdbcType=VARCHAR},
		    </if>
		    <if test="remark != null" >
		       #{remark,jdbcType=VARCHAR},
		    </if>
		    <if test="loanRemark != null" >
		       #{loanRemark,jdbcType=VARCHAR},
		    </if>
		    <if test="repayRemark != null" >
		       #{repayRemark,jdbcType=VARCHAR},
		    </if>
		    <if test="gmtCreate != null" >
		       #{gmtCreate,jdbcType=TIMESTAMP},
		    </if>
		    <if test="gmtModified != null" >
		       #{gmtModified,jdbcType=TIMESTAMP},
		    </if>
		    <if test="gmtArrival != null" >
		       #{gmtArrival,jdbcType=TIMESTAMP},
		    </if>
		    <if test="gmtReview != null" >
		       #{gmtReview,jdbcType=TIMESTAMP},
		    </if>
		    <if test="gmtClose != null" >
		       #{gmtClose,jdbcType=TIMESTAMP},
		    </if>
		    <if test="gmtFinish != null" >
		       #{gmtFinish,jdbcType=TIMESTAMP},
		    </if>
		    <if test="ip != null">        
               #{ip,jdbcType=VARCHAR},
            </if>
		    <if test="latitude != null" >
		       #{latitude,jdbcType=DECIMAL},
		    </if>
		    <if test="longitude != null" >
		       #{longitude,jdbcType=DECIMAL},
		    </if>
		    <if test="province != null" >
		       #{province,jdbcType=VARCHAR},
		    </if>
		    <if test="city != null" >
		       #{city,jdbcType=VARCHAR},
		    </if>
		    <if test="county != null" >
		       #{county,jdbcType=VARCHAR},
		    </if>
		    <if test="address != null" >
		       #{address,jdbcType=VARCHAR},
		    </if>
        </trim>
    </insert>
    
    <update id="updateById"  parameterType="com.ald.fanbei.api.dal.domain.AfLoanDo">
        UPDATE af_loan
          <set>
            <if test="userId != null and userId != '' ">        
                user_id = #{userId,jdbcType=INTEGER},                
            </if>
            <if test="loanNo != null and loanNo != '' ">        
                loan_no = #{loanNo,jdbcType=VARCHAR},                
            </if>
            <if test="tradeNoOut != null and tradeNoOut != '' ">        
                trade_no_out = #{tradeNoOut,jdbcType=VARCHAR},                
            </if>
            <if test="periods != null and periods != '' ">        
                periods = #{periods,jdbcType=INTEGER},                
            </if>
            <if test="amount != null and amount != '' ">        
                amount = #{amount,jdbcType=DECIMAL},                
            </if>
            <if test="arrivalAmount != null and arrivalAmount != '' ">        
                arrival_amount = #{arrivalAmount,jdbcType=DECIMAL},                
            </if>
            <if test="prdType != null and prdType != '' ">        
                prd_type = #{prdType,jdbcType=VARCHAR},                
            </if>
            <if test="cardNo != null and cardNo != '' ">        
                card_no = #{cardNo,jdbcType=VARCHAR},                
            </if>
            <if test="cardName != null and cardName != '' ">        
                card_name = #{cardName,jdbcType=VARCHAR},                
            </if>
            <if test="overdueDays != null and overdueDays != '' ">        
                overdue_days = #{overdueDays,jdbcType=INTEGER},                
            </if>
            <if test="overdueAmount != null">        
                overdue_amount = #{overdueAmount,jdbcType=DECIMAL},                
            </if>
            <if test="overdueRate != null and overdueRate != '' ">        
                overdue_rate = #{overdueRate,jdbcType=DECIMAL},                
            </if>
            <if test="overdueStatus != null and overdueStatus != '' ">        
                overdue_status = #{overdueStatus,jdbcType=VARCHAR},                
            </if>
            <if test="reviewName != null and reviewName != '' ">        
                review_name = #{reviewName,jdbcType=VARCHAR},                
            </if>
            <if test="reviewNo != null and reviewNo != '' ">        
                review_no = #{reviewNo,jdbcType=VARCHAR},                
            </if>
            <if test="reviewDetails != null and reviewDetails != '' ">        
                review_details = #{reviewDetails,jdbcType=VARCHAR},                
            </if>
            <if test="reviewStatus != null and reviewStatus != '' ">        
                review_status = #{reviewStatus,jdbcType=VARCHAR},                
            </if>
            <if test="riskNo != null and riskNo != '' ">        
                risk_no = #{riskNo,jdbcType=VARCHAR},                
            </if>
            <if test="status != null and status != '' ">        
                status = #{status,jdbcType=VARCHAR},                
            </if>
            <if test="totalServiceFee != null and totalServiceFee != '' ">        
                total_service_fee = #{totalServiceFee,jdbcType=DECIMAL},                
            </if>
            <if test="serviceRate != null and serviceRate != '' ">        
                service_rate = #{serviceRate,jdbcType=DECIMAL},                
            </if>
            <if test="totalInterestFee != null and totalInterestFee != '' ">        
                total_interest_fee = #{totalInterestFee,jdbcType=DECIMAL},                
            </if>
            <if test="interestRate != null and interestRate != '' ">        
                interest_rate = #{interestRate,jdbcType=VARCHAR},                
            </if>
            <if test="riskDailyRate != null and riskDailyRate != '' ">        
                risk_daily_rate = #{riskDailyRate,jdbcType=DECIMAL},                
            </if>
            <if test="auAmount != null and auAmount != '' ">        
                au_amount = #{auAmount,jdbcType=DECIMAL},                
            </if>
            <if test="appName != null and appName != '' ">        
                app_name = #{appName,jdbcType=VARCHAR},                
            </if>
            <if test="remark != null and remark != '' ">        
                remark = #{remark,jdbcType=VARCHAR},                
            </if>
            <if test="loanRemark != null and loanRemark != '' ">        
                loan_remark = #{loanRemark,jdbcType=VARCHAR},                
            </if>
            <if test="repayRemark != null and repayRemark != '' ">        
                repay_remark = #{repayRemark,jdbcType=VARCHAR},                
            </if>
            <if test="gmtCreate != null and gmtCreate != '' ">        
                gmt_create = #{gmtCreate,jdbcType=TIMESTAMP},                
            </if>
                
                gmt_modified = NOW(),
                                
            <if test="gmtArrival != null and gmtArrival != '' ">        
                gmt_arrival = #{gmtArrival,jdbcType=TIMESTAMP},                
            </if>
            <if test="gmtReview != null and gmtReview != '' ">        
                gmt_review = #{gmtReview,jdbcType=TIMESTAMP},                
            </if>
            <if test="gmtClose != null and gmtClose != '' ">        
                gmt_close = #{gmtClose,jdbcType=TIMESTAMP},                
            </if>
            <if test="gmtFinish != null and gmtFinish != '' ">        
                gmt_finish = #{gmtFinish,jdbcType=TIMESTAMP},                
            </if>
            <if test="latitude != null and latitude != '' ">        
                latitude = #{latitude,jdbcType=DECIMAL},                
            </if>
            <if test="longitude != null and longitude != '' ">        
                longitude = #{longitude,jdbcType=DECIMAL},                
            </if>
            <if test="province != null and province != '' ">        
                province = #{province,jdbcType=VARCHAR},                
            </if>
            <if test="city != null and city != '' ">        
                city = #{city,jdbcType=VARCHAR},                
            </if>
            <if test="county != null and county != '' ">        
                county = #{county,jdbcType=VARCHAR},                
            </if>
            <if test="address != null and address != '' ">        
                address = #{address,jdbcType=VARCHAR},                
            </if>
        </set>    
        WHERE is_delete = 0 AND id = #{rid ,jdbcType=BIGINT}
    </update>

	<select id="getById" resultType="com.ald.fanbei.api.dal.domain.AfLoanDo">
        SELECT
        <include refid="queryFields" />
        FROM af_loan
        WHERE is_delete = 0 AND id=#{rid ,jdbcType=BIGINT}
        LIMIT 0,1
    </select>

	<select id="getByCommonCondition" resultType="com.ald.fanbei.api.dal.domain.AfLoanDo" parameterType="com.ald.fanbei.api.dal.domain.AfLoanDo">
        SELECT
        <include refid="queryFields" />
        FROM af_loan
        <include refid="commonCondition"/> 
        limit 0,1
    </select>
               
    <select id="getListByCommonCondition" resultType="com.ald.fanbei.api.dal.domain.AfLoanDo" parameterType="com.ald.fanbei.api.dal.domain.AfLoanDo">
        SELECT
        <include refid="queryFields" />
        FROM af_loan
        <include refid="commonCondition"/>
    </select>
    
    <select id="getLastByUserIdAndPrdType" resultType="AfLoanDo">
        SELECT
        <include refid="queryFields" />
        FROM af_loan 
        WHERE is_delete = 0 
            AND user_id=#{userId}
            AND prd_type=#{prdType}
        ORDER BY id DESC
        LIMIT 1
    </select>
    
    <select id="getByLoanNo" resultType="AfLoanDo">
        SELECT
        <include refid="queryFields" />
        FROM af_loan 
        WHERE is_delete = 0 AND loan_no=#{loanNo}
        LIMIT 1
    </select>
    
    <select id="listDoneLoansByUserId" resultType="AfLoanDo">
        SELECT
        <include refid="queryFields" />
        FROM af_loan 
        WHERE is_delete = 0
            AND user_id = #{userId}
            AND status IN ('TRANSFER_FAIL','CLOSED','FINISHED')
        ORDER BY gmt_create DESC
        LIMIT #{start},20
    </select>
    
    <select id="listDealingLoansByUserId" resultType="AfLoanDo">
        SELECT
        <include refid="queryFields" />
        FROM af_loan
        WHERE is_delete = 0
            AND user_id = #{userId}
            AND status IN ('APPLY','TRANSFERING','TRANSFERRED')
        ORDER BY gmt_create DESC
    </select>

    <select id="selectById" resultType="AfLoanDo">
        SELECT
        <include refid="queryFields" />
        FROM af_loan
        WHERE is_delete = 0
        and id = #{loanId}
    </select>
    
    <select id="getBorrowInfoById" parameterType="com.ald.fanbei.api.dal.domain.AfLoanDo" resultType="com.ald.fanbei.api.dal.domain.dto.AfLoanDto">
		SELECT
			al.loan_no orderNo,
			al.user_id userId,
			au.real_name NAME,
			aua.id_number cardId,
			ub.mobile mobile,
			ub.card_number bankNo,
			al.card_name cardName,
			al.amount money,
			al.loan_remark ,
			al.repay_remark,
			al.gmt_create loanStartTime,
			al.periods
		FROM
			af_loan al
		LEFT JOIN af_user au ON au.id = al.user_id
		LEFT JOIN af_user_account aua ON aua.user_id = au.id
		left JOIN af_user_bankcard ub ON ub.user_id=al.user_id
	    WHERE al.is_delete = 0 AND al.id=#{rid ,jdbcType=BIGINT} and ub.is_main='Y'
        LIMIT 0,1
	</select>
	
	<select id="getLoanById" parameterType="java.lang.Long" resultType="com.ald.fanbei.api.dal.domain.AfLoanDo">
		SELECT
		<include refid="queryFields" />
		FROM
		af_loan
		WHERE
		is_delete = 0
		AND
		id = #{rid}
	</select>
</mapper>
