<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ald.fanbei.api.dal.dao.AfRecycleDao">
	
	<sql id="commSqlField">
		id rid,is_delete,gmt_create,gmt_modified,ref_order_id,pay_type,`status`
	</sql>

	<!-- 添加订单-->
	<insert id="addRecycleOrder" parameterType="AfRecycleQuery" keyProperty="rid" useGeneratedKeys="true" >
		INSERT INTO
			af_order_recycle
			(
				ref_order_id,
				user_id,
				pay_type,
				settle_price,
				status
			)
		VALUES
		    (
				#{refOrderId},
				#{userId},
				#{payType},
				#{settlePrice},
				#{status}
			)
	</insert>

	<!-- 更改订单状态 -->
	<update id="updateRecycleOrder" parameterType="AfRecycleQuery">
			UPDATE af_order_recycle
			SET gmt_modified = NOW(),
			status = #{status}
			WHERE ref_order_id = #{refOrderId}
	</update>

	<!-- 查找单个订单-->
	<select id="getRecycleOrder" parameterType="AfRecycleQuery" resultType="AfRecycleDo">
		SELECT
			<include refid="commSqlField"/>
		FROM
			af_order_recycle
		WHERE
			is_delete = 0
		AND
			ref_order_id = #{refOrderId}
	</select>

	<!-- 获取返现系统配置的系数-->
	<select id="getRecycleReturnRatio" parameterType="java.lang.Integer" resultType="AfRecycleRatioDo">
		SELECT
			ratio
		FROM
			af_recycle_ratio
		WHERE
			is_delete = 0
		AND
			is_disabled = 0
		AND
			`type` = 1
		ORDER BY id DESC
		LIMIT 1
	</select>

	<!-- 获取翻倍兑换系统配置的系数-->
	<select id="getRecycleExchangeRatio" parameterType="java.lang.Integer" resultType="AfRecycleRatioDo">
		SELECT
			ratio,probability
		FROM
			af_recycle_ratio
		WHERE
			is_delete = 0
		AND
			is_disabled = 0
		AND
			`type` = 2
			ORDER BY probability DESC
	</select>

</mapper>