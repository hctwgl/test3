<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- jsd_borrow_cash表 -->
<mapper namespace="com.ald.fanbei.api.dal.dao.JsdBorrowCashDao">
    
    <!--基本的sql查询字段 公共引用...-->
    <sql id="queryFields">
        id rid,user_id,product_no,borrow_no,trade_no_xgxy,trade_no_ups,type,version,status,review_status,review_remark,amount,arrival_amount,card_number,card_name,overdue_status,overdue_day,overdue_amount,poundage_amount,interest_amount,repay_principle,repay_amount,sum_repaid_interest,sum_repaid_poundage,sum_repaid_overdue,renewal_num,interest_rate,poundage_rate,overdue_rate,risk_daily_rate,gmt_plan_repayment,gmt_arrival,finish_date,remark,gmt_close,gmt_create,gmt_modified,borrow_remark,repay_remark
    </sql>

    <sql id="borrowDo">
        a.id rid,a.user_id,a.product_no,a.borrow_no,a.trade_no_xgxy,a.trade_no_ups,a.type,a.version,a.status,a.review_status,a.review_remark,a.amount,a.arrival_amount,a.card_number,a.card_name,a.overdue_status,a.overdue_day,a.overdue_amount,a.poundage_amount,a.interest_amount,a.repay_principle,a.repay_amount,a.sum_repaid_interest,a.sum_repaid_poundage,a.sum_repaid_overdue,a.renewal_num,a.interest_rate,a.poundage_rate,a.overdue_rate,a.risk_daily_rate,a.gmt_plan_repayment,a.gmt_arrival,a.finish_date,a.remark,a.gmt_close,a.gmt_create,a.gmt_modified,a.borrow_remark,a.repay_remark
    </sql>

    <sql id="queryGoodsInfo">
        o.order_no,o.goods_name,o.price_amount,o.delivery_user,o.delivery_phone,o.address
    </sql>
    <!-- 基本的sql查询条件公共引用 -->
    <sql id="commonCondition">
        WHERE is_delete = 0
        <if test="rid !=null">
            AND id  = #{rid,jdbcType=INTEGER}
        </if>
        <if test="userId != null">
            AND user_id = #{userId,jdbcType=INTEGER}
        </if>
        <if test="productNo != null">
            AND product_no = #{productNo,jdbcType=VARCHAR}
        </if>
        <if test="borrowNo != null">
            AND borrow_no = #{borrowNo,jdbcType=VARCHAR}
        </if>
        <if test="tradeNoXgxy != null">
            AND trade_no_xgxy = #{tradeNoXgxy,jdbcType=VARCHAR}
        </if>
        <if test="tradeNoUps != null">
            AND trade_no_ups = #{tradeNoUps,jdbcType=VARCHAR}
        </if>
        <if test="type != null">
            AND type = #{type,jdbcType=VARCHAR}
        </if>
        <if test="version != null">
            AND version = #{version,jdbcType=VARCHAR}
        </if>
        <if test="status != null">
            AND status = #{status,jdbcType=VARCHAR}
        </if>
        <if test="reviewStatus != null">
            AND review_status = #{reviewStatus,jdbcType=VARCHAR}
        </if>
        <if test="reviewRemark != null">
            AND review_remark = #{reviewRemark,jdbcType=VARCHAR}
        </if>
        <if test="amount != null">
            AND amount = #{amount,jdbcType=DECIMAL}
        </if>
        <if test="arrivalAmount != null">
            AND arrival_amount = #{arrivalAmount,jdbcType=DECIMAL}
        </if>
        <if test="cardNumber != null">
            AND card_number = #{cardNumber,jdbcType=VARCHAR}
        </if>
        <if test="cardName != null">
            AND card_name = #{cardName,jdbcType=VARCHAR}
        </if>
        <if test="overdueStatus != null">
            AND overdue_status = #{overdueStatus,jdbcType=VARCHAR}
        </if>
        <if test="overdueDay != null">
            AND overdue_day = #{overdueDay,jdbcType=INTEGER}
        </if>
        <if test="overdueAmount != null">
            AND overdue_amount = #{overdueAmount,jdbcType=DECIMAL}
        </if>
        <if test="poundageAmount != null">
            AND poundage_amount = #{poundageAmount,jdbcType=DECIMAL}
        </if>
        <if test="interestAmount != null">
            AND interest_amount = #{interestAmount,jdbcType=DECIMAL}
        </if>
        <if test="repayPrinciple != null">
            AND repay_principle = #{repayPrinciple,jdbcType=DECIMAL}
        </if>
        <if test="repayAmount != null">
            AND repay_amount = #{repayAmount,jdbcType=DECIMAL}
        </if>
        <if test="sumRepaidInterest != null">
            AND sum_repaid_interest = #{sumRepaidInterest,jdbcType=DECIMAL}
        </if>
        <if test="sumRepaidPoundage != null">
            AND sum_repaid_poundage = #{sumRepaidPoundage,jdbcType=DECIMAL}
        </if>
        <if test="sumRepaidOverdue != null">
            AND sum_repaid_overdue = #{sumRepaidOverdue,jdbcType=DECIMAL}
        </if>
        <if test="renewalNum != null">
            AND renewal_num = #{renewalNum,jdbcType=INTEGER}
        </if>
        <if test="interestRate != null">
            AND interest_rate = #{interestRate,jdbcType=DECIMAL}
        </if>
        <if test="poundageRate != null">
            AND poundage_rate = #{poundageRate,jdbcType=DECIMAL}
        </if>
        <if test="overdueRate != null">
            AND overdue_rate = #{overdueRate,jdbcType=DECIMAL}
        </if>
        <if test="riskDailyRate != null">
            AND risk_daily_rate = #{riskDailyRate,jdbcType=DECIMAL}
        </if>
        <if test="gmtPlanRepayment !=null">
            AND gmt_plan_repayment = #{gmtPlanRepayment,jdbcType=TIMESTAMP}
        </if>
        <if test="gmtArrival !=null">
            AND gmt_arrival = #{gmtArrival,jdbcType=TIMESTAMP}
        </if>
        <if test="finishDate != null">
            AND finish_date = #{finishDate,jdbcType=VARCHAR}
        </if>
        <if test="remark != null">
            AND remark = #{remark,jdbcType=VARCHAR}
        </if>
        <if test="gmtClose !=null">
            AND gmt_close = #{gmtClose,jdbcType=TIMESTAMP}
        </if>
        <if test="gmtCreate !=null">
            AND gmt_create = #{gmtCreate,jdbcType=TIMESTAMP}
        </if>
        <if test="gmtModified !=null">
            AND gmt_modified = #{gmtModified,jdbcType=TIMESTAMP}
        </if>
        <if test="borrowRemark !=null">
            AND borrow_remark = #{borrowRemark,jdbcType=VARCHAR}
        </if>
        <if test="repayRemark !=null">
            AND borrow_remark = #{repayRemark,jdbcType=VARCHAR}
        </if>

        <if test="unstatus !=null">
            AND status = #{unstatus,jdbcType=VARCHAR}
        </if>

        <if test="orstatus !=null">
            AND (status = 'TRANSFERRED' OR status= 'FINISHED')
        </if>


        <if test="queryDate!=null and queryDate!=''">
    <![CDATA[   and DATE_FORMAT(gmt_plan_repayment, '%Y-%m-%d')=  DATE_FORMAT(#{queryDate}, '%Y-%m-%d')   ]]>
	</if>

	 <if test="endDate!=null and endDate!=''">
    <![CDATA[and DATE_FORMAT(#{endDate}, '%Y-%m-%d')>=DATE_FORMAT(gmt_plan_repayment, '%Y-%m-%d')   ]]>
	</if>

    </sql>

    
    <insert id="saveRecord" parameterType="com.ald.fanbei.api.dal.domain.JsdBorrowCashDo" keyProperty="rid" useGeneratedKeys="true">
        INSERT INTO jsd_borrow_cash
        <trim prefix="(" suffix=")" suffixOverrides="," >
            <if test="userId != null">        
                user_id,
            </if>
            <if test="productNo != null">        
                product_no,
            </if>
            <if test="borrowNo != null">        
                borrow_no,
            </if>
            <if test="tradeNoXgxy != null">        
                trade_no_xgxy,
            </if>
            <if test="tradeNoUps != null">        
                trade_no_ups,
            </if>
            <if test="type != null">        
                type,
            </if>
            <if test="version != null">        
                version,
            </if>
            <if test="status != null">        
                status,
            </if>
            <if test="reviewStatus != null">        
                review_status,
            </if>
            <if test="reviewRemark != null">        
                review_remark,
            </if>
            <if test="amount != null">        
                amount,
            </if>
            <if test="arrivalAmount != null">        
                arrival_amount,
            </if>
            <if test="cardNumber != null">        
                card_number,
            </if>
            <if test="cardName != null">        
                card_name,
            </if>
            <if test="overdueStatus != null">        
                overdue_status,
            </if>
            <if test="overdueDay != null">        
                overdue_day,
            </if>
            <if test="overdueAmount != null">        
                overdue_amount,
            </if>
            <if test="poundageAmount != null">        
                poundage_amount,
            </if>
            <if test="interestAmount != null">        
                interest_amount,
            </if>
            <if test="repayPrinciple != null">        
                repay_principle,
            </if>
            <if test="repayAmount != null">        
                repay_amount,
            </if>
            <if test="sumRepaidInterest != null">        
                sum_repaid_interest,
            </if>
            <if test="sumRepaidPoundage != null">        
                sum_repaid_poundage,
            </if>
            <if test="sumRepaidOverdue != null">        
                sum_repaid_overdue,
            </if>
            <if test="renewalNum != null">        
                renewal_num,
            </if>
            <if test="interestRate != null">        
                interest_rate,
            </if>
            <if test="poundageRate != null">        
                poundage_rate,
            </if>
            <if test="overdueRate != null">        
                overdue_rate,
            </if>
            <if test="riskDailyRate != null">        
                risk_daily_rate,
            </if>
            <if test="gmtPlanRepayment != null">        
                gmt_plan_repayment,
            </if>
            <if test="gmtArrival != null">        
                gmt_arrival,
            </if>
            <if test="finishDate != null">        
                finish_date,
            </if>
            <if test="remark != null">        
                remark,
            </if>
            <if test="gmtClose != null">        
                gmt_close,
            </if>
            <if test="gmtCreate != null">        
                gmt_create,
            </if>
            <if test="gmtModified != null">        
                gmt_modified,
            </if>
            <if test="borrowRemark != null">        
                borrow_remark,
            </if>
            <if test="repayRemark != null">        
                repay_remark,
            </if>
        </trim>
        
        <trim prefix="values (" suffix=")" suffixOverrides="," >
            <if test="userId != null" >
               #{userId,jdbcType=INTEGER},
            </if>
            <if test="productNo != null" >
               #{productNo,jdbcType=VARCHAR},
            </if>
            <if test="borrowNo != null" >
               #{borrowNo,jdbcType=VARCHAR},
            </if>
            <if test="tradeNoXgxy != null" >
               #{tradeNoXgxy,jdbcType=VARCHAR},
            </if>
            <if test="tradeNoUps != null" >
               #{tradeNoUps,jdbcType=VARCHAR},
            </if>
            <if test="type != null" >
               #{type,jdbcType=VARCHAR},
            </if>
            <if test="version != null" >
               #{version,jdbcType=VARCHAR},
            </if>
            <if test="status != null" >
               #{status,jdbcType=VARCHAR},
            </if>
            <if test="reviewStatus != null" >
               #{reviewStatus,jdbcType=VARCHAR},
            </if>
            <if test="reviewRemark != null" >
               #{reviewRemark,jdbcType=VARCHAR},
            </if>
            <if test="amount != null" >
               #{amount,jdbcType=DECIMAL},
            </if>
            <if test="arrivalAmount != null" >
               #{arrivalAmount,jdbcType=DECIMAL},
            </if>
            <if test="cardNumber != null" >
               #{cardNumber,jdbcType=VARCHAR},
            </if>
            <if test="cardName != null" >
               #{cardName,jdbcType=VARCHAR},
            </if>
            <if test="overdueStatus != null" >
               #{overdueStatus,jdbcType=VARCHAR},
            </if>
            <if test="overdueDay != null" >
               #{overdueDay,jdbcType=INTEGER},
            </if>
            <if test="overdueAmount != null" >
               #{overdueAmount,jdbcType=DECIMAL},
            </if>
            <if test="poundageAmount != null" >
               #{poundageAmount,jdbcType=DECIMAL},
            </if>
            <if test="interestAmount != null" >
               #{interestAmount,jdbcType=DECIMAL},
            </if>
            <if test="repayPrinciple != null" >
               #{repayPrinciple,jdbcType=DECIMAL},
            </if>
            <if test="repayAmount != null" >
               #{repayAmount,jdbcType=DECIMAL},
            </if>
            <if test="sumRepaidInterest != null" >
               #{sumRepaidInterest,jdbcType=DECIMAL},
            </if>
            <if test="sumRepaidPoundage != null" >
               #{sumRepaidPoundage,jdbcType=DECIMAL},
            </if>
            <if test="sumRepaidOverdue != null" >
               #{sumRepaidOverdue,jdbcType=DECIMAL},
            </if>
            <if test="renewalNum != null" >
               #{renewalNum,jdbcType=INTEGER},
            </if>
            <if test="interestRate != null" >
               #{interestRate,jdbcType=DECIMAL},
            </if>
            <if test="poundageRate != null" >
               #{poundageRate,jdbcType=DECIMAL},
            </if>
            <if test="overdueRate != null" >
               #{overdueRate,jdbcType=DECIMAL},
            </if>
            <if test="riskDailyRate != null" >
               #{riskDailyRate,jdbcType=DECIMAL},
            </if>
            <if test="gmtPlanRepayment != null" >
               #{gmtPlanRepayment,jdbcType=TIMESTAMP},
            </if>
            <if test="gmtArrival != null" >
               #{gmtArrival,jdbcType=TIMESTAMP},
            </if>
            <if test="finishDate != null" >
               #{finishDate,jdbcType=VARCHAR},
            </if>
            <if test="remark != null" >
               #{remark,jdbcType=VARCHAR},
            </if>
            <if test="gmtClose != null" >
               #{gmtClose,jdbcType=TIMESTAMP},
            </if>
            <if test="gmtCreate != null" >
               #{gmtCreate,jdbcType=TIMESTAMP},
            </if>
            <if test="gmtModified != null" >
               #{gmtModified,jdbcType=TIMESTAMP},
            </if>
            <if test="borrowRemark != null" >
               #{borrowRemark,jdbcType=VARCHAR},
            </if>
            <if test="repayRemark != null" >
               #{repayRemark,jdbcType=VARCHAR},
            </if>
        </trim>
    </insert>
    
    <update id="updateById"  parameterType="com.ald.fanbei.api.dal.domain.JsdBorrowCashDo">
        UPDATE jsd_borrow_cash
          <set>
            <if test="userId != null">        
                user_id = #{userId,jdbcType=INTEGER},
            </if>
            <if test="productNo != null">        
                product_no = #{productNo,jdbcType=VARCHAR},
            </if>
            <if test="borrowNo != null">        
                borrow_no = #{borrowNo,jdbcType=VARCHAR},
            </if>
            <if test="tradeNoXgxy != null">        
                trade_no_xgxy = #{tradeNoXgxy,jdbcType=VARCHAR},
            </if>
            <if test="tradeNoUps != null">        
                trade_no_ups = #{tradeNoUps,jdbcType=VARCHAR},
            </if>
            <if test="type != null">        
                type = #{type,jdbcType=VARCHAR},
            </if>
            <if test="version != null">        
                version = #{version,jdbcType=VARCHAR},
            </if>
            <if test="status != null">        
                status = #{status,jdbcType=VARCHAR},
            </if>
            <if test="reviewStatus != null">        
                review_status = #{reviewStatus,jdbcType=VARCHAR},
            </if>
            <if test="reviewRemark != null">        
                review_remark = #{reviewRemark,jdbcType=VARCHAR},
            </if>
            <if test="amount != null">        
                amount = #{amount,jdbcType=DECIMAL},
            </if>
            <if test="arrivalAmount != null">        
                arrival_amount = #{arrivalAmount,jdbcType=DECIMAL},
            </if>
            <if test="cardNumber != null">        
                card_number = #{cardNumber,jdbcType=VARCHAR},
            </if>
            <if test="cardName != null">        
                card_name = #{cardName,jdbcType=VARCHAR},
            </if>
            <if test="overdueStatus != null">        
                overdue_status = #{overdueStatus,jdbcType=VARCHAR},
            </if>
            <if test="overdueDay != null">        
                overdue_day = #{overdueDay,jdbcType=INTEGER},
            </if>
            <if test="overdueAmount != null">        
                overdue_amount = #{overdueAmount,jdbcType=DECIMAL},
            </if>
            <if test="poundageAmount != null">        
                poundage_amount = #{poundageAmount,jdbcType=DECIMAL},
            </if>
            <if test="interestAmount != null">        
                interest_amount = #{interestAmount,jdbcType=DECIMAL},
            </if>
            <if test="repayPrinciple != null">        
                repay_principle = #{repayPrinciple,jdbcType=DECIMAL},
            </if>
            <if test="repayAmount != null">        
                repay_amount = #{repayAmount,jdbcType=DECIMAL},
            </if>
            <if test="sumRepaidInterest != null">        
                sum_repaid_interest = #{sumRepaidInterest,jdbcType=DECIMAL},
            </if>
            <if test="sumRepaidPoundage != null">        
                sum_repaid_poundage = #{sumRepaidPoundage,jdbcType=DECIMAL},
            </if>
            <if test="sumRepaidOverdue != null">        
                sum_repaid_overdue = #{sumRepaidOverdue,jdbcType=DECIMAL},
            </if>
            <if test="renewalNum != null">        
                renewal_num = #{renewalNum,jdbcType=INTEGER},
            </if>
            <if test="interestRate != null">        
                interest_rate = #{interestRate,jdbcType=DECIMAL},
            </if>
            <if test="poundageRate != null">        
                poundage_rate = #{poundageRate,jdbcType=DECIMAL},
            </if>
            <if test="overdueRate != null">        
                overdue_rate = #{overdueRate,jdbcType=DECIMAL},
            </if>
            <if test="riskDailyRate != null">        
                risk_daily_rate = #{riskDailyRate,jdbcType=DECIMAL},
            </if>
            <if test="gmtPlanRepayment != null">        
                gmt_plan_repayment = #{gmtPlanRepayment,jdbcType=TIMESTAMP},
            </if>
            <if test="gmtArrival != null">        
                gmt_arrival = #{gmtArrival,jdbcType=TIMESTAMP},
            </if>
            <if test="finishDate != null">        
                finish_date = #{finishDate,jdbcType=VARCHAR},
            </if>
            <if test="remark != null">        
                remark = #{remark,jdbcType=VARCHAR},
            </if>
            <if test="borrowRemark != null">        
                borrow_remark = #{borrowRemark,jdbcType=VARCHAR},
            </if>
            <if test="repayRemark != null">        
                repay_remark = #{repayRemark,jdbcType=VARCHAR},
            </if>
            <if test="gmtClose != null">        
                gmt_close = #{gmtClose,jdbcType=TIMESTAMP},
            </if>
            gmt_modified = NOW()
        </set>    
        WHERE is_delete = 0 AND id = #{rid ,jdbcType=BIGINT}
    </update>

	<select id="getById" resultType="com.ald.fanbei.api.dal.domain.JsdBorrowCashDo">
        SELECT
        <include refid="queryFields" />
        FROM jsd_borrow_cash
        WHERE is_delete = 0 AND id=#{rid ,jdbcType=BIGINT}
        LIMIT 0,1
    </select>

	<select id="getByCommonCondition" resultType="com.ald.fanbei.api.dal.domain.JsdBorrowCashDo" parameterType="com.ald.fanbei.api.dal.domain.JsdBorrowCashDo">
        SELECT
        <include refid="queryFields" />
        FROM jsd_borrow_cash
        <include refid="commonCondition"/> 
        limit 0,1
    </select>
               
    <select id="getListByCommonCondition" resultType="com.ald.fanbei.api.dal.domain.JsdBorrowCashDo" parameterType="com.ald.fanbei.api.dal.domain.JsdBorrowCashDo">
        SELECT
        <include refid="queryFields" />
        FROM jsd_borrow_cash
        <include refid="commonCondition"/>
    </select>

    <select id="getByBorrowNo" resultType="JsdBorrowCashDo">
        SELECT
        <include refid="queryFields" />
        FROM jsd_borrow_cash
        WHERE is_delete = 0 AND borrow_no=#{borrowNo}
        AND status <![CDATA[!= ]]> 'CLOSED'
        LIMIT 1
    </select>

    <select id="getByTradeNoXgxy" resultType="JsdBorrowCashDo">
        SELECT
        <include refid="queryFields" />
        FROM jsd_borrow_cash
        WHERE is_delete = 0 AND trade_no_xgxy=#{tradeNoXgxy}
        LIMIT 1
    </select>

    <select id="getCurrentLastBorrowNo" resultType="java.lang.String">
		select borrow_no from jsd_borrow_cash WHERE borrow_no LIKE CONCAT(#{orderNoPre},"%") ORDER BY id DESC LIMIT 1;
	</select>

    <select id="getBorrowCashOverdueCount" resultType="java.lang.Integer">
		SELECT
			count(*)
		FROM
			jsd_borrow_cash b where b.is_delete=0 and b.gmt_plan_repayment <![CDATA[   <  ]]> #{nowTime}  and status ='TRANSFERRED'
	</select>

    <select id="getBorrowCashByBeforeTodayCount" resultType="java.lang.Integer">
		SELECT
			count(*)
		FROM
			jsd_borrow_cash b where b.is_delete=0 and b.gmt_plan_repayment <![CDATA[   <  ]]> #{todayLast}  and status ='TRANSFERRED'
	</select>


    <select id="getBorrowCashByBeforeToday" resultType="JsdBorrowCashDo">
        SELECT
        <include refid="queryFields"/>
        FROM
        jsd_borrow_cash b where b.is_delete=0 and b.gmt_plan_repayment <![CDATA[   <  ]]> #{todayLast}
        and status='TRANSFERRED' limit #{beginIndex}, #{pageSize}
    </select>

    <select id="getBorrowCashRepayByUserIds" resultType="JsdBorrowCashDo">
        SELECT
        <include refid="queryFields"/>
        FROM
        jsd_borrow_cash b where b.is_delete=0 and b.gmt_plan_repayment <![CDATA[   <  ]]> #{todayLast}
        and status='TRANSFERRED' and user_id in (${userIds})
    </select>

    <select id="getBorrowCashOverduePaging" resultType="JsdBorrowCashDo">
        SELECT
        <include refid="queryFields"/>
        FROM
        jsd_borrow_cash b where b.is_delete=0 and b.gmt_plan_repayment <![CDATA[   <  ]]> #{nowTime}
        and status='TRANSFERRED' limit #{beginIndex}, #{pageSize}
    </select>

    <select id ="getBorrowCashByStatusNotInFinshAndClosed" resultType="JsdBorrowCashDo">
        SELECT
        <include refid="queryFields" />
        FROM
        jsd_borrow_cash
        WHERE
        is_delete = 0
        AND
        user_id = #{userId}
        and status not in ('CLOSED','FINISHED','TRANSEDFAIL');
    </select>

    <select id="getBorrowCashOverdueByUserIds" resultType="JsdBorrowCashDo">
		SELECT
         <include refid="queryFields"/>
		FROM
            jsd_borrow_cash b where b.is_delete=0
			and  status ='TRANSFERRED' and b.gmt_plan_repayment <![CDATA[   <  ]]> #{nowTime} and user_id in (${userIds})
	</select>

	<update id="updateReviewStatus">
		UPDATE jsd_borrow_cash
		SET review_status=#{reviewStatus},gmt_modified=NOW(),gmt_review=NOW()
		Where id=#{borrowId}
	</update>

    <select id="getReviewLoanList" resultType="LoanDto">
        SELECT
        a.*,CONCAT(LEFT(b.mobile,3), '****' ,RIGHT(b.mobile,4)) as mobile,b.real_name
        FROM
        jsd_borrow_cash a inner join jsd_user b on a.user_id=b.id where a.is_delete=0
        <if test="status != null and status =='WAIT'">
            AND a.review_status ='WAIT'
        </if>
        <if test="status != null and status =='PASS'">
            AND a.review_status ='PASS'
        </if>
        <if test="status != null and status =='REFUSE'">
            AND a.review_status ='REFUSE'
        </if>
        <if test="searchContent != null and searchContent !=''">
            AND (a.trade_no_xgxy LIKE  CONCAT('%',#{searchContent},'%')
            or b.mobile LIKE  CONCAT('%',#{searchContent},'%')
            or b.real_name LIKE  CONCAT('%',#{searchContent},'%'))
        </if>
        order by a.id desc
    </select>

    <select id="getReviewLoanStatistics" resultType="java.util.HashMap">
        SELECT
            COUNT(
                review_status != 'WAIT'
                OR NULL
            ) AS review,
            COUNT(review_status = 'PASS' OR NULL) AS pass,
            (
                SELECT
                    COUNT(review_status = 'WAIT' OR NULL)
                FROM
                    jsd_borrow_cash
                WHERE
                    to_days(gmt_create) = to_days(now())
            ) AS wait
        FROM
            jsd_borrow_cash
        WHERE
            to_days(gmt_review) = to_days(now())
    </select>

    <select id="getLoanStatistics" resultType="java.util.HashMap">
        SELECT
            SUM(amount) AS amount,
            COUNT(distinct(user_id)) AS apply
        FROM
            jsd_borrow_cash
        WHERE
            to_days(gmt_create) = to_days(now()) and status in('WAITTRANSED','TRANSFERING','TRANSFERRED','FINISHED')
    </select>

    <select id="getRepayStatistics" resultType="java.util.HashMap">
        SELECT
        (
            SELECT
                COUNT(1)
            FROM
                jsd_borrow_cash
            WHERE
                `status` = 'FINISHED'
            AND to_days(finish_date) = to_days(now())
        ) AS repay,
        (
            SELECT
                COUNT(1)
            FROM
                jsd_borrow_cash
            WHERE
                `status` = 'FINISHED'
            AND to_days(finish_date) = to_days(now())
            and finish_date <![CDATA[   <  ]]> gmt_plan_repayment
        ) AS advanceRepay,
        (
            SELECT
                COUNT(1)
            FROM
                jsd_borrow_cash
            WHERE
                `status` = 'FINISHED'
            AND to_days(finish_date) = to_days(now())
            and finish_date <![CDATA[   >  ]]> gmt_plan_repayment
        ) AS overdueRepay,
        (
            SELECT
                COUNT(1)
            FROM
                jsd_borrow_cash
            WHERE
                `status` = 'TRANSFERRED' and is_delete=0
                AND  gmt_plan_repayment <![CDATA[   <  ]]>   DATE_SUB(curdate(),INTERVAL -1 DAY)
        ) AS awaitRepay,
        (
            SELECT
                COUNT(1)
            FROM
                jsd_borrow_cash
            WHERE
                `status` = 'TRANSFERRED' and is_delete=0
        ) AS allAwaitRepay,
        (
            SELECT
                COUNT(1)
            FROM
                jsd_borrow_cash
            WHERE
                `status` = 'TRANSFERRED' and is_delete=0
                AND  overdue_status = 'Y'
                AND gmt_plan_repayment <![CDATA[  <  ]]> now()
        ) AS overdueAwaitRepay
    </select>

    <update id="refuseByXgNo">
		UPDATE jsd_borrow_cash
		SET review_status='REFUSE',review_remark=#{reviewRemark},status='CLOSED',gmt_close=NOW(),gmt_modified=NOW(),gmt_review=NOW()
		Where trade_no_xgxy=#{tradeNoXgxy}
	</update>

    <update id="passByXgNo">
		UPDATE jsd_borrow_cash
		SET review_status='PASS',status='WAITTRANSED',gmt_modified=NOW()
		Where trade_no_xgxy=#{tradeNoXgxy}
	</update>

    <select id="getLoanList" resultType="LoanDto">
        SELECT
        a.*,CONCAT(LEFT(b.mobile,3), '****' ,RIGHT(b.mobile,4)) as mobile,b.real_name
        FROM
        jsd_borrow_cash a inner join jsd_user b on a.user_id=b.id where a.is_delete=0
        and a.review_status='PASS'
        <if test="status != null and status !='ALL' and status !=''">
            AND a.status =#{status}
        </if>
        <if test="searchContent != null and searchContent !=''">
            AND (a.trade_no_xgxy LIKE  CONCAT('%',#{searchContent},'%')
            or b.mobile LIKE  CONCAT('%',#{searchContent},'%')
            or b.real_name LIKE  CONCAT('%',#{searchContent},'%'))
        </if>
        order by a.id desc
    </select>

    <select id="getRepayList" resultType="LoanDto">
        SELECT
        a.*,CONCAT(LEFT(b.mobile,3), '****' ,RIGHT(b.mobile,4)) as mobile,b.real_name,
        CASE WHEN a.renewal_num = 0 THEN 'N' ELSE 'Y' END AS isRenewal
        FROM
        jsd_borrow_cash a inner join jsd_user b on a.user_id=b.id
        where a.is_delete=0
        and a.review_status='PASS'
        <if test="status != null and status !='ALL' and status !='OVERDUE' and status !='TRANSFERRED' and status !=''">
            AND a.status =#{status}
            AND a.overdue_status='N'
        </if>
        <if test="status != null and status =='TRANSFERRED' and status !=''">
            AND a.gmt_plan_repayment <![CDATA[  >  ]]> now()
            AND a.status =#{status}
        </if>
        <if test="status != null and status =='OVERDUE' and status !=''">
            AND a.gmt_plan_repayment <![CDATA[  <  ]]> now()
            AND a.overdue_status='Y'
            AND a.status ='TRANSFERRED'
        </if>
        <if test="searchContent != null and searchContent !=''">
            AND (a.trade_no_xgxy LIKE  CONCAT('%',#{searchContent},'%')
            or b.real_name LIKE  CONCAT('%',#{searchContent},'%')
            or b.mobile LIKE  CONCAT('%',#{searchContent},'%'))
        </if>
        order by a.gmt_plan_repayment desc
    </select>

    <select id="getByRenewalNo" resultType="JsdBorrowCashDo">
        SELECT
          <include refid="borrowDo"/>
        FROM
        jsd_borrow_cash a ,jsd_borrow_cash_renewal b
        where a.is_delete = 0 AND b.is_delete = 0
        AND b.trade_no_xgxy = #{renewalNo}
        AND a.id = b.borrow_id
        LIMIT 0,1
    </select>

    <select id="getPaymentDetail" resultType="FinaneceDataDo">

      SELECT `borrow_no` AS 'borrowNo',`trade_no_ups` AS 'pay_trade_no',`arrival_amount` AS 'actualAmount',`gmt_arrival` AS 'actualTime','other' AS tppNid,'极速贷' AS 'productName','现金贷' AS 'productType','绿游' AS liquidationCompany
  FROM `jsd_borrow_cash`
 where `is_delete`= 0
   AND `status` IN("TRANSFERRED", "FINISHED")
 AND `gmt_arrival` BETWEEN concat(DATE_SUB(CURDATE(), INTERVAL 1 DAY), " 00:00:00") and concat(DATE_SUB(CURDATE(), INTERVAL 1 DAY), " 23:59:59") ;
    </select>


    <select id="getPromiseIncomeDetail" resultType="FinaneceDataDo">


            SELECT * FROM
             (SELECT `id` ,`borrow_no` AS 'borrowNo',concat(`type`,'天') AS 'periods',gmt_plan_repayment AS 'gmtPlanRepay',(`amount`+interest_amount+`poundage_amount`+`overdue_amount`+`sum_repaid_interest` +`sum_repaid_poundage` +`sum_repaid_overdue`)  AS 'predictAmount',
            repay_amount AS 'repayAmount',(`amount`+interest_amount+`poundage_amount`+`overdue_amount`+`sum_repaid_interest` +`sum_repaid_poundage` +`sum_repaid_overdue`)-repay_amount AS 'noneAmount',`amount` as 'amount',
            `interest_amount` +`sum_repaid_interest` AS 'retaAmount',`poundage_amount` +`sum_repaid_poundage` as 'poundageAmount',`overdue_amount` +`sum_repaid_overdue` AS 'overdueAmount',
            IF (`status`='FINISHED','已结清','待还款') AS 'status','极速贷' AS 'productName','现金贷' AS 'productType','绿游' AS liquidationCompany
              FROM `jsd_borrow_cash`
             where `is_delete`= 0
               AND `status` IN("TRANSFERRED", "FINISHED")
             AND `gmt_plan_repayment` BETWEEN concat(DATE_SUB(CURDATE(), INTERVAL 1 DAY), " 00:00:00") and concat(DATE_SUB(CURDATE(), INTERVAL 1 DAY), " 23:59:59")
            ) a
            LEFT JOIN
            (SELECT borrow_id,amount AS 'shopAmount' FROM `jsd_borrow_legal_order_cash` WHERE `status` NOT IN ("CLOSED","APPLYING")  GROUP BY `borrow_id`) b on a.id=b.borrow_id

    </select>
    <select id="getTransedCashDtosByUserId"  resultType="JsdBorrowCashDo" parameterType="java.lang.Long">
        SELECT
        <include refid="queryFields"/>
        FROM jsd_borrow_cash
        WHERE  is_delete = 0
        AND user_id = #{userId}
        AND (status = 'APPLY' OR status = 'WAITTRANSED' OR status = 'TRANSFERING' OR status = 'TRANSFERRED')
        ORDER BY id DESC LIMIT 1
    </select>

    <select id="getLastFinishCashByUserId"  resultType="JsdBorrowCashDo"  parameterType="java.lang.Long">
        SELECT
        <include refid="queryFields"/>
        FROM jsd_borrow_cash
        WHERE is_delete = 0
        AND user_id = #{userId}
        AND status = 'FINISHED'
        ORDER BY id DESC LIMIT 1
    </select>

    <select id="getGoodsInfoByBorrowId" resultType="JsdCashDto">
        SELECT
        <include refid="queryGoodsInfo" />
        FROM jsd_borrow_cash c LEFT JOIN jsd_borrow_legal_order o
        ON c.id=o.borrow_id
        WHERE o.is_delete=0 AND c.id =#{borrowId}
        AND o.status NOT IN ('CLOSED','UNPAID')
        ORDER BY o.id DESC LIMIT 1
    </select>
    <select id="getOverdueInfoByUserId" resultType="com.ald.fanbei.api.dal.domain.dto.AfUserBorrowCashOverdueInfoDto">
		SELECT
			COUNT(1) overdueNums,ifnull(sum(amount),0) overdueAmount
		FROM
			jsd_borrow_cash
		WHERE
			`status` IN ('TRANSFERRED', 'FINISHED') and overdue_status='Y'
		 and user_id = #{userId}
	</select>


    <select id="getBorrowById" resultType="com.ald.fanbei.api.dal.domain.JsdBorrowCashDo">
        SELECT
        <include refid="queryFields"/>
        FROM jsd_borrow_cash WHERE is_delete = 0 AND id = #{id}
    </select>

    <select id="getBorrowByRid" resultType="com.ald.fanbei.api.dal.domain.JsdBorrowCashDo">
        SELECT
        <include refid="queryFields"/>
        FROM jsd_borrow_cash WHERE is_delete = 0 AND id = #{id}
        FOR UPDATE
    </select>

    <select id="getBorrowCashByOverdueCountBySection" resultType="java.lang.Integer">
		SELECT
			count(*)
		FROM
			jsd_borrow_cash b where b.is_delete=0 and status ='TRANSFERRED'  and gmt_plan_repayment  BETWEEN  #{startOverdue} AND  #{endOverdue}

	</select>

    <select id="getBorrowCashOverdueBySection" resultType="JsdBorrowCashDo">
        SELECT
        <include refid="queryFields"/>
        FROM
        jsd_borrow_cash b where b.is_delete=0  and gmt_plan_repayment BETWEEN  #{startTime} AND  #{endTime}
        and status='TRANSFERRED'
    </select>

    <select id="getBorrowCashByTodayCount" resultType="java.lang.Integer">
		SELECT
			count(*)
		FROM
			jsd_borrow_cash b where b.is_delete=0 and  Date(b.gmt_plan_repayment) = #{todayLast}  and status ='TRANSFERRED'
	</select>

    <select id="getBorrowCashByToday" resultType="JsdBorrowCashDo">
        SELECT
        <include refid="queryFields"/>
        FROM
        jsd_borrow_cash b where b.is_delete=0 and Date(b.gmt_plan_repayment) = #{todayLast}
        and status='TRANSFERRED'
    </select>

    <select id="getTodayBorrowCashRepayByUserIds" resultType="JsdBorrowCashDo">
        SELECT
        <include refid="queryFields"/>
        FROM
        jsd_borrow_cash b where b.is_delete=0 and Date(b.gmt_plan_repayment) = #{todayLast}
        and status='TRANSFERRED' and user_id in (${userIds})
    </select>

    <select id="getOverSectionBorrowCashRepayByUserIds" resultType="JsdBorrowCashDo">
        SELECT
        <include refid="queryFields"/>
        FROM
        jsd_borrow_cash b where b.is_delete=0  and gmt_plan_repayment BETWEEN  #{startTime} AND  #{endTime}
        and status='TRANSFERRED' and user_id in (${userIds})
    </select>


    <select id="getcount" resultType="java.lang.Integer" parameterType="com.ald.fanbei.api.dal.domain.JsdBorrowCashDo">
        SELECT
        count(*)
        FROM jsd_borrow_cash
        <include refid="commonCondition"/>
    </select>


    <select id="getReplayAmount" resultType="java.math.BigDecimal" parameterType="com.ald.fanbei.api.dal.domain.JsdBorrowCashDo">
        SELECT
         sum(amount+overdue_amount+poundage_amount+interest_amount+sum_repaid_interest+sum_repaid_poundage+sum_repaid_overdue-repay_amount)
        FROM jsd_borrow_cash
        <include refid="commonCondition"/>
    </select>

    <select id="getALLReplayAmount" resultType="java.math.BigDecimal" parameterType="com.ald.fanbei.api.dal.domain.JsdBorrowCashDo">
        SELECT
         sum(repay_amount)
        FROM jsd_borrow_cash
        where
        is_delete = 0

        AND status = #{status,jdbcType=VARCHAR}
         <if test="type != null">
               AND type = #{type,jdbcType=VARCHAR}
            </if>

	 <![CDATA[and DATE_FORMAT(#{endDate}, '%Y-%m-%d')>=DATE_FORMAT(finish_date, '%Y-%m-%d')   ]]>

    </select>

      <select id="getArrivalAmount" resultType="java.math.BigDecimal" parameterType="com.ald.fanbei.api.dal.domain.JsdBorrowCashDo">
        SELECT
        sum(arrival_amount)
       FROM jsd_borrow_cash
        where
        is_delete = 0

        AND (status = 'TRANSFERRED' OR status= 'FINISHED')
       <if test="type != null">
               AND type = #{type,jdbcType=VARCHAR}
            </if>

	 <![CDATA[and DATE_FORMAT(#{endDate}, '%Y-%m-%d')>=DATE_FORMAT(gmt_arrival, '%Y-%m-%d')   ]]>



    </select>





    <select id="getLoanNum" resultType="java.lang.Integer">
        select count(id) from
          jsd_borrow_cash
        where to_days(gmt_arrival) = to_days(#{date})
          and status in ('TRANSFERRED','FINISHED')
          and is_delete = 0
        <if test="nper != null and nper !='all' and nper !=''">
            AND type = #{nper}
        </if>
    </select>

    <select id="getAppleAmount" resultType="java.math.BigDecimal">
        select SUM(amount) from
          jsd_borrow_cash
        where to_days(gmt_create) = to_days(#{date})
          and is_delete = 0
        <if test="nper != null and nper !='all' and nper !=''">
            AND type = #{nper}
        </if>
    </select>

    <select id="getLoanAmount" resultType="java.math.BigDecimal">
        select SUM(arrival_amount) from
        jsd_borrow_cash
        where to_days(gmt_arrival) = to_days(#{date})
        and status in ('TRANSFERRED','FINISHED')
        and is_delete = 0
        <if test="nper != null and nper !='all' and nper !=''">
            AND type = #{nper}
        </if>
    </select>

    <select id="getRepaymentAmount" resultType="java.math.BigDecimal">
        select SUM(amount + poundage_amount + interest_amount) from
        jsd_borrow_cash
        where to_days(gmt_plan_repayment) = to_days(#{date})
        and status in ('TRANSFERRED','FINISHED')
        and is_delete = 0
        <if test="nper != null and nper !='all' and nper !=''">
            AND type = #{nper}
        </if>
    </select>

    <select id="getNormalAmount" resultType="java.math.BigDecimal">
        SELECT
            SUM(r.actual_amount)
        FROM
        jsd_borrow_cash b,
        jsd_borrow_cash_repayment r
        WHERE
        r.borrow_id = b.id
        and TO_DAYS(b.gmt_plan_repayment) = TO_DAYS(#{date})
        <![CDATA[ and  TO_DAYS(r.gmt_create) <= TO_DAYS(#{date}) ]]>
        <![CDATA[ and  TO_DAYS(b.finish_date) <= TO_DAYS(#{date}) ]]>
        AND r.`status` = 'Y'
        AND r.is_delete = '0'
        AND b.is_delete = '0'
        AND b.`status` in ('FINISHED')
        <if test="nper != null and nper !='all' and nper !=''">
            AND b.type = #{nper}
        </if>
    </select>


    <select id="getRepaymentNum" resultType="java.lang.Integer">
        select count(*) from
        jsd_borrow_cash
        where to_days(gmt_plan_repayment) = to_days(#{date})
        and status in ('TRANSFERRED','FINISHED')
        and is_delete = 0
        <if test="nper != null and nper !='all' and nper !=''">
            AND type = #{nper}
        </if>
    </select>

    <select id="getSumRepaymentNum" resultType="java.lang.Integer">
        select count(DISTINCT(b.id))
        from
        jsd_borrow_cash b, jsd_borrow_cash_repayment r
        where b.id = r.borrow_id
        and TO_DAYS(r.gmt_create) = TO_DAYS(#{date})
        and TO_DAYS(b.finish_date) = TO_DAYS(#{date})
        and r.status = 'Y'
        and b.is_delete = 0
        and b.is_delete = r.is_delete
        and b.status = 'FINISHED'
        <if test="nper != null and nper !='all' and nper !=''">
            AND b.type = #{nper}
        </if>
    </select>

    <select id="getNormalNum" resultType="java.lang.Integer">
        SELECT
            COUNT(DISTINCT(b.`id`))
        FROM
        jsd_borrow_cash b,
        jsd_borrow_cash_repayment r
        WHERE
        r.borrow_id = b.id
        and TO_DAYS(b.gmt_plan_repayment) = TO_DAYS(#{date})
        <![CDATA[ and  TO_DAYS(r.gmt_create) <= TO_DAYS(#{date}) ]]>
        <![CDATA[ and  TO_DAYS(b.finish_date) <= TO_DAYS(#{date}) ]]>
        AND r.`status` = 'Y'
        AND r.is_delete = '0'
        AND b.is_delete = '0'
        AND b.`status` in ('FINISHED')
        <if test="nper != null and nper !='all' and nper !=''">
            AND b.type = #{nper}
        </if>
    </select>

    <select id="getInHand" resultType="com.ald.fanbei.api.dal.domain.dto.InHandTaskDto">
        select trade_no_ups as orderNos
        from
        jsd_borrow_cash
        where is_delete = 0
        and `status` = 'TRANSFERING'
        AND DATE_SUB(CURDATE(), INTERVAL 7 DAY) <![CDATA[  <=  ]]> date(gmt_create)
    </select>

    <select id ="getBorrowCashsTransedForCrawler" resultType="JsdBorrowCashDo">
        SELECT
        <include refid="queryFields" />
        FROM
        jsd_borrow_cash
        WHERE
        is_delete = 0
        AND
        user_id IN (SELECT id FROM jsd_user
        WHERE is_delete = 0
        AND (LEFT(mobile,3) =#{topThree} OR LEFT(user_name,3) =#{topThree})
        AND (RIGHT(mobile,2)=#{laterTwo} OR RIGHT(user_name,2)=#{laterTwo})
        AND substring(real_name,2)=#{realName})
        and status = 'TRANSFERRED'
        ORDER BY
        gmt_create DESC
    </select>


</mapper>
