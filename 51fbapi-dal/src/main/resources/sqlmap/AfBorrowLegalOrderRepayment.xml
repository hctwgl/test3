<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- af_borrow_legal_order_cash表 -->
<mapper namespace="com.ald.fanbei.api.dal.dao.AfBorrowLegalOrderRepaymentDao">
    
    <!--基本的sql查询字段 公共引用...-->
    <sql id="queryFields">
        id,user_id,borrow_id,borrow_legal_order_cash_id,repay_amount, actual_amount,name,trade_no,trade_no_ups,trade_no_wx,
        trade_no_zfb,user_coupon_id,coupon_amount,rebate_amount,status,card_name,card_no,gmt_create,gmt_modified
    </sql>
    
    <insert id="addBorrowLegalOrderRepayment" parameterType="AfBorrowLegalOrderRepaymentDo" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO af_borrow_legal_order_repayment(user_id , borrow_id, borrow_legal_order_cash_id , repay_amount , actual_amount, name , trade_no ,
         trade_no_ups , trade_no_wx , trade_no_zfb , user_coupon_id , coupon_amount , rebate_amount , status , card_name , 
         card_no , gmt_create , gmt_modified)
        VALUES (
            #{userId},
            #{borrowId},
            #{borrowLegalOrderCashId},
            #{repayAmount},
            #{actualAmount},
            #{name},
            #{tradeNo},
            #{tradeNoUps},
            #{tradeNoWx},
            #{tradeNoZfb},
            #{userCouponId},
            #{couponAmount},
            #{rebateAmount},
            #{status},
            #{cardName},
            #{cardNo},
            NOW(),
            NOW()
        )
    </insert>

    <update id="updateBorrowLegalOrderRepayment" parameterType="AfBorrowLegalOrderRepaymentDo" >
        UPDATE af_borrow_legal_order_repayment SET gmt_modified = NOW()
        <if test="userId != null">
            ,user_id=#{userId}
        </if>
        <if test="borrowId != null">
            ,borrow_id=#{borrowId}
        </if>
        <if test="borrowLegalOrderCashId != null">
            ,borrow_legal_order_cash_id=#{borrowLegalOrderCashId}
        </if>
        <if test="repayAmount != null">
            ,repay_amount=#{repayAmount}
        </if>
        <if test="name != null">
            ,name=#{name}
        </if>
        <if test="tradeNo != null">
            ,trade_no=#{tradeNo}
        </if>
        <if test="tradeNoUps != null">
            ,trade_no_ups=#{tradeNoUps}
        </if>
        <if test="tradeNoWx != null">
            ,trade_no_wx=#{tradeNoWx}
        </if>
        <if test="tradeNoZfb != null">
            ,trade_no_zfb=#{tradeNoZfb}
        </if>
        <if test="userCouponId != null">
            ,user_coupon_id=#{userCouponId}
        </if>
        <if test="couponAmount != null">
            ,coupon_amount=#{couponAmount}
        </if>
        <if test="rebateAmount != null">
            ,rebate_amount=#{rebateAmount}
        </if>
        <if test="status != null">
            ,status=#{status}
        </if>
        <if test="cardName != null">
            ,card_name=#{cardName}
        </if>
        <if test="cardNo != null">
            ,card_no=#{cardNo}
        </if>
        WHERE id = #{id}
    </update>

    <update id="deleteBorrowLegalOrderRepayment" parameterType="java.lang.Long" >
        UPDATE af_borrow_legal_order_repayment SET is_delete = 1 WHERE id=#{rid}
    </update>

	<select id="getById" resultType="com.ald.fanbei.api.dal.domain.AfBorrowLegalOrderRepaymentDo">
	 	SELECT
        <include refid="queryFields" />
        FROM af_borrow_legal_order_repayment
        WHERE id=#{id}
        LIMIT 1
	</select>

    <!-- 基本的sql查询条件公共引用 -->
    <sql id="commonCondition">
        WHERE is_delete = 0
		<if  test="id != null">
		    AND id=#{id} 
		</if>
		<if test="userId != null">
		    AND user_id=#{userId}
		</if>
		<if test="borrowId != null">
            AND borrow_id=#{borrowId}
        </if>
		<if test="borrowLegalOrderCashId != null">
		    AND borrow_legal_order_cash_id=#{borrowLegalOrderCashId}
		</if>
		<if test="repayAmount != null">
		    AND repay_amount=#{repayAmount}
		</if>
		<if test="actualAmount != null">
            AND actual_amount=#{actualAmount}
        </if>
		<if  test="name != null">
		    AND name=#{name}
		</if>
		<if test="tradeNo != null">
		    AND trade_no=#{tradeNo}
		</if>
		<if test="tradeNoUps != null">
		    AND trade_no_ups=#{tradeNoUps}
		</if>
		<if test="tradeNoWx != null">
		    AND trade_no_wx=#{tradeNoWx}
		</if>
		<if test="tradeNoZfb != null">
		    AND trade_no_zfb=#{tradeNoZfb}
		</if>
		<if test="userCouponId != null">
		    AND user_coupon_id=#{userCouponId}
		</if>
		<if test="couponAmount != null">
		    AND coupon_amount=#{couponAmount}
		</if>
		<if test="rebateAmount != null">
		    AND rebate_amount=#{rebateAmount}
		</if>
		<if  test="status != null">
		    AND status=#{status}
		</if>
		<if test="cardName != null">
		    AND card_name=#{cardName}
		</if>
		<if test="cardNo != null">
		    AND card_no=#{cardNo}
		</if>
		<if test="gmtCreate != null">
		    AND gmt_create=#{gmtCreate}
		</if>
		<if test="gmtModified != null">
		    AND gmt_modified=#{gmtModified}
		</if>
    </sql>
    
    <select id="getLastByOrderId" resultType="com.ald.fanbei.api.dal.domain.AfBorrowLegalOrderRepaymentDo">
        SELECT
        <include refid="queryFields" />
        FROM af_borrow_legal_order_repayment
        WHERE borrow_legal_order_cash_id=#{orderId ,jdbcType=BIGINT}
        LIMIT 1
    </select>
    
    <select id="getBorrowLegalOrderRepaymentByPayTradeNo" resultType="com.ald.fanbei.api.dal.domain.AfBorrowLegalOrderRepaymentDo">
		select 
			<include refid="queryFields"/> 
		from af_borrow_legal_order_repayment 
		WHERE trade_no=#{payTradeNo}
	</select>
    
    <select id="tuchByOutTradeNo" resultType="java.lang.Long">
		select id
		from af_borrow_legal_order_repayment 
		WHERE trade_no_ups=#{outTradeNo} AND is_delete = 0 
		LIMIT 1
	</select>
    
    
     <select id="getRepaymentByOrderCashId" resultType="com.ald.fanbei.api.dal.domain.AfBorrowLegalOrderRepaymentDo">
        SELECT
        <include refid="queryFields" />
        FROM af_borrow_legal_order_repayment
        WHERE borrow_legal_order_cash_id=#{orderCashId ,jdbcType=BIGINT}
    </select>
    
    <select id="getOrderRepayingTotalAmountByBorrowId" resultType="java.math.BigDecimal">
        SELECT
		IFNULL(SUM(repay_amount) ,0)
		FROM
		af_borrow_legal_order_repayment
		WHERE
		is_delete = 0
		AND
		borrow_id=#{borrowId}
		AND `status` = 'P'
    </select>
    
    <select id="getNewOrderRepayment" resultType="com.ald.fanbei.api.dal.domain.AfBorrowLegalOrderRepaymentDo">
  		SELECT
        <include refid="queryFields" />
        FROM af_borrow_legal_order_repayment
        WHERE is_delete = 0
        AND borrow_id=#{borrowId}
        AND status in ('A','P')
    </select>
    
</mapper>
