<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- af_borrow_legal_order表 -->
<mapper namespace="com.ald.fanbei.api.dal.dao.AfBorrowLegalOrderDao">

	<!--基本的sql查询字段 公共引用... -->
	<sql id="queryFields">
		id
		rid,gmt_create,gmt_modified,user_id,borrow_id,order_no,status,goods_id,price_amount,gmt_deliver,gmt_confirm_received,gmt_closed,closed_detail,address,goods_name,logistics_info,logistics_company,logistics_no,delivery_user,delivery_phone
	</sql>

	<!-- 基本的sql查询条件公共引用 -->
	<sql id="commonCondition">
		WHERE is_delete = 0
		<if test="rid !=null">
			AND id = #{rid,jdbcType=INTEGER}
		</if>
		<if test="gmtCreate !=null">
			AND gmt_create = #{gmtCreate,jdbcType=TIMESTAMP}
		</if>
		<if test="gmtModified !=null">
			AND gmt_modified = #{gmtModified,jdbcType=TIMESTAMP}
		</if>
		<if test="userId != null and userId != ''">
			AND user_id = #{userId,jdbcType=INTEGER}
		</if>
		<if test="borrowId != null and borrowId != ''">
			AND borrow_id = #{borrowId,jdbcType=INTEGER}
		</if>
		<if test="orderNo != null and orderNo != ''">
			AND order_no = #{orderNo,jdbcType=VARCHAR}
		</if>
		<if test="status != null and status != ''">
			AND status = #{status,jdbcType=VARCHAR}
		</if>
		<if test="goodsId != null and goodsId != ''">
			AND goods_id = #{goodsId,jdbcType=INTEGER}
		</if>
		<if test="priceAmount != null and priceAmount != ''">
			AND price_amount = #{priceAmount,jdbcType=DECIMAL}
		</if>
		<if test="gmtDeliver !=null">
			AND gmt_deliver = #{gmtDeliver,jdbcType=TIMESTAMP}
		</if>
		<if test="gmtConfirmReceived !=null">
			AND gmt_confirm_received = #{gmtConfirmReceived,jdbcType=TIMESTAMP}
		</if>
		<if test="gmtClosed !=null">
			AND gmt_closed = #{gmtClosed,jdbcType=TIMESTAMP}
		</if>
		<if test="closedDetail != null and closedDetail != ''">
			AND closed_detail = #{closedDetail,jdbcType=VARCHAR}
		</if>
		<if test="address != null and address != ''">
			AND address = #{address,jdbcType=VARCHAR}
		</if>

		<if test="goodsName != null and goodsName != ''">
			AND goods_name = #{goodsName,jdbcType=VARCHAR}
		</if>
	</sql>


	<insert id="addBorrowLegalOrder" parameterType="com.ald.fanbei.api.dal.domain.AfBorrowLegalOrderDo" useGeneratedKeys="true" keyProperty="rid">
        INSERT INTO af_borrow_legal_order(gmt_create,gmt_modified,user_id,borrow_id,order_no,status,goods_id,price_amount,gmt_deliver,gmt_confirm_received,gmt_closed,closed_detail,address,goods_name,logistics_info,logistics_company,logistics_no,delivery_user,delivery_phone)
        VALUES (
            NOW(),
            NOW(),
            #{userId},
            #{borrowId},
            #{orderNo},
            #{status},
            #{goodsId},
            #{priceAmount},
            #{gmtDeliver},
            #{gmtConfirmReceived},
            #{gmtClosed},
            #{closedDetail},
            #{address},
            #{goodsName},
            #{logisticsInfo},
            #{logisticsCompany},
            #{logisticsNo},
            #{deliveryUser},
            #{deliveryPhone},
      	)
    </insert>

	<insert id="saveBorrowLegalOrder" parameterType="com.ald.fanbei.api.dal.domain.AfBorrowLegalOrderDo" useGeneratedKeys="true" keyProperty="rid">
	        INSERT INTO af_borrow_legal_order(gmt_create,gmt_modified,user_id,borrow_id,order_no,status,goods_id,price_amount,gmt_deliver,gmt_confirm_received,gmt_closed,closed_detail,address,goods_name,logistics_info,logistics_company,logistics_no,delivery_user,delivery_phone)
	        VALUES (
	            NOW(),
	            NOW(),
	            #{userId},
	            #{borrowId},
	            #{orderNo},
	            #{status},
	            #{goodsId},
	            #{priceAmount},
	            #{gmtDeliver},
	            #{gmtConfirmReceived},
	            #{gmtClosed},
	            #{closedDetail},
	            #{address},
	            #{goodsName},
	            #{logisticsInfo},
	            #{logisticsCompany},
	            #{logisticsNo},
	            #{deliveryUser},
	            #{deliveryPhone},
	      	)
	    </insert>

	<insert id="saveRecord" parameterType="com.ald.fanbei.api.dal.domain.AfBorrowLegalOrderDo"
		keyProperty="rid">
		<selectKey resultType="java.lang.Long" keyProperty="rid"
			order="AFTER">
			SELECT LAST_INSERT_ID()
		</selectKey>

		INSERT INTO af_borrow_legal_order
		<trim prefix="(" suffix=")" suffixOverrides=",">
			<if test="gmtCreate != null">
				gmt_create,
			</if>
			<if test="gmtModified != null">
				gmt_modified,
			</if>
			<if test="userId != null">
				user_id,
			</if>
			<if test="borrowId != null">
				borrow_id,
			</if>
			<if test="orderNo != null">
				order_no,
			</if>
			<if test="status != null">
				status,
			</if>
			<if test="goodsId != null">
				goods_id,
			</if>
			<if test="priceAmount != null">
				price_amount,
			</if>
			<if test="gmtDeliver != null">
				gmt_deliver,
			</if>
			<if test="gmtConfirmReceived != null">
				gmt_confirm_received,
			</if>
			<if test="gmtClosed != null">
				gmt_closed,
			</if>
			<if test="closedDetail != null">
				closed_detail,
			</if>
			<if test="address != null">
				address,
			</if>
			<if test="goodsName != null">
				goods_name,
			</if>
			<if test="logisticsInfo != null">
				logistics_info,
			</if>
			<if test="logisticsCompany != null">
				logistics_company,
			</if>
			<if test="logisticsNo != null">
				logistics_no,
			</if>
			<if test="deliveryUser != null">
				delivery_user,
			</if>
			<if test="deliveryPhone != null">
				delivery_phone
			</if>
		</trim>

		<trim prefix="values (" suffix=")" suffixOverrides=",">
			<if test="gmtCreate != null">
				#{gmtCreate,jdbcType=TIMESTAMP},
			</if>
			<if test="gmtModified != null">
				#{gmtModified,jdbcType=TIMESTAMP},
			</if>
			<if test="userId != null">
				#{userId,jdbcType=INTEGER},
			</if>
			<if test="borrowId != null">
				#{borrowId,jdbcType=INTEGER},
			</if>
			<if test="orderNo != null">
				#{orderNo,jdbcType=VARCHAR},
			</if>
			<if test="status != null">
				#{status,jdbcType=VARCHAR},
			</if>
			<if test="goodsId != null">
				#{goodsId,jdbcType=INTEGER},
			</if>
			<if test="priceAmount != null">
				#{priceAmount,jdbcType=DECIMAL},
			</if>
			<if test="gmtDeliver != null">
				#{gmtDeliver,jdbcType=TIMESTAMP},
			</if>
			<if test="gmtConfirmReceived != null">
				#{gmtConfirmReceived,jdbcType=TIMESTAMP},
			</if>
			<if test="gmtClosed != null">
				#{gmtClosed,jdbcType=TIMESTAMP},
			</if>
			<if test="closedDetail != null">
				#{closedDetail,jdbcType=VARCHAR},
			</if>
			<if test="address != null">
				#{address,jdbcType=VARCHAR},
			</if>

			<if test="goodsName != null">
				#{goodsName,jdbcType=VARCHAR},
			</if>
			<if test="logisticsInfo != null">
				#{logisticsInfo,jdbcType=VARCHAR},
			</if>
			<if test="logisticsCompany != null">
				#{logisticsCompany,jdbcType=VARCHAR},
			</if>
			<if test="logisticsNo != null">
				#{logisticsNo,jdbcType=VARCHAR},
			</if>
			<if test="deliveryUser != null">
				#{deliveryUser,jdbcType=VARCHAR},
			</if>
			<if test="deliveryPhone != null">
				#{deliveryPhone,jdbcType=VARCHAR}
			</if>
		</trim>
	</insert>

	<update id="updateById" parameterType="com.ald.fanbei.api.dal.domain.AfBorrowLegalOrderDo">
		UPDATE af_borrow_legal_order
		<set>
			<if test="gmtCreate != null and gmtCreate != '' ">
				gmt_create = #{gmtCreate,jdbcType=TIMESTAMP},
			</if>
			<if test="gmtModified != null and gmtModified != '' ">
				gmt_modified = #{gmtModified,jdbcType=TIMESTAMP},
			</if>
			<if test="userId != null and userId != '' ">
				user_id = #{userId,jdbcType=INTEGER},
			</if>
			<if test="borrowId != null and borrowId != '' ">
				borrow_id = #{borrowId,jdbcType=INTEGER},
			</if>
			<if test="orderNo != null and orderNo != '' ">
				order_no = #{orderNo,jdbcType=VARCHAR},
			</if>
			<if test="status != null and status != '' ">
				status = #{status,jdbcType=VARCHAR},
			</if>
			<if test="goodsId != null and goodsId != '' ">
				goods_id = #{goodsId,jdbcType=INTEGER},
			</if>
			<if test="priceAmount != null and priceAmount != '' ">
				price_amount = #{priceAmount,jdbcType=DECIMAL},
			</if>
			<if test="gmtDeliver != null and gmtDeliver != '' ">
				gmt_deliver = #{gmtDeliver,jdbcType=TIMESTAMP},
			</if>
			<if test="gmtConfirmReceived != null and gmtConfirmReceived != '' ">
				gmt_confirm_received = #{gmtConfirmReceived,jdbcType=TIMESTAMP},
			</if>
			<if test="gmtClosed != null and gmtClosed != '' ">
				gmt_closed = #{gmtClosed,jdbcType=TIMESTAMP},
			</if>
			<if test="closedDetail != null and closedDetail != '' ">
				closed_detail = #{closedDetail,jdbcType=VARCHAR},
			</if>
			<if test="address != null and address != '' ">
				address = #{address,jdbcType=VARCHAR},
			</if>
			<if test="logisticsInfo != null">
				logistics_info=#{logisticsInfo,jdbcType=VARCHAR},
			</if>
			<if test="goodsName != null and goodsName != '' ">
				goods_name = #{goodsName,jdbcType=VARCHAR}
			</if>
		</set>
		WHERE is_delete = 0 AND id = #{rid ,jdbcType=BIGINT}
	</update>

	<select id="getById" resultType="com.ald.fanbei.api.dal.domain.AfBorrowLegalOrderDo">
		SELECT
		<include refid="queryFields" />
		FROM af_borrow_legal_order
		WHERE is_delete = 0 AND id=#{rid ,jdbcType=BIGINT}
		LIMIT 0,1
	</select>

	<select id="getByCommonCondition" resultType="com.ald.fanbei.api.dal.domain.AfBorrowLegalOrderDo"
		parameterType="com.ald.fanbei.api.dal.domain.AfBorrowLegalOrderDo">
		SELECT
		<include refid="queryFields" />
		FROM af_borrow_legal_order
		<include refid="commonCondition" />
		limit 0,1
	</select>

	<select id="getListByCommonCondition" resultType="com.ald.fanbei.api.dal.domain.AfBorrowLegalOrderDo"
		parameterType="com.ald.fanbei.api.dal.domain.AfBorrowLegalOrderDo">
		SELECT
		<include refid="queryFields" />
		FROM af_borrow_legal_order
		<include refid="commonCondition" />
	</select>

	<select id="getLastBorrowLegalOrderByBorrowId" parameterType="java.lang.Long"
		resultType="com.ald.fanbei.api.dal.domain.AfBorrowLegalOrderDo">
		SELECT
		<include refid="queryFields" />
		FROM
		af_borrow_legal_order
		WHERE
		is_delete = 0
		AND borrow_id = #{borrowId}
		AND status != 'CLOSED'
		ORDER BY
		gmt_create DESC
		LIMIT 1
	</select>
	
	<select id="getUserBorrowLegalOrderList" parameterType="AfBorrowLegalOrderQuery"
		resultType="com.ald.fanbei.api.dal.domain.AfBorrowLegalOrderDo">
		SELECT
		<include refid="queryFields" />
		FROM
		af_borrow_legal_order
		WHERE
		is_delete = 0
		AND user_id = #{userId}
		ORDER BY
		gmt_create DESC
	</select>
	
	<select id="getLastOrderByBorrowId" parameterType="java.lang.Long" resultType="com.ald.fanbei.api.dal.domain.AfBorrowLegalOrderDo">
		SELECT
		<include refid="queryFields" />
		FROM af_borrow_legal_order
		WHERE is_delete = 0
			AND borrow_id = #{borrowId}
			AND status IN ('AWAIT_DELIVER','DELIVERED','CONFIRM_RECEIVED')
		ORDER BY gmt_create DESC
		LIMIT 1
	</select>
	
	<select id="tuchByBorrowId" parameterType="java.lang.Long" resultType="java.lang.Long">
        SELECT id
        FROM af_borrow_legal_order
        WHERE borrow_id = #{borrowId}
            AND is_delete = 0
        ORDER BY id DESC
        LIMIT 1
    </select>

	<update id="updateSmartAddressScore" parameterType="com.ald.fanbei.api.dal.domain.AfBorrowLegalOrderDo">
		UPDATE af_borrow_legal_order SET smart_address_score=#{smartAddressScore} , gmt_modified=NOW() WHERE borrow_id= #{borrowId} AND order_no= #{orderNo}
	</update>
	
	<select id="getBorrowLegalOrderByBorrowId" parameterType="java.lang.Long"
		resultType="com.ald.fanbei.api.dal.domain.AfBorrowLegalOrderDo">
		SELECT
		<include refid="queryFields" />
		FROM
		af_borrow_legal_order
		WHERE
		is_delete = 0
		AND borrow_id = #{borrowId}
		LIMIT 1
	</select>
    
</mapper>
