<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ald.fanbei.api.dal.dao.AfModelH5ItemDao">
	<sql id="queryAllFields">

		id
		rid,gmt_create,gmt_modified,creator,modifier,type,model_id,item_icon,item_type,item_value,item_value2,sort
	</sql>
	
		<sql id="queryCategoryFields">

		a1.id rid,a1.is_delete,a1.gmt_create,a1.gmt_modified,a1.creator,a1.modifier,a1.type,a1.model_id,a1.item_icon,count(a2.id) item_type,a1.item_value, a1.item_value2,a1.sort
	</sql>
	
	<sql id="queryAllFields2">
	h.id rid,h.gmt_create,g.thumbnail_icon,g.id goods_id,g.price_amount,g.sale_amount,g.source,g.rebate_amount,g.rebate_rate,g.goods_url,g.num_id,g.name,g.goods_icon
	</sql>

	<select id="getModelH5ItemListByModelIdAndModelType" resultType="AfModelH5ItemDo">
		SELECT
		<include refid="queryAllFields" />
		FROM
			af_model_h5_item
		WHERE
			model_id = #{modelId}
		AND
			is_delete = 0
		AND
		type =#{type}
		order by

		sort desc
	</select>
	
	<select id="getModelH5ItemListByModelIdAndModelTypeSortById" resultType="AfModelH5ItemDo">
		SELECT
		<include refid="queryAllFields" />
		FROM
			af_model_h5_item
		WHERE
			model_id = #{modelId}
		AND
			is_delete = 0
		AND
		type =#{type}
		order by id
	</select>
	
	
	<select id="getModelH5ItemCategoryListByModelIdAndModelType" resultType="AfModelH5ItemDo">
		SELECT
		<include refid="queryCategoryFields" />
		FROM
			af_model_h5_item a1
		LEFT JOIN  
			af_model_h5_item a2 
		ON 
			a1.id = a2.item_value2  
		WHERE
			 a1.type ='CATEGORY' 
		AND 
			a1.model_id=#{modelId}
		AND
			a1.is_delete = 0
		GROUP BY a1.id
		ORDER BY
			a1.sort 
		desc
		
	</select>
	<select id="getModelH5ItemCategoryListByModelId" resultType="AfModelH5ItemDo">
		SELECT
		<include refid="queryAllFields" />
		FROM
		af_model_h5_item
		WHERE
		model_id = #{modelId}
		AND
		is_delete = 0
		AND
		type in ('CATEGORY','GOODSLIST')
		order by

			sort
		desc
	</select>
	
	
	<select id="getModelH5ItemGoodsCountListCountByModelIdAndSort" resultType="AfTypeCountDto">
		SELECT	 
			sort , count(sort) 
		FROM 
			af_model_h5_item 
		WHERE
			model_id = #{modelId}
		AND
			type ='GOODSLIST'
		AND
			is_delete = 0	
		GROUP BY
			sort
	</select>
	
	<select id="getModelH5ItemGoodsListCountByModelIdAndCategory" resultType="AfUserH5ItmeGoodsDto">
		SELECT	 
			<include refid="queryAllFields2" />
		FROM 
			af_model_h5_item h
		LEFT JOIN
			af_goods g
		ON
			 g.id = h.item_value
		WHERE
			
			h.model_id = #{modelId}
		AND
		    h.is_delete = 0 
		AND
			h.type ='GOODSLIST'		
		AND 
			h.item_value2 =#{category}
		ORDER BY 
			h.gmt_create DESC
		LIMIT #{start},#{end}
	</select>
		
	<select id="getModelH5ItemGoodsListCountByModelId" resultType="AfUserH5ItmeGoodsDto">
		SELECT	 
			<include refid="queryAllFields2" />
		FROM 
			af_model_h5_item h
		LEFT JOIN
			af_goods g
		ON
			 g.id = h.item_value
		WHERE
			
			h.model_id = #{modelId}
		AND
		    h.is_delete = 0 
		AND
			h.type ='GOODSLIST'	
		order by
			h.gmt_create
		desc	
		LIMIT #{start},#{end}
	</select>
	
	<select id="getModelH5ItemByGoodsId" resultType="AfModelH5ItemDo">
		SELECT
			<include refid = "queryAllFields" />
		FROM
			af_model_h5_item
		WHERE
			item_type = 'GOODS_ID'
		AND
			item_value = #{goodsId}
		AND
			is_delete = 0
	</select>
	<select id="getModelH5ItemForFirstSingleByGoodsId" resultType="AfModelH5ItemDo">
		SELECT
			i.id
		rid,i.gmt_create,i.gmt_modified,i.creator,i.modifier,i.type,i.model_id,i.item_icon,i.item_type,i.item_value,i.item_value2,i.sort
			 FROM af_model_h5  m
	        LEFT JOIN af_model_h5_item i 
	        ON m.id=i.model_id
	        WHERE m.tag = 'FIRST_SINGLE' 
	        AND m.is_delete = 0
	        AND i.item_type = 'GOODS_ID'
	        AND i.item_value = #{goodsId}
	        and i.is_delete = 0
	</select>
	
	<select id="selectModelByTag" resultType="AfModelH5ItemDo">
		select <include refid = "queryAllFields" /> from af_model_h5_item where model_id = (select id from af_model_h5  where  tag = 'HOMEPAGE') and type = 'CATEGORY' and is_delete = 0
	</select>


	<select id="getModelH5ItemCategoryByModelTag" resultType="AfModelH5ItemDo">
		SELECT
			<include refid = "queryAllFields" />
		FROM
			af_model_h5_item
		WHERE
		type = 'CATEGORY'
		and model_id =(
		select id from af_model_h5 where tag = #{tag} 
		and is_delete = 0
		limit 1
		)
	    ORDER BY sort DESC
	</select>


</mapper>
