<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ald.fanbei.api.dal.dao.AfBorrowBillDao">
	<sql id="queryFields">
		id rid,gmt_create,gmt_modified,user_id,borrow_id,borrow_no,name,gmt_borrow,bill_year,bill_month,nper,bill_nper,bill_amount,type,
		status,overdue_status,overdue_days,repayment_id,principle_amount,interest_amount,overdue_interest_amount,poundage_amount,overdue_poundage_amount
	</sql>
	
	<select id="getMonthBillList" resultType="AfBorrowBillDo" parameterType="AfBorrowBillQuery">
		SELECT 
			<include refid="queryFields"/>
		FROM af_borrow_bill WHERE is_delete = 0 AND user_id=#{userId} 
		AND bill_year = #{billYear} AND bill_month = #{billMonth}
    </select>
    
    <select id="getMonthlyBillByStatus" resultType="java.math.BigDecimal">
		SELECT 
			sum(bill_amount)
		FROM af_borrow_bill WHERE is_delete = 0 AND user_id=#{userId} 
		AND bill_year = #{billYear} AND bill_month = #{billMonth} AND status = #{status}
    </select>
	<select id="getUserFullBillList" resultType="AfBorrowTotalBillDo">
		SELECT 
		  bill_amount,
		  bill_year,
		  bill_month,
		  status
		FROM
		  af_borrow_total_bill 
		WHERE is_delete = 0 
		  AND user_id = #{userId}
		ORDER BY bill_year DESC,
		  bill_month DESC
    </select>
    
    <select id="getBorrowBillById" resultType="AfBorrowBillDo">
		SELECT 
			<include refid="queryFields"/>
		FROM af_borrow_bill WHERE is_delete = 0 AND id = #{rid}
    </select>
    
    <select id="getTotalMonthlyBillByUserId" resultType="AfBorrowBillDo">
		SELECT SUM(bill_amount) bill_amount,GROUP_CONCAT(id) bill_ids
		FROM af_borrow_bill
		WHERE is_delete=0 AND user_id = #{userId}
		AND bill_year=#{billYear} AND bill_month=#{billMonth} AND STATUS ='N'
    </select>
    
    <select id="getBillAmountByIds" resultType="AfBorrowBillDo">
		SELECT SUM(bill_amount) bill_amount,SUM(principle_amount) principle_amount,min(bill_year) bill_year,min(bill_month) bill_month,
		min(name) name,count(1) count
		FROM af_borrow_bill
		WHERE is_delete=0  AND STATUS ='N'
		AND id in (
		<foreach collection="ids" item="item" index="index" separator="," >
			#{item}
		</foreach>
		)
    </select>
    
    <update id="updateBorrowBillStatusByIds">
    	UPDATE 
		  af_borrow a,
		  af_borrow_bill b 
		SET
		  a.gmt_modified = NOW(),
		  b.gmt_modified = NOW(),
		  b.status = #{status},
		  b.repayment_id = #{repaymentId}
		  a.nper_repayment = a.nper_repayment + 1,
		  a.repay_prin_amount = a.repay_prin_amount + b.principle_amount 
		WHERE b.is_delete = 0 
		  AND a.is_delete = 0 
		  AND a.id = b.borrow_id
		AND b.id in (
		<foreach collection="ids" item="item" index="index" separator="," >
			#{item}
		</foreach>
		)
	</update>
    
    
    <update id="updateTotalBillStatus">
		update af_borrow_total_bill  set gmt_modified=NOW(),status=#{status}
		WHERE is_delete=0
		AND user_id=#{userId} AND bill_year=#{year} AND bill_month=#{month}
	</update>
    
    <select id="getUserMonthlyBillNotpayCount" resultType="java.lang.Integer">
		SELECT count(1)
		FROM af_borrow_bill
		WHERE is_delete=0  AND STATUS ='N' AND user_id=#{userId} AND bill_year=#{year} AND bill_month=#{month}
    </select>
    
    <select id="getBillAmountByCashIds" resultType="AfBorrowBillDo">
		SELECT SUM(b.bill_amount) bill_amount,SUM(b.principle_amount) principle_amount
		FROM af_borrow_bill b,af_borrow w
		WHERE b.is_delete=0 and w.is_delete=0 and b.borrow_id=w.id and (w.type = 'CASH' or w.type = 'TOCASH')
		AND b.id in (
		<foreach collection="ids" item="item" index="index" separator="," >
			#{item}
		</foreach>
		)
    </select>
</mapper>