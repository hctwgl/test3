<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ald.fanbei.api.dal.dao.AfBorrowBillDao">
	<sql id="queryFields">
		id rid,gmt_create,gmt_modified,user_id,borrow_id,borrow_no,name,gmt_borrow,bill_year,bill_month,nper,bill_nper,bill_amount,type,
		status,overdue_status,overdue_days,repayment_id,principle_amount,interest_amount,overdue_interest_amount,poundage_amount,overdue_poundage_amount,
		rebate_amount,is_free_interest
		
	</sql>
	
	<sql id="queryWithFields">
		b.id rid,b.gmt_create,b.gmt_modified,b.user_id,b.borrow_id,b.borrow_no,b.name,b.gmt_borrow,b.bill_year,b.bill_month,
		b.nper,b.bill_nper,b.bill_amount,b.type,b.status,b.overdue_status,b.overdue_days,b.repayment_id,b.principle_amount,b.interest_amount,
		b.rebate_amount,b.is_free_interest,
		b.overdue_interest_amount,b.poundage_amount,b.overdue_poundage_amount,w.order_id,w.order_no
	</sql>
	
	<select id="getMonthBillList" resultType="AfBorrowBillDo" parameterType="AfBorrowBillQuery">
		SELECT 
			<include refid="queryFields"/>
		FROM af_borrow_bill WHERE is_delete = 0 AND user_id=#{userId} 
		AND bill_year = #{billYear} AND bill_month = #{billMonth} AND status <![CDATA[<>'F']]>
    </select>
    
    <select id="getBillListByBorrowIdAndStatus" resultType="AfBorrowBillDo" >
		SELECT 
			<include refid="queryFields"/>
		FROM 
			af_borrow_bill 
		WHERE is_delete = 0 AND borrow_id = #{borrowId} 
		AND status = #{status}
    </select>
    
   	<select id="getBillListByIds" resultType="AfBorrowBillDo" parameterType="java.util.List">
   		SELECT 
			<include refid="queryFields"/>
		FROM 
			af_borrow_bill 
		WHERE 
			is_delete = 0 
		AND id IN
		<foreach collection="items" item="item" index="index" separator="," open="(" close=")">
			#{item}
		</foreach>
   	</select>
    
    <select id="getMonthlyBillByStatus" resultType="java.math.BigDecimal">
		SELECT 
			sum(bill_amount)
		FROM af_borrow_bill WHERE is_delete = 0 AND user_id=#{userId} 
		AND bill_year = #{billYear} AND bill_month = #{billMonth} AND status = #{status}
    </select>
	<select id="getUserFullBillList" resultType="AfBorrowTotalBillDo">
		SELECT 
		  bill_amount,
		  bill_year,
		  bill_month,
		  status
		FROM
		  af_borrow_total_bill 
		WHERE is_delete = 0 
		  AND user_id = #{userId}
		ORDER BY bill_year DESC,
		  bill_month DESC
    </select>
    
    <select id="getBorrowBillById" resultType="AfBorrowBillDo">
		SELECT 
			<include refid="queryFields"/>
		FROM af_borrow_bill WHERE is_delete = 0 AND id = #{rid}
    </select>
    
    <select id="getBorrowBillByBorrowId" resultType="java.math.BigDecimal">
		SELECT 
			sum(bill_amount) bill_amount
		FROM af_borrow_bill WHERE is_delete = 0 AND borrow_id = #{borrowId}
    </select>
    
    <select id="getBorrowBillDtoById" resultType="AfBorrowBillDto">
		SELECT 
			<include refid="queryWithFields"/>
		FROM af_borrow_bill b
		left join
			af_borrow w
		on w.is_delete=0 and w.id = b.borrow_id
		 WHERE b.is_delete = 0 AND b.id = #{rid}
    </select>
    
    <select id="getTotalMonthlyBillByUserId" resultType="AfBorrowBillDo">
		SELECT SUM(bill_amount) bill_amount,GROUP_CONCAT(id) bill_ids
		FROM af_borrow_bill
		WHERE is_delete=0 AND user_id = #{userId}
		AND bill_year=#{billYear} AND bill_month=#{billMonth} AND STATUS ='N'
    </select>
    
    <select id="getBillAmountByIds" resultType="AfBorrowBillDo">
		SELECT SUM(bill_amount) bill_amount,SUM(principle_amount) principle_amount,min(bill_year) bill_year,min(bill_month) bill_month,min(type) type,
		min(borrow_no) borrow_no,min(name) name,count(1) count
		FROM af_borrow_bill
		WHERE is_delete=0  AND STATUS ='N'
		AND id in (
		<foreach collection="ids" item="item" index="index" separator="," >
			#{item}
		</foreach>
		)
    </select>
    
    <update id="updateBorrowBillStatusByIds">
    	UPDATE 
		  af_borrow a,
		  af_borrow_bill b 
		SET
		  a.gmt_modified = NOW(),
		  b.gmt_modified = NOW(),
		  b.status = #{status},
		  b.repayment_id = #{repaymentId},
		  a.nper_repayment = a.nper_repayment + 1,
		  a.repay_prin_amount = a.repay_prin_amount + b.principle_amount 
		WHERE b.is_delete = 0 
		  AND a.is_delete = 0 
		  AND a.id = b.borrow_id
		AND b.id in (
		<foreach collection="ids" item="item" index="index" separator="," >
			#{item}
		</foreach>
		)
	</update>
    
    <update id="updateBorrowBillStatusById">
    	UPDATE 
		  af_borrow a,
		  af_borrow_bill b 
		SET
		  a.gmt_modified = NOW(),
		  b.gmt_modified = NOW(),
		  b.status = #{status},
		  b.repayment_id = #{repaymentId},
		  b.coupon_amount = #{couponAmount},
		  b.jfb_amount = #{jfbAmount},
		  b.rebate_amount = #{rebateAmount},
		  a.nper_repayment = a.nper_repayment + 1,
		  a.repay_prin_amount = a.repay_prin_amount + b.principle_amount 
		WHERE b.is_delete = 0 
		  AND a.is_delete = 0 
		  AND a.id = b.borrow_id
		  AND b.id = #{id}
	</update>   
 
    <update id="updateTotalBillStatus">
		update af_borrow_total_bill  set gmt_modified=NOW(),status=#{status}
		WHERE is_delete=0
		AND user_id=#{userId} AND bill_year=#{year} AND bill_month=#{month}
	</update>
    
    <select id="getUserMonthlyBillNotpayCount" resultType="java.lang.Integer">
		SELECT count(1)
		FROM af_borrow_bill
		WHERE is_delete=0  AND STATUS ='N' AND user_id=#{userId} AND bill_year=#{year} AND bill_month=#{month}
    </select> 
    
    <select id="getUserMonthlyBillTotalCount" resultType="java.lang.Integer">
		SELECT count(1)
		FROM af_borrow_bill
		WHERE is_delete=0 AND user_id=#{userId} AND bill_year=#{year} AND bill_month=#{month} AND STATUS !='F'
    </select>
    
    <select id="getBorrowBillWithNoPayByUserId" resultType="java.lang.Integer">
		SELECT count(1)
		FROM af_borrow_bill
		WHERE is_delete=0 AND status='N' AND user_id=#{userId}
    </select>
    
    <update id="updateNotRepayedBillStatus" >
    	UPDATE 
		  af_borrow_bill 
		SET
		  gmt_modified = NOW(),
		  status = #{status}
		WHERE 
		  is_delete = 0 
		  AND borrow_id = #{borrowId}
		  AND status = 'N'
    </update>
    
    <update id="updateBorrowBillStatusByBorrowId" >
    	UPDATE 
		  af_borrow_bill 
		SET
		  gmt_modified = NOW(),
		  status = #{status}
		WHERE 
		  is_delete = 0 
		  AND borrow_id = #{borrowId}
    </update>
    
    <select id="getBillAmountByCashIds" resultType="AfBorrowBillDo">
		SELECT SUM(b.bill_amount) bill_amount,SUM(b.principle_amount) principle_amount
		FROM af_borrow_bill b
		WHERE b.is_delete=0 and b.type='CASH'
		AND b.id in (
		<foreach collection="ids" item="item" index="index" separator="," >
			#{item}
		</foreach>
		)
    </select>

	<select id="getAllBorrowBillByBorrowId" resultType="AfBorrowBillDo">
		SELECT
		<include refid="queryFields"/>
		FROM
		af_borrow_bill
		WHERE is_delete = 0
		AND borrow_id = #{borrowId}
	</select>
    
    <select id="getPaidBillNumByBorrowId" resultType="java.lang.Integer">
		select count(1) from `af_borrow_bill` WHERE `status` ='Y' and `borrow_id` = #{borrowId}; 
	</select>
	
	<select id="getSumIncomeByBorrowId" resultType="java.math.BigDecimal">
		select IFNULL(sum(interest_amount+overdue_interest_amount+poundage_amount+overdue_poundage_amount),0) income FROM af_borrow_bill WHERE status ='Y' and borrow_id=#{borrowId};
    </select>
    
    <select id="getSumOverdueDayByBorrowId" resultType="java.lang.Long">
		select IFNULL(sum(overdue_days),0) FROM af_borrow_bill WHERE status ='Y' and overdue_status='Y' and borrow_id= #{borrowId}; 
	</select>
	
</mapper>