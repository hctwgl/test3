<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- af_sup_order表:游戏充值模块 -->
<mapper namespace="com.ald.fanbei.api.dal.dao.AfSupOrderDao">
    
    <!--基本的sql查询字段 公共引用...-->
    <sql id="queryFields">
        id rid,gmt_create,gmt_modified,order_no,goods_id,goods_code,acct_type,game_name,user_name,goods_num,game_type,game_acct,game_area,game_srv,user_ip ,msg
    </sql>
    
    <!-- 基本的sql查询条件公共引用 -->
    <sql id="commonCondition">
    	WHERE is_delete = 0
        <if test="rid !=null">
            AND id  = #{rid,jdbcType=INTEGER}
        </if>
        <if test="gmtCreate !=null">
            AND gmt_create = #{gmtCreate,jdbcType=TIMESTAMP}
        </if>
        <if test="gmtModified !=null">
            AND gmt_modified = #{gmtModified,jdbcType=TIMESTAMP}
        </if>
        <if test="orderNo != null and orderNo != ''">
            AND order_no = #{orderNo,jdbcType=VARCHAR}
        </if>
        <if test="goodsId != null and goodsId != ''">
            AND goods_id = #{goodsId,jdbcType=INTEGER}
        </if>
        <if test="goodsCode != null and goodsCode != ''">
            AND goods_code = #{goodsCode,jdbcType=VARCHAR}
        </if>
        <if test="acctType != null and acctType != ''">
            AND acct_type = #{acctType,jdbcType=VARCHAR}
        </if>
        <if test="gameName != null and gameName != ''">
            AND game_name = #{gameName,jdbcType=VARCHAR}
        </if>
        <if test="userName != null and userName != ''">
            AND user_name = #{userName,jdbcType=VARCHAR}
        </if>
        <if test="goodsNum != null and goodsNum != ''">
            AND goods_num = #{goodsNum,jdbcType=INTEGER}
        </if>
        <if test="gameType != null and gameType != ''">
            AND game_type = #{gameType,jdbcType=VARCHAR}
        </if>
        <if test="gameAcct != null and gameAcct != ''">
            AND game_acct = #{gameAcct,jdbcType=VARCHAR}
        </if>
        <if test="gameArea != null and gameArea != ''">
            AND game_area = #{gameArea,jdbcType=VARCHAR}
        </if>
        <if test="gameSrv != null and gameSrv != ''">
            AND game_srv = #{gameSrv,jdbcType=VARCHAR}
        </if>
        <if test="userIp != null and userIp != ''">
            AND user_ip = #{userIp,jdbcType=VARCHAR}
        </if>
        <if test="msg != null and msg != ''">
            AND msg = #{msg,jdbcType=VARCHAR}
        </if>
    </sql>

    
    <insert id="saveRecord" parameterType="com.ald.fanbei.api.dal.domain.AfSupOrderDo" keyProperty="rid">
    	<selectKey resultType="java.lang.Long" keyProperty="rid" order="AFTER" >
	      SELECT LAST_INSERT_ID()
	    </selectKey>
    
        INSERT INTO af_sup_order
        <trim prefix="(" suffix=")" suffixOverrides="," >
	        <if test="gmtCreate != null">        
	            gmt_create,
	        </if>
	        <if test="gmtModified != null">        
	            gmt_modified,
	        </if>
	        <if test="orderNo != null">        
	            order_no,
	        </if>
	        <if test="goodsId != null">        
	            goods_id,
	        </if>
	        <if test="goodsCode != null">        
	            goods_code,
	        </if>
	        <if test="acctType != null">        
	            acct_type,
	        </if>
	        <if test="gameName != null">        
	            game_name,
	        </if>
	        <if test="userName != null">        
	            user_name,
	        </if>
	        <if test="goodsNum != null">        
	            goods_num,
	        </if>
	        <if test="gameType != null">        
	            game_type,
	        </if>
	        <if test="gameAcct != null">        
	            game_acct,
	        </if>
	        <if test="gameArea != null">        
	            game_area,
	        </if>
	        <if test="gameSrv != null">        
	            game_srv,
	        </if>
	        <if test="userIp != null">        
	            user_ip,
	        </if>
	        <if test="msg != null">        
	            msg,
	        </if>
        </trim>
        
        <trim prefix="values (" suffix=")" suffixOverrides="," >
		    <if test="gmtCreate != null" >
		       #{gmtCreate,jdbcType=TIMESTAMP},
		    </if>
		    <if test="gmtModified != null" >
		       #{gmtModified,jdbcType=TIMESTAMP},
		    </if>
		    <if test="orderNo != null" >
		       #{orderNo,jdbcType=VARCHAR},
		    </if>
		    <if test="goodsId != null" >
		       #{goodsId,jdbcType=INTEGER},
		    </if>
		    <if test="goodsCode != null" >
		       #{goodsCode,jdbcType=VARCHAR},
		    </if>
		    <if test="acctType != null" >
		       #{acctType,jdbcType=VARCHAR},
		    </if>
		    <if test="gameName != null" >
		       #{gameName,jdbcType=VARCHAR},
		    </if>
		    <if test="userName != null" >
		       #{userName,jdbcType=VARCHAR},
		    </if>
		    <if test="goodsNum != null" >
		       #{goodsNum,jdbcType=INTEGER},
		    </if>
		    <if test="gameType != null" >
		       #{gameType,jdbcType=VARCHAR},
		    </if>
		    <if test="gameAcct != null" >
		       #{gameAcct,jdbcType=VARCHAR},
		    </if>
		    <if test="gameArea != null" >
		       #{gameArea,jdbcType=VARCHAR},
		    </if>
		    <if test="gameSrv != null" >
		       #{gameSrv,jdbcType=VARCHAR},
		    </if>
		    <if test="userIp != null" >
		       #{userIp,jdbcType=VARCHAR},
		    </if>
		    <if test="msg != null" >
		       #{msg,jdbcType=VARCHAR},
		    </if>
        </trim>
    </insert>
    
    <update id="updateById"  parameterType="com.ald.fanbei.api.dal.domain.AfSupOrderDo">
        UPDATE af_sup_order
          <set>
            <if test="gmtCreate != null and gmtCreate != '' ">        
                gmt_create = #{gmtCreate,jdbcType=TIMESTAMP},                
            </if>
            <if test="gmtModified != null and gmtModified != '' ">        
                gmt_modified = #{gmtModified,jdbcType=TIMESTAMP},                
            </if>
            <if test="orderNo != null and orderNo != '' ">        
                order_no = #{orderNo,jdbcType=VARCHAR},                
            </if>
            <if test="goodsId != null and goodsId != '' ">        
                goods_id = #{goodsId,jdbcType=INTEGER},                
            </if>
            <if test="goodsCode != null and goodsCode != '' ">        
                goods_code = #{goodsCode,jdbcType=VARCHAR},                
            </if>
            <if test="acctType != null and acctType != '' ">        
                acct_type = #{acctType,jdbcType=VARCHAR},                
            </if>
            <if test="gameName != null and gameName != '' ">        
                game_name = #{gameName,jdbcType=VARCHAR},                
            </if>
            <if test="userName != null and userName != '' ">        
                user_name = #{userName,jdbcType=VARCHAR},                
            </if>
            <if test="goodsNum != null and goodsNum != '' ">        
                goods_num = #{goodsNum,jdbcType=INTEGER},                
            </if>
            <if test="gameType != null and gameType != '' ">        
                game_type = #{gameType,jdbcType=VARCHAR},                
            </if>
            <if test="gameAcct != null and gameAcct != '' ">        
                game_acct = #{gameAcct,jdbcType=VARCHAR},                
            </if>
            <if test="gameArea != null and gameArea != '' ">        
                game_area = #{gameArea,jdbcType=VARCHAR},                
            </if>
            <if test="gameSrv != null and gameSrv != '' ">        
                game_srv = #{gameSrv,jdbcType=VARCHAR},                
            </if>
            <if test="userIp != null and userIp != '' ">        
                user_ip = #{userIp,jdbcType=VARCHAR}                
            </if>
             <if test="msg != null and msg != '' " >
		       #{msg,jdbcType=VARCHAR},
		    </if>
        </set>    
        WHERE is_delete = 0 AND id = #{rid ,jdbcType=BIGINT}
    </update>

	<select id="getById" resultType="com.ald.fanbei.api.dal.domain.AfSupOrderDo">
        SELECT
        <include refid="queryFields" />
        FROM af_sup_order
        WHERE is_delete = 0 AND id=#{rid ,jdbcType=BIGINT}
        LIMIT 0,1
    </select>

	<select id="getByCommonCondition" resultType="com.ald.fanbei.api.dal.domain.AfSupOrderDo" parameterType="com.ald.fanbei.api.dal.domain.AfSupOrderDo">
        SELECT
        <include refid="queryFields" />
        FROM af_sup_order
        <include refid="commonCondition"/> 
        limit 0,1
    </select>
               
    <select id="getListByCommonCondition" resultType="com.ald.fanbei.api.dal.domain.AfSupOrderDo" parameterType="com.ald.fanbei.api.dal.domain.AfSupOrderDo">
        SELECT
        <include refid="queryFields" />
        FROM af_sup_order
        <include refid="commonCondition"/>
    </select>
    
    <select id="getByOrderNo" resultType="com.ald.fanbei.api.dal.domain.AfSupOrderDo">
        SELECT
        <include refid="queryFields" />
        FROM af_sup_order
        WHERE is_delete = 0 AND order_no = #{orderNo,jdbcType=VARCHAR}
    </select>
    
    <update id="updateMsgByOrder"  parameterType="com.ald.fanbei.api.dal.domain.AfSupOrderDo">
        UPDATE af_sup_order 
        set msg = #{msg,jdbcType=VARCHAR}   
        WHERE order_no = #{orderNo ,jdbcType=VARCHAR}
    </update>
    
    <select id="getOrderInfoByOrderNo" resultType="com.ald.fanbei.api.dal.domain.dto.GameOrderInfoDto">
    	SELECT 
			o.id as orderId, s.order_no as orderNo,UNIX_TIMESTAMP(s.gmt_create) as gmtCreate,UNIX_TIMESTAMP(o.gmt_rebated) as gmtRebated,
			UNIX_TIMESTAMP(o.gmt_closed) as gmtClosed,UNIX_TIMESTAMP(o.gmt_pay) as gmtPay, 
			o.`status` as orderStatus, g.type as orderType,g.image as goodsIcon,s.game_name as goodsName,
			s.goods_num as goodsCount,s.acct_type as acctType,s.user_name as userName,s.game_type as gameType,
			s.game_acct as gameAcct,s.game_area as gameArea,s.game_srv as gameSrv,o.sale_amount as orderAmount,
			o.rebate_amount as rebateAmount,o.coupon_amount as couponAmount, o.actual_amount as actualAmount,
			UNIX_TIMESTAMP(o.gmt_pay_end) as gmtPayEnd
		from af_order o 
			JOIN af_sup_order s on o.order_no = s.order_no 
			JOIN af_sup_game g on s.goods_id = g.id
		where s.order_no = #{orderNo ,jdbcType=VARCHAR};
    </select>
</mapper>
