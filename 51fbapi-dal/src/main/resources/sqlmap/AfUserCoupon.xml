<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ald.fanbei.api.dal.dao.AfUserCouponDao">
	<sql id="queryAllFields">
		u.id rid,u.gmt_create,u.gmt_modified,u.user_id,u.coupon_id,u.gmt_start,u.gmt_end,
		u.status,u.gmt_use,u.source_type,c.amount,c.limit_amount,c.name,c.use_rule,c.type,c.valid_days,c.use_range
	</sql>
	
	<sql id="queryAllUserCouponFields">
		u.id rid,u.gmt_create,u.gmt_modified,u.user_id,u.coupon_id,u.gmt_start,u.gmt_end,
		u.status,u.gmt_use,u.source_type
	</sql>
	<insert id="addUserCoupon" parameterType="AfUserCouponDo" keyProperty="rid" useGeneratedKeys="true">
		INSERT INTO af_user_coupon
		(
			gmt_create,
			gmt_modified,
			user_id,
			coupon_id,
			gmt_start,
			gmt_end,
			status,
			source_type
		)
		VALUES
		(
			NOW(),
			NOW(),
			#{userId},
			#{couponId},
			#{gmtStart},
			#{gmtEnd},
			#{status},
			#{sourceType}
		)
	</insert>
	
	<select id="getUserCouponByUser" resultType="AfUserCouponDto">
		SELECT 
			<include refid="queryAllFields" />
		FROM 
			af_user_coupon u
		LEFT JOIN
			af_coupon c
		ON
			c.is_delete = 0 and u.coupon_id = c.id
		WHERE
			u.is_delete = 0 
		AND
			u.user_id = #{userId}	
		<if test="status != null and status !=''">
			and u.status = #{status}
		</if>
		ORDER BY u.gmt_end
	</select>
	
	

	<!-- 可使用优惠券 -->
	<select id="getUserCouponByUserNouse" parameterType="java.lang.Long" resultType="java.lang.Integer">
		SELECT 
			count(1)
		FROM 
			af_user_coupon
		WHERE
			is_delete = 0 
		AND
			user_id = #{userId}
		AND
			status = 'NOUSE'
	</select>
	
	
	<!-- 可使用优惠券 -->
	<select id="getUserCouponByInvite" parameterType="java.lang.Long" resultType="java.math.BigDecimal">
		SELECT 
			 sum(c.amount)
		FROM 
			af_user_coupon uc,af_coupon c
		WHERE
			uc.is_delete = 0 
		AND
			c.is_delete = 0 
		AND
			uc.coupon_id = c.id
		AND
			uc.user_id = #{userId}
		AND
			uc.source_type = 'INVITE'
	</select>
	
	
	<select id="getUserCouponByUserIdAndCouponId"  resultType="java.lang.Integer">
		SELECT 
			count(id)
		FROM 
			af_user_coupon
		WHERE
			is_delete = 0 
		AND
			user_id = #{userId}	
		AND
			coupon_id = #{couponId}
	</select>
	
	<select id="getUserCouponByDo" parameterType="AfUserCouponDto"  resultType="AfUserCouponDto">
		SELECT 
			<include refid="queryAllUserCouponFields" />
		FROM 
			af_user_coupon u
		WHERE
			u.is_delete = 0 
		AND
			u.user_id = #{userId}	
		AND
			u.coupon_id = #{couponId}
		AND
		    u.status = 'NOUSE'
		AND
			now() between u.gmt_start and u.gmt_end
		LIMIT 1
	</select>
	
	
	<select id="getUserCouponById" resultType="AfUserCouponDto">
		SELECT 
			<include refid="queryAllFields" />
		FROM 
			af_user_coupon u
		LEFT JOIN
			af_coupon c
		ON
			c.is_delete = 0 and u.coupon_id = c.id
		WHERE
			u.is_delete = 0 
		AND
			u.id = #{rid}
	</select>
	
	<update id="updateUserCouponSatusUsedById" parameterType="java.lang.Long">
		UPDATE
			af_user_coupon
		SET
			is_delete = 0,
			status = 'USED',
			gmt_use = NOW()
		WHERE
			is_delete = 0
		AND
			id = #{rid}
	</update>
	<update id="updateUserCouponSatusExpireById" parameterType="java.lang.Long">
		UPDATE
			af_user_coupon
		SET
			is_delete = 0,
			status = 'EXPIRE',
			gmt_use = NOW()
		WHERE
			is_delete = 0
		AND
			id = #{rid}
	</update>
	<update id="updateUserCouponSatusNouseById" parameterType="java.lang.Long">
		UPDATE
			af_user_coupon
		SET
			is_delete = 0,
			status = 'NOUSE',
			gmt_use = NOW()
		WHERE
			is_delete = 0
		AND
			id = #{rid}
	</update>
	
	<select id="getUserCouponByUserIdAndType" resultType="AfUserCouponDto">
		SELECT 
			<include refid="queryAllFields" />
		FROM 
			af_user_coupon u
		LEFT JOIN
			af_coupon c
		ON
			c.is_delete = 0 and u.coupon_id = c.id
		WHERE
			u.is_delete = 0 
		AND
			u.user_id = #{userId}
		AND (NOW() BETWEEN u.gmt_start AND u.gmt_end) 
		AND
		 	c.limit_amount<![CDATA[ <=#{amount}  ]]>
		AND
		    (c.type = #{type} or c.type='COMMON')
		AND
		    u.status = 'NOUSE'
		order by c.amount desc
	</select>
	<select id="getUserCouponByType" resultType="AfUserCouponDto">
		SELECT 
			<include refid="queryAllFields" />
		FROM 
			af_user_coupon u
		LEFT JOIN
			af_coupon c
		ON
			c.is_delete = 0 and u.coupon_id = c.id
		WHERE
			u.is_delete = 0 
		AND
			u.user_id = #{userId}
		AND
		    (c.type = #{type} or c.type='COMMON')
		AND
		    u.status = 'NOUSE'
		AND
			now() between u.gmt_start and u.gmt_end
		order by c.amount desc
	</select>
	
	<select id="getUserAcgencyCouponByAmount" resultType="AfUserCouponDto">
			SELECT 
			    CASE
			        WHEN 48 > TIMESTAMPDIFF(HOUR, NOW(), uc.gmt_end)  THEN 'Y'  ELSE 'N' 
			    END AS will_expire_status,
			    uc.id rid, c.limit_amount, c.amount, c.name, c.use_rule, c.type, uc.status, uc.gmt_start, uc.gmt_end ,c.use_range
			FROM
			    af_user_coupon uc LEFT JOIN
			    af_coupon c  ON uc.coupon_id = c.id
			WHERE uc.user_id = #{userId} AND c.type = 'FULLVOUCHER' 
			    AND uc.status = 'NOUSE' 
			    AND uc.is_delete = 0 
			    AND c.is_delete = 0 
			    AND (NOW() BETWEEN uc.gmt_start 
			    AND uc.gmt_end) 
			    AND #{amount} >=  c.limit_amount
			    AND c.is_global = 0
			ORDER BY c.amount DESC 
			LIMIT 50
	</select>
	
	<select id="getSubjectUserCouponByAmountAndCouponId" resultType="AfUserCouponDto">
			SELECT 
			    CASE
			        WHEN 48 > TIMESTAMPDIFF(HOUR, NOW(), uc.gmt_end)  THEN 'Y'  ELSE 'N' 
			    END AS will_expire_status,
			    uc.id rid, c.limit_amount, c.amount, c.name, c.use_rule, c.type, uc.status, uc.gmt_start, uc.gmt_end,c.use_range 
			FROM
			    af_user_coupon uc LEFT JOIN
			    af_coupon c  ON uc.coupon_id = c.id
			WHERE uc.user_id = #{userId} AND c.type = 'FULLVOUCHER' 
			    AND uc.status = 'NOUSE' 
			    AND uc.is_delete = 0 
			    AND c.is_delete = 0 
			    AND (NOW() BETWEEN uc.gmt_start 
			    AND uc.gmt_end) 
			    AND #{amount} >=  c.limit_amount
			    AND c.is_global = 1
			    AND c.id=#{couponId}
	</select>
	
	<select id="getUserAcgencyCountByAmount" resultType="java.lang.Integer">
		SELECT 
			COUNT(uc.id)
		from af_user_coupon uc ,af_coupon c
		WHERE c.type='FULLVOUCHER' and uc.coupon_id =c.id and uc.user_id = #{userId}
		AND uc.status ='NOUSE' AND uc.is_delete = 0 AND c.is_delete =0 and  NOW() BETWEEN uc.gmt_start AND uc.gmt_end
		AND c.limit_amount<![CDATA[ <=#{amount}  ]]>
		ORDER BY c.amount DESC
		
	</select>
	
	<select id="getUserCouponByUserIdAndSourceType" resultType="AfUserCouponDto">
		SELECT
			<include refid="queryAllFields"/>
		FROM 
			af_user_coupon u
		LEFT JOIN
			af_coupon c
		ON
			c.is_delete = 0 and u.coupon_id = c.id
		WHERE
			u.is_delete = 0 
		AND
			u.user_id = #{userId}
		AND
		    u.source_type = #{sourceType} 
	</select>
	
	<insert id="batchAddUserCoupon" parameterType="list" >
		INSERT INTO af_user_coupon 
		(
			gmt_create,
			gmt_modified,
			user_id,
			coupon_id,
			gmt_start,
			gmt_end,
			status,
			source_type
		)
   		values 
    	<foreach collection="userCouponList" item="item" index="index" separator="," > 
        	(
			NOW(),
			NOW(),
			#{item.userId},
			#{item.couponId},
			#{item.gmtStart},
			#{item.gmtEnd},
			#{item.status},
			#{item.sourceType}
		)
    	</foreach> 	
	</insert>

	<select id="getUserCouponListByUserIdAndCouponId" resultType="AfUserCouponDto">
		SELECT 
			<include refid="queryAllUserCouponFields" />
		FROM 
			af_user_coupon u
		WHERE
			is_delete = 0 
		AND
			u.user_id = #{userId}	
		AND
			u.coupon_id = #{couponId}
	</select>

</mapper>