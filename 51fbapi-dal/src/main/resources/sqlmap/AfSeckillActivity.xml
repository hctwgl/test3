<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- af_seckill_activity表 -->
<mapper namespace="com.ald.fanbei.api.dal.dao.AfSeckillActivityDao">
    
    <!--基本的sql查询字段 公共引用...-->
    <sql id="queryFields">
        id rid,gmt_create,gmt_modified,name,type,icon_url,gmt_start,gmt_end,bg_color,goods_count,status,is_disable,discount_type,discount,subtract_price,creator,modifier
    </sql>
    <select id="getById" resultType="AfSeckillActivityDo">
        SELECT
        <include refid="queryFields" />
        FROM af_seckill_activity
        WHERE is_delete = 0 AND id=#{activityId ,jdbcType=BIGINT}
        LIMIT 0,1
    </select>
	<select id="getActivityByGoodsId" resultType="AfSeckillActivityDo" parameterType="java.lang.Long">
        SELECT
        a.id rid,a.name,a.type,a.gmt_start,a.gmt_end,a.gmt_pstart,a.goods_limit_count,a.pay_type,now() nowDate
        FROM af_seckill_activity a LEFT JOIN af_seckill_activity_goods b
        ON (a.id=b.activity_id)
        WHERE a.is_delete = 0 AND a.is_disable=0 AND b.is_delete=0 AND b.goods_id=#{goodsId ,jdbcType=BIGINT}
        AND a.gmt_pstart <![CDATA[<=]]> now() AND a.gmt_end <![CDATA[>=]]> now()
        ORDER BY a.gmt_create DESC limit 1
    </select>
    <select id="getStartActivityByPriceId" resultType="AfSeckillActivityDo" parameterType="java.lang.Long">
        SELECT
        a.id rid,a.name,a.type,a.gmt_start,a.gmt_end,a.gmt_pstart,a.goods_limit_count,a.pay_type
        FROM af_seckill_activity a LEFT JOIN af_seckill_activity_goods b
        ON (a.id=b.activity_id)
        WHERE a.is_delete = 0 AND a.is_disable=0 AND b.is_delete=0 AND b.type=2 AND b.price_id=#{goodsPriceId ,jdbcType=BIGINT}
        AND a.gmt_start <![CDATA[<=]]> now() AND a.gmt_end <![CDATA[>=]]> now()
        ORDER BY a.gmt_create DESC limit 1
    </select>

    <select id="getActivityById" resultType="AfSeckillActivityDo" parameterType="java.lang.Long">
        SELECT
        a.id rid,a.name,a.type,a.gmt_start,a.gmt_end,a.gmt_pstart,
        a.close_time,a.goods_limit_count,a.type
        FROM af_seckill_activity a
        WHERE a.is_delete = 0 AND a.is_disable=0 AND a.id=#{activityId ,jdbcType=BIGINT}
        AND a.gmt_start <![CDATA[<=]]> now() AND a.gmt_end <![CDATA[>=]]> now()
        limit 1
    </select>

    <select id="getStartActivityByGoodsId" resultType="AfSeckillActivityDo" parameterType="java.lang.Long">
        SELECT
        a.id rid,a.name,a.type,a.gmt_start,a.gmt_end,a.gmt_pstart,a.goods_limit_count,a.pay_type
        FROM af_seckill_activity a LEFT JOIN af_seckill_activity_goods b
        ON (a.id=b.activity_id)
        WHERE a.is_delete = 0 AND a.is_disable=0 AND b.is_delete=0 AND b.type=2 AND b.goods_id=#{goodsId ,jdbcType=BIGINT}
        AND a.gmt_start <![CDATA[<=]]> now() AND a.gmt_end <![CDATA[>=]]> now()
        ORDER BY a.gmt_create DESC limit 1
    </select>

    <select id="getActivityList" resultType="AfSeckillActivityDo" parameterType="AfSeckillActivityQuery">
        SELECT
        a.id rid,a.name,a.type,a.gmt_start,a.gmt_end,a.gmt_pstart,a.goods_limit_count,a.pay_type
        FROM af_seckill_activity a
        WHERE a.is_delete = 0 AND a.is_disable=0
        <if test="type != null and type != ''">
            AND a.type= #{type}
        </if>
        <if test="name != null and name != ''">
            AND a.name like CONCAT('%',#{name}, '%')
        </if>
        <if test="gmtStart != null and gmtStart != ''">
            AND a.gmt_pstart <![CDATA[>=]]> #{gmtStart}
        </if>
        <if test="gmtEnd != null and gmtEnd != ''">
            AND a.gmt_end <![CDATA[<=]]> #{gmtEnd}
        </if>
        <if test="gmtStart == null and gmtEnd == null">
            AND a.gmt_pstart <![CDATA[<=]]> now() AND a.gmt_end <![CDATA[>=]]> now()
        </if>
        ORDER BY a.gmt_start ASC
    </select>

    <select id="getActivityListByName" resultType="java.lang.String" parameterType="java.lang.String">
        SELECT a.id FROM af_seckill_activity a
          WHERE a.is_delete = 0 AND a.is_disable=0
            AND a.name like CONCAT(#{name}, '%')
        <if test="gmtStart != null and gmtStart != ''">
            AND a.gmt_pstart <![CDATA[>=]]> #{gmtStart}
        </if>
        <if test="gmtEnd != null and gmtEnd != ''">
            AND a.gmt_end <![CDATA[<=]]> #{gmtEnd}
        </if>
        ORDER BY a.name
    </select>



</mapper>
