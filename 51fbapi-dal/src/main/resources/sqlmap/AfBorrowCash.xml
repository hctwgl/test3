<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ald.fanbei.api.dal.dao.AfBorrowCashDao">
	<sql id="queryFields">
		id
		rid,gmt_create,gmt_modified,borrow_no,user_id,type,amount,status,remark,card_number,card_name,overdue_day,
		overdue_amount,arrival_amount,gmt_arrival,review_name,review_user_name,review_details,gmt_review,poundage,rate_amount,repay_amount,latitude,longitude,province,city,county,overdue_status,review_status,address,gmt_close,rish_order_no,
		gmt_plan_repayment,sum_rate,sum_overdue,sum_jfb,sum_rebate,sum_renewal_poundage,renewal_num,poundage_rate,base_bank_rate,majiabao_name,risk_daily_rate
	</sql>

	<insert id="addBorrowCash" parameterType="AfBorrowCashDo"
		useGeneratedKeys="true" keyProperty="rid">
		INSERT INTO
		af_borrow_cash(gmt_create , gmt_modified , borrow_no , user_id , type,
		amount , status , card_number , card_name , poundage , rate_amount ,
		latitude , longitude , province ,arrival_amount, city , county,
		address, poundage_rate, base_bank_rate
		<if test="majiabaoName != null">
			,majiabao_name
		</if>
		<if test="riskDailyRate != null">
			,risk_daily_rate
		</if>
		)
		VALUES (
		NOW(),
		NOW(),
		#{borrowNo},
		#{userId},
		#{type},
		#{amount},
		#{status},
		#{cardNumber},
		#{cardName},
		#{poundage},
		#{rateAmount},
		#{latitude},
		#{longitude},
		#{province},
		#{arrivalAmount},
		#{city},
		#{county},
		#{address},
		#{poundageRate},
		#{baseBankRate}
		<if test="majiabaoName != null">
			,#{majiabaoName}
		</if>
		<if test="riskDailyRate != null">
			,#{riskDailyRate}
		</if>
		)
	</insert>

	<update id="updateBorrowCash" parameterType="AfBorrowCashDo">
		UPDATE af_borrow_cash SET gmt_modified = NOW()
		<if test="borrowNo != null">
			,borrow_no=#{borrowNo}
		</if>
		<if test="userId != null">
			,user_id=#{userId}
		</if>
		<if test="type != null">
			,type=#{type}
		</if>
		<if test="amount != null">
			,amount=#{amount}
		</if>
		<if test="status != null">
			,status=#{status}
		</if>
		<if test="remark != null">
			,remark=#{remark}
		</if>
		<if test="cardNumber != null">
			,card_number=#{cardNumber}
		</if>
		<if test="cardName != null">
			,card_name=#{cardName}
		</if>
		<if test="overdueDay != null">
			,overdue_day=#{overdueDay}
		</if>
		<if test="overdueAmount != null">
			,overdue_amount=#{overdueAmount}
		</if>
		<if test="arrivalAmount != null">
			,arrival_amount=#{arrivalAmount}
		</if>
		<if test="gmtArrival != null">
			,gmt_arrival=#{gmtArrival}
		</if>
		<if test="reviewName != null">
			,review_name=#{reviewName}
		</if>
		<if test="reviewUserName != null">
			,review_user_name=#{reviewUserName}
		</if>
		<if test="reviewDetails != null">
			,review_details=#{reviewDetails}
		</if>
		<if test="gmtReview != null">
			,gmt_review=#{gmtReview}
		</if>
		<if test="gmtClose != null">
			,gmt_close=#{gmtClose}
		</if>
		<if test="poundage != null">
			,poundage=#{poundage}
		</if>
		<if test="overdueStatus != null">
			,overdue_status=#{overdueStatus}
		</if>
		<if test="reviewStatus != null">
			,review_status=#{reviewStatus}
		</if>
		<if test="rateAmount != null">
			,rate_amount=#{rateAmount}
		</if>
		<if test="repayAmount != null">
			,repay_amount=#{repayAmount}
		</if>
		<if test="rishOrderNo != null">
			,rish_order_no=#{rishOrderNo}
		</if>

		<if test="gmtPlanRepayment != null">
			,gmt_plan_repayment=#{gmtPlanRepayment}
		</if>
		<if test="sumRate != null">
			,sum_rate=#{sumRate}
		</if>
		<if test="sumOverdue != null">
			,sum_overdue=#{sumOverdue}
		</if>
		<if test="sumJfb != null">
			,sum_jfb=#{sumJfb}
		</if>
		<if test="sumRebate != null">
			,sum_rebate=#{sumRebate}
		</if>
		<if test="sumRenewalPoundage != null">
			,sum_renewal_poundage=#{sumRenewalPoundage}
		</if>
		<if test="renewalNum != null and renewalNum !=''">
			,renewal_num=#{renewalNum}
		</if>
		<if test="majiabaoName != null and majiabaoName !=''">
			,majiabao_name=#{majiabaoName}
		</if>
		<if test="finishDate != null and finishDate !=''">
			,finish_date=#{finishDate}
		</if>
		<if test="riskDailyRate != null and riskDailyRate !=''">
			,risk_daily_rate=#{riskDailyRate}
		</if>
		WHERE id = #{rid}
	</update>

	<update id="deleteBorrowCash" parameterType="java.lang.Long">
		UPDATE
		af_borrow_cash SET is_delete = 1 WHERE id=#{rid}
	</update>

	<select id="getBorrowCashByUserId" parameterType="java.lang.Long"
		resultType="AfBorrowCashDo">
		SELECT
		<include refid="queryFields" />
		FROM
		af_borrow_cash
		WHERE
		is_delete = 0
		AND
		user_id = #{userId}
		AND
		borrow_no is not null
		ORDER BY
		gmt_create DESC
		LIMIT
		1
	</select>

	
	<select id="getBorrowCashByUserIdDescById" parameterType="java.lang.Long"
		resultType="AfBorrowCashDo">
		SELECT
		<include refid="queryFields" />
		FROM
		af_borrow_cash
		WHERE
		is_delete = 0
		AND
		user_id = #{userId}
		ORDER BY
		id DESC
		LIMIT
		1
	</select>

	<select id="getBorrowCashByrid" parameterType="java.lang.Long"
		resultType="AfBorrowCashDo">
		SELECT
		<include refid="queryFields" />
		FROM
		af_borrow_cash
		WHERE
		is_delete = 0
		AND
		id = #{rid}
	</select>
	<select id="getBorrowCashListByUserId" resultType="AfBorrowCashDo">
		SELECT
		<include refid="queryFields" />
		FROM
		af_borrow_cash
		WHERE
		is_delete = 0
		AND
		user_id = #{userId}
		AND
		borrow_no is not null
		ORDER BY
		gmt_create DESC
		LIMIT
		#{start},20
	</select>
	<select id="getBorrowRecycleListByUserId" resultType="AfBorrowCashDto">
		SELECT
		bc.id
		rid,bc.gmt_create,bc.gmt_modified,bc.borrow_no,bc.user_id,bc.type,bc.amount,bc.status,bc.remark,bc.card_number,bc.card_name,bc.overdue_day,
		bc.overdue_amount,bc.arrival_amount,bc.gmt_arrival,bc.review_name,bc.review_user_name,bc.review_details,bc.gmt_review,bc.poundage,bc.rate_amount,bc.repay_amount,bc.latitude,bc.longitude,bc.province,bc.city,bc.county,bc.overdue_status,bc.review_status,bc.address,gmt_close,rish_order_no,
		gmt_plan_repayment,sum_rate,sum_overdue,sum_jfb,sum_rebate,sum_renewal_poundage,renewal_num,poundage_rate,base_bank_rate,majiabao_name,risk_daily_rate,ro.id recycleId
		FROM
		af_borrow_cash bc
		LEFT JOIN af_borrow_recycle_order ro on bc.id=ro.borrow_id
		WHERE
		bc.is_delete = 0
		AND
		bc.user_id = #{userId}
		AND
		ro.id is not null
		ORDER BY
		bc.gmt_create DESC
	</select>
	<select id="listDoneCashsByUserId" resultType="AfBorrowCashDo">
        SELECT
        <include refid="queryFields" />
        FROM af_borrow_cash
        WHERE is_delete = 0
            AND user_id = #{userId}
            AND status IN ('TRANSEDFAIL','CLOSED','FINSH')
        ORDER BY gmt_create DESC
        LIMIT #{start},20
    </select>

    <select id="getDealingCashByUserId" resultType="AfBorrowCashDo">
        SELECT
        <include refid="queryFields" />
        FROM af_borrow_cash
        WHERE is_delete = 0
            AND user_id = #{userId}
            AND status IN ('APPLY','WAITTRANSED','TRANSEDING','TRANSED')
        ORDER BY gmt_create DESC
        LIMIT 1
    </select>
	<select id="getCurrentLastBorrowNo" resultType="java.lang.String">
		select borrow_no
		from af_borrow_cash WHERE borrow_no LIKE CONCAT(#{orderNoPre},"%")
		ORDER BY id DESC LIMIT 1;
	</select>

	<select id="getBorrowCashByRishOrderNo" parameterType="java.lang.String"
		resultType="AfBorrowCashDo">
		SELECT
		<include refid="queryFields" />
		FROM
		af_borrow_cash
		WHERE
		is_delete = 0
		AND
		rish_order_no = #{rishOrderNo}
	</select>

	<select id="getUserDayLastBorrowCash" resultType="AfBorrowCashDo">
		SELECT
		<include refid="queryFields" />
		FROM
		af_borrow_cash
		WHERE
		is_delete = 0
		AND
		user_id = #{userId}
		and  <![CDATA[ gmt_create  >=  #{startTime}  ]]>
		and  <![CDATA[ gmt_create  <=  #{endTime}  ]]>
		ORDER BY gmt_create DESC LIMIT 1;
	</select>
	
	<select id="getSpecBorrowCashNums" resultType="java.lang.Integer">
		SELECT
		count(*) 
		FROM
		af_borrow_cash
		WHERE
		is_delete = 0
		AND
		user_id = #{userId}
		and
		review_status = #{reviewStatus}
		and  <![CDATA[ gmt_create  >=  #{startTime}  ]]>;
	</select>
	
	<select id="getBorrowNumByUserId" resultType="java.lang.Integer">
		select count(*) from `af_borrow_cash` WHERE `status` in ('FINSH', 'TRANSED') and `user_id` =#{userId}; 
	</select>
	
	<select id ="getBorrowCashByStatusNotInFinshAndClosed" resultType="AfBorrowCashDo">
	SELECT
		<include refid="queryFields" />
		FROM
		af_borrow_cash
		WHERE
		is_delete = 0
		AND
		user_id = #{userId}
		and status not in ('CLOSED','FINSH','TRANSEDFAIL');
	</select>
	<select id ="getNowTransedBorrowCashByUserId" resultType="AfBorrowCashDo">
	SELECT
		<include refid="queryFields" />
		FROM
		af_borrow_cash
		WHERE
		is_delete = 0
		AND
		user_id = #{userId}
		and status = 'TRANSED'
		ORDER BY
		gmt_create ASC
		LIMIT
		1
	</select>
	
	<select id ="getNowUnfinishedBorrowCashByUserId" resultType="AfBorrowCashDo">
		SELECT
		<include refid="queryFields" />
		FROM
		af_borrow_cash
		WHERE
		is_delete = 0
		AND
		user_id = #{userId}
		and status not in ('CLOSED','FINSH')
		ORDER BY
		gmt_create ASC
		LIMIT
		1
	</select>
	
	<select id ="getBorrowCashInfoByBorrowNo" resultType="AfBorrowCashDo">
		SELECT
		<include refid="queryFields" />
		FROM
			af_borrow_cash
		WHERE
			is_delete = 0
		AND 
			borrow_no = #{borrowNo}
		LIMIT 1
	</select>
	
	<select id ="getBorrowCashInfoByBorrowNoV1" resultType="AfBorrowCashDo">
		SELECT
		<include refid="queryFields" />
		FROM
			af_borrow_cash
		WHERE
			is_delete = 0
		AND 
			borrow_no = #{borrowNo} and status='TRANSED'
		LIMIT 1
	</select>
	
	<select id ="getRiskRefuseBorrowCash" resultType="AfBorrowCashDo">
		SELECT
		<include refid="queryFields" />
		FROM
			af_borrow_cash
		WHERE
			is_delete = 0
		AND 
			review_status = 'REFUSE'
		AND
			gmt_create between #{gmtStart} AND #{gmtEnd}
		AND
			user_id = #{userId}
	</select>
	
	<select id ="getBorrowedUserIds" resultType="String">
		SELECT
			DISTINCT user_id 
		FROM
			af_borrow_cash
	</select>


	<select id="getBorrowCashByRemcommend" resultType="HashMap">
		SELECT count(1) 'count' FROM  af_borrow_cash where user_id = #{user_id}  and status in ('TRANSEDING','TRANSED','CLOSED','FINSH')
	   and is_delete = 0
	</select>

	<update id="updateBalancedDate" parameterType="AfBorrowCashDo">
		UPDATE af_borrow_cash SET gmt_modified = NOW()
		<if test="status != null">
			,status=#{status}
		</if>
		<if test="rateAmount != null">
			,rate_amount=#{rateAmount}
		</if>
		<if test="overdueAmount != null">
			,overdue_amount=#{overdueAmount}
		</if>
		<if test="sumRate != null">
			,sum_rate=#{sumRate}
		</if>
		<if test="sumOverdue != null">
			,sum_overdue=#{sumOverdue}
		</if>
		WHERE id=#{rid}
	</update>
	
	
	<update id="updateLegalOrderCashBalanced" parameterType="AfBorrowCashDo">
		UPDATE af_borrow_legal_order_cash SET gmt_modified = NOW()
		<if test="status != null">
			,status=#{status}
		</if>
		<if test="overdueAmount != null">
			,overdue_amount=#{overdueAmount}
		</if>
		<if test="sumRepaidOverdue != null">
			,sum_repaid_overdue=#{sumRepaidOverdue}
		</if>
		WHERE id=#{rid}
	</update>

	<select id="getCurrDayTransFailTimes" resultType="java.lang.Integer">
		SELECT
		count(*) 
		FROM
		af_borrow_cash
		WHERE
		is_delete = 0
		AND
		user_id = #{userId}
		and `status` = 'TRANSEDFAIL'
		and  gmt_modified  >= CURDATE()
	</select>
	
	<select id="getBorrowCashSumAmount" resultType="java.math.BigDecimal">
		SELECT
			SUM(`amount`)
		FROM
			`af_borrow_cash`
		WHERE `is_delete` =0 AND `status` IN ("FINSH","TRANSED")
	</select>

	<select id="getRandomUser" resultType="String">

        SELECT
         	user_id
        FROM
        	`af_borrow_cash`
        WHERE
        	`is_delete` =0
        AND
        	`status` ="TRANSED"
        AND
        	 `gmt_create`  BETWEEN date_format(date_sub(curdate(),interval 1 day),'%Y-%m-%d %00:%00:%00') AND date_format(date_sub(curdate(),interval 1 day),'%Y-%m-%d %23:%59:%59')
        ORDER BY
         Rand() limit 10
	</select>

	<select id="getNotRandomUser" parameterType="java.util.List" resultType="String">
		 SELECT
         	user_id
        FROM
        	`af_borrow_cash`
        WHERE
        	`is_delete` =0
        AND
        	`status` ="TRANSED"
        AND
        	 `gmt_create`  BETWEEN date_format(date_sub(curdate(),interval 1 day),'%Y-%m-%d %00:%00:%00') AND date_format(date_sub(curdate(),interval 1 day),'%Y-%m-%d %23:%59:%59')
        AND
			user_id
		NOT IN
			<foreach collection="list" item="id" open="(" close=")"
    			separator=",">
    			#{id}
    		</foreach>
	</select>
	
	<update id="updateAfBorrowCashService" parameterType="AfBorrowCashDo">
		UPDATE af_borrow_cash SET gmt_modified = NOW()
		<if test="overdueStatus != null">
			,rd_before_overdue_status=#{overdueStatus}
		</if>
		WHERE id=#{rid}
	</update>

	<select id="getBorrowCash" resultType="AfBorrowCashDo">
		SELECT <include refid="queryFields" />  FROM  af_borrow_cash where user_id = #{userId}  and status in ('TRANSEDING','TRANSED')
		and is_delete = 0
	</select>

	<update id="updateAuAmountByRid">
		UPDATE af_borrow_cash SET gmt_modified = NOW()
			,au_amount=#{auAmount}
		WHERE id=#{rid}
	</update>

	<update id="updateBorrowCashLock" parameterType="java.lang.Long">
		UPDATE
		af_borrow_cash SET gmt_modified = NOW(), lockdate = NOW(), is_lock = 'Y' WHERE id=#{borrowId} AND status = 'TRANSED' and is_lock='N'
	</update>

	<update id="updateBorrowCashUnLock" parameterType="java.lang.Long">
		UPDATE
		af_borrow_cash SET gmt_modified = NOW(), lockdate = NOW(), is_lock = 'N' WHERE id=#{borrowId}
	</update>
	<select id="getBorrowCashByStatus" resultType="AfBorrowCashDo">
		SELECT
		<include refid="queryFields" />
		FROM
		`af_borrow_cash`
		WHERE `is_delete` =0 AND `status` IN ('TRANSED','TRANSEDING','WAITTRANSED')
		AND user_id=#{userId}
		limit 0,1
	</select>
	<update id="updateAfBorrowCashPlanTime" parameterType="java.lang.Long">
		UPDATE
		af_borrow_cash SET gmt_plan_repayment = NOW() WHERE user_id=#{userId} and  `status` = 'TRANSED'
	</update>
	
	<!-- 宜信查询 -->
	<select id="getListByUserId" resultType="AfBorrowCashDo">
		SELECT
		<include refid="queryFields" />
		FROM
		af_borrow_cash
		WHERE
		is_delete = 0
		AND
		user_id = #{userId}
		and status not in('APPLY','TRANSEDING','WAITTRANSED')
		ORDER BY
		gmt_create DESC
		<if test="rows != null">
			limit #{rows}
		</if>
	</select>
		
	<select id="getOverdueInfoByUserId" resultType="com.ald.fanbei.api.dal.domain.dto.AfUserBorrowCashOverdueInfoDto">
		SELECT
			COUNT(1) overdueNums,ifnull(sum(amount),0) overdueAmount
		FROM
			af_borrow_cash
		WHERE
			`status` IN ('TRANSED', 'FINSH') and overdue_status='Y' 
		 and user_id = #{userId}
	</select>
    <select id="fetchLastByUserId" resultType="AfBorrowCashDo">
        SELECT
        <include refid="queryFields" />
        FROM af_borrow_cash
        WHERE is_delete = 0
            AND user_id = #{userId}
			AND borrow_no is not null
        ORDER BY id DESC LIMIT 1
    </select>

	<select id="fetchLastRecycleByUserId" resultType="AfBorrowCashDo">
		SELECT
		bc.id
		rid,bc.gmt_create,bc.gmt_modified,bc.borrow_no,bc.user_id,bc.type,bc.amount,bc.status,bc.remark,bc.card_number,bc.card_name,bc.overdue_day,
		bc.overdue_amount,bc.arrival_amount,bc.gmt_arrival,bc.review_name,bc.review_user_name,bc.review_details,bc.gmt_review,bc.poundage,bc.rate_amount,bc.repay_amount,bc.latitude,bc.longitude,bc.province,bc.city,bc.county,bc.overdue_status,bc.review_status,bc.address,gmt_close,rish_order_no,
		gmt_plan_repayment,sum_rate,sum_overdue,sum_jfb,sum_rebate,sum_renewal_poundage,renewal_num,poundage_rate,base_bank_rate,majiabao_name,risk_daily_rate
		FROM af_borrow_cash bc
		LEFT JOIN af_borrow_recycle_order ro on bc.id=ro.borrow_id
		WHERE bc.is_delete = 0
		AND bc.user_id = #{userId}
		AND ro.id is not null
		AND bc.status not in ('CLOSED','FINSH')
		ORDER BY bc.id DESC LIMIT 1
	</select>
<select id="getCashBorrowSuccessByUserId" resultType="java.lang.Integer">
		SELECT
			count(1)
		FROM
			`af_borrow_cash`
		WHERE `is_delete` =0 AND `status` IN ("FINSH","TRANSED")
		and user_id = #{userId}
		<if test="activityTime != null">
		and gmt_arrival &lt; #{activityTime}
		</if>
	</select>
	<select id="getCashBorrowByUserIdAndActivity" resultType="java.lang.Integer">
		SELECT
			count(1)
		FROM
			`af_borrow_cash`
		WHERE `is_delete` =0 AND `status` IN ('TRANSEDING','TRANSED','CLOSED','FINSH')
		and user_id = #{userId}
		<if test="activityTime != null">
		and gmt_arrival &lt; #{activityTime}
		</if>
	</select>
	
	<select id="getBorrowCashInfoById" parameterType="java.lang.Long" resultType="AfBorrowCashDto">
		SELECT
			abc.borrow_no orderNo,
			abc.user_id userId,
			au.real_name NAME,
			aua.id_number cardId,

			aub.mobile mobile,
			aub.card_number bankNo,

			abc.card_name cardName,
			abc.arrival_amount money,
			abc.type type,
			abc.gmt_create loanStartTime,
			abloc.borrow_remark,
       		abloc.refund_remark
		FROM
			af_borrow_cash abc
		LEFT JOIN af_user au ON au.id = abc.user_id
		LEFT JOIN af_user_account aua ON aua.user_id = au.id
		LEFT JOIN af_borrow_legal_order_cash abloc on abc.id=abloc.borrow_id
  		left JOIN af_user_bankcard aub ON aub.user_id=abc.user_id
		WHERE
			abc.id = #{borrowCashId}
		AND aub.`is_main` ='Y' and aub.status ='B' and aub.is_delete=0  limit 1
	</select>

    <select id="tuchDealingBorrowCash" parameterType="java.lang.Long" resultType="java.lang.Long">
        SELECT id
        FROM af_borrow_cash 
        WHERE user_id = #{userId} 
        	AND status IN ('APPLY','WAITTRANSED','TRANSED','TRANSEDING') LIMIT 1
    </select>

</mapper>
