<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ald.fanbei.api.dal.dao.AfGoodsDao">
	<sql id="queryFields">
		id rid,gmt_create,gmt_modified,creator,modifier,name,goods_icon,thumbnail_icon,goods_url,open_id,num_id,price_amount,
		sale_amount,category_id,sale_count,gmt_start,gmt_end,status,source,rebate_amount,rebate_rate,shop_name,
		(sale_amount-rebate_amount) real_amount,tags,goods_pic1,goods_pic2,goods_pic3,goods_pic4,goods_detail,remark,stock_count
	</sql>

	<sql id="queryAllFields">
		a.id rid,a.gmt_create,a.gmt_modified,a.creator,a.modifier,a.name,a.goods_icon,a.thumbnail_icon,a.goods_url,a.open_id,a.num_id,a.price_amount,
		a.sale_amount,a.category_id,a.sale_count,a.gmt_start,a.gmt_end,a.status,a.source,a.rebate_amount,a.rebate_rate,a.shop_name,
		(a.sale_amount-a.rebate_amount) real_amount,a.tags,a.goods_pic1,a.goods_pic2,a.goods_pic3,a.goods_pic4,a.goods_detail,a.remark,a.stock_count
	</sql>

	<sql id="queryFlashFields">
		id rid,s.gmt_create,gmt_modified,creator,modifier,name,goods_icon,thumbnail_icon,goods_url,open_id,num_id,price_amount,
		sale_amount,category_id,sale_count,gmt_start,gmt_end,status,source,rebate_amount,rebate_rate,shop_name,
		(sale_amount-rebate_amount) real_amount,tags,goods_pic1,goods_pic2,goods_pic3,goods_pic4,goods_detail,remark,stock_count
	</sql>
	
	<sql id="queryWithFields">
		g.id rid,g.gmt_create,g.gmt_modified,g.creator,g.modifier,g.name,g.goods_icon,g.thumbnail_icon,g.goods_url,g.open_id,g.num_id,g.price_amount,
		g.sale_amount,g.category_id,g.sale_count,g.gmt_start,g.gmt_end,g.status,g.source,g.rebate_amount,g.rebate_rate,g.shop_name,
		(g.sale_amount-g.rebate_amount) real_amount,g.tags,g.goods_pic1,g.goods_pic2,g.goods_pic3,g.goods_pic4,g.goods_detail,g.remark
	</sql>
	
	<select id="getGoodsById" resultType="AfGoodsDo">
		SELECT
			<include refid="queryFields"/>
		FROM
			af_goods
		WHERE
			is_delete=0 AND id = #{rid}
	</select>
	
	<select id="getGoodsByNumId" resultType="AfGoodsDo">
		SELECT
			<include refid="queryFields"/>
		FROM
			af_goods
		WHERE
			is_delete=0 AND num_id = #{numId}  limit 1
	</select>
	
	
	
	<select id="getGoodsByOpenId" resultType="AfGoodsDo">
		SELECT
			<include refid="queryFields"/>
		FROM
			af_goods
		WHERE
			is_delete=0 AND open_id=#{openId}
		order by gmt_modified desc limit 1
	</select>
	
	<select id="getCateGoodsList" resultType="AfGoodsDo" parameterType="AfGoodsQuery">
		SELECT
			<include refid="queryWithFields"/>
		FROM
			af_goods g
		WHERE
			g.is_delete=0  and g.status = 'PUBLISH'
			<if test="categoryId != null and categoryId !=0">
				and g.primary_category_id=#{categoryId}
			</if>
			<if test="categoryId == null or categoryId ==0">
				and exists(select 1 from af_category c where c.is_delete=0 and c.level=1 and g.primary_category_id=c.id) 
			</if>
			<if test="keywords != null and keywords !=''">
				AND g.name LIKE CONCAT('%',#{keywords}, '%')
			</if>
			<if test="minAmount != null and minAmount !=0">
				AND (g.sale_amount-g.rebate_amount)>=#{minAmount}
			</if>
			<if test="maxAmount != null and maxAmount !=0">
				AND (g.sale_amount-g.rebate_amount)<![CDATA[  <=  ]]> #{maxAmount}
			</if>
			<if test="source != null and source !=''">
				AND g.source = #{source}
			</if>
			<if test="appVersion != null and 371 > appVersion">
				AND
					id <![CDATA[  <=  ]]> 110552
			</if>
			<if test="appVersion != null and  appVersion >= 371">
				AND
					id <![CDATA[  >  ]]> 10552
			</if>
		order by g.gmt_modified desc
	</select>
	
	
	
	<select id="getHomeCategoryGoodsList" resultType="AfGoodsDo" parameterType="AfGoodsQuery">
		SELECT
			<include refid="queryWithFields"/>
		FROM
			af_goods g
		WHERE
			g.is_delete=0  and g.status = 'PUBLISH'
			<if test="categoryId != null and categoryId !=0">
				and g.category_id=#{categoryId}
			</if>
			<if test="categoryId == null or categoryId ==0">
				and exists(select 1 from af_category c where c.is_delete=0 and c.level=1 and g.primary_category_id=c.id) 
			</if>
		order by g.gmt_modified desc
	</select>
	
	<update id="updateSubscribeStatus">
		UPDATE
			af_goods
		SET
			gmt_modified = NOW(),
			modifier = 'system',
			subscribe = #{status}
			<if test="publishStatus != null and  publishStatus != ''">
				 ,status = #{publishStatus}
			</if>
		WHERE
			num_id = #{numId}
	</update>
	
	<update id="updateTaobaoGoodsInfo" parameterType="AfGoodsDo" >
		UPDATE
			af_goods
		SET
			gmt_modified = NOW()
			,modifier = 'system'
			<if test="name != null and name != ''">
				,name = #{name}
			</if>
			<!-- 禁止修改商品图片 -->
			<!-- 
			<if test="goodsIcon != null and goodsIcon != ''">
				,goods_icon = #{goodsIcon}
			</if>
			 -->
			<if test="priceAmount != null">
				,price_amount = #{priceAmount}
			</if>
			<if test="saleAmount != null">
				,sale_amount = #{saleAmount}
			</if>
		WHERE
			num_id = #{numId}
	</update>
	
	<update id="cancelPublishGoods">
		UPDATE
			af_goods
		SET
			gmt_modified = NOW(),
			modifier = 'system',
			status = 'CANCEL'
		WHERE
			num_id = #{numId}
	</update>
	<update id="updateSelfSupportGoods">
		UPDATE
			af_goods
		SET
			gmt_modified = NOW(),
			
			sale_count = sale_count+#{addSaleCount}
		WHERE
			is_delete=0 AND
			id = #{rid}
	</update>
	
	<select id="checkIsSelfBuild"  resultType="AfGoodsDo">
		SELECT
			<include refid="queryFields"/>
		FROM af_goods
		WHERE is_delete = 0
		AND source = 'SELFBUILD'
		AND is_grab_success = 0
		AND num_id = #{numId}
	</select>
	<select id="listGoodsListByParentIdAndFormerCategoryId"  resultType="AfGoodsDo" parameterType="java.lang.Long">
		SELECT
			<include refid="queryFields"/>
		FROM af_goods
		WHERE is_delete = 0
		AND STATUS = 'PUBLISH'
		AND primary_category_id = #{parentId}
		AND category_id = (
				SELECT 
				 id 
			    FROM af_goods_category 
				WHERE parent_id =(          
						SELECT
						id 
						FROM af_goods_category 
						WHERE parent_id = #{parentId}
						AND LEVEL = 2
					
						ORDER BY sort DESC 
						LIMIT 0,1
				)
		AND LEVEL = 3

		ORDER BY sort DESC 
		LIMIT 0,1
	 )
	</select>
	
	<select id="listGoodsListByParentIdFromSubjectGoods"  resultType="AfGoodsDo" parameterType="java.lang.Long">
	SELECT
		<include refid="queryFields"/>
		FROM af_goods
		WHERE is_delete = 0
		AND STATUS = 'PUBLISH'
		AND id IN (	
			SELECT 
				 goods_id 
				FROM af_subject_goods 
				WHERE subject_id =(          
						SELECT
						id 
						FROM af_subject 
						WHERE parent_id = #{parentId}
						AND LEVEL = 2
						ORDER BY gmt_create ASC
						LIMIT 0,1
				)
				AND parent_subject_id = #{parentId}
			)
		ORDER BY gmt_create
	</select>		
				
	
	<select id="listGoodsListByPrimaryCategoryIdAndCategoryId"  resultType="AfGoodsDo" parameterType="java.lang.Long">
		SELECT
			<include refid="queryFields"/>
		FROM af_goods
		WHERE is_delete = 0
		AND STATUS = 'PUBLISH'
		AND primary_category_id = #{primaryCategoryId}
		AND category_id = #{categoryId}
	</select>

	<select id="selectFlashSaleGoods" resultType="AfEncoreGoodsDto" parameterType="AfGoodsQuery" >
		SELECT
		<include refid="queryFlashFields"/>
		FROM
			(
				SELECT
					m.goods_id,m.gmt_create
				FROM
					af_activity_model m,
					(
						SELECT
							id
						FROM
							af_activity
						WHERE
							is_delete = 0
						AND type = '7'
						AND `status` = '2'
						AND gmt_start = CAST(CAST(SYSDATE()AS DATE)AS DATETIME)
					) a
				WHERE
					a.id = m.activity_id
				AND m.is_delete = 0
				AND m.goods_type = 3
			) s
		LEFT JOIN af_goods g ON s.goods_id = g.id
		WHERE
			g.is_delete = 0
		AND g.status = 'PUBLISH'
		ORDER BY s.gmt_create desc
	</select>

	<select id="selectBookingRushGoods" resultType="AfEncoreGoodsDto" parameterType="AfGoodsQuery" >
		SELECT
		<include refid="queryFields"/>
		FROM
		(
		SELECT
		m.goods_id
		FROM
		af_activity_model m,
		(
		SELECT
		id
		FROM
		af_activity
		WHERE
		is_delete = 0
		AND type = '7'
		AND `status` = '2'
		AND gmt_start = date_add(CAST(CAST(SYSDATE()AS DATE)AS DATETIME), interval 1 day)
		) a
		WHERE
		a.id = m.activity_id
		AND m.is_delete = 0
		AND m.goods_type = 3
		) s
		LEFT JOIN af_goods g ON s.goods_id = g.id
		WHERE
			g.is_delete = 0
		AND g.status = 'PUBLISH'
		ORDER BY g.gmt_create desc
	</select>


	<select id="getGoodsByCategoryId" resultType="AfGoodsDo">
		SELECT
			<include refid="queryFields"/>
		FROM af_goods
		WHERE 
			is_delete = 0
		AND
			category_id = #{categoryId}
		LIMIT 50
	</select>
	<select id="listGoodsListBySubjectId" resultType="AfGoodsDo" parameterType="java.lang.Long">
	SELECT
			<include refid="queryFields"/>
		FROM af_goods
		WHERE 
			is_delete = 0
		AND
			id in  (
			select goods_id 
			  from af_subject_goods
			  where subject_id  = #{subjectId}
			  and is_delete = 0
			  
			)
			
			
	</select>
		<select id="getGoodsByModelId" resultType="AfGoodsDo">
		SELECT
			<include refid="queryFields"/>
		from af_goods
		where id_delete = 0
		AND
			id in (select item_value from af_model_h5_item where item_value2 = #{categoryId} and item_type = 'GOODS_ID' and type = 'GOODSLIST' and is_delete = 0)

	</select>
	<select id="getHomeGoodsByModelId" resultType="AfGoodsDo">
		SELECT
		<include refid="queryAllFields"/>
		FROM
		af_goods a LEFT JOIN af_model_h5_item b on b.item_value = a.id
		WHERE
		a.is_delete = 0
		AND b.item_value2 = #{categoryId}
		AND b.item_type = 'GOODS_ID'
		AND b.type = 'GOODSLIST'
		AND b.is_delete = 0
		ORDER BY b.gmt_create desc

	</select>

	<select id="getGoodsVerifyByCategoryId" resultType="AfGoodsDo">
		select
			g.source,g.rebate_amount,g.id Rid,g.name,g.goods_icon,g.goods_url,g.num_id,g.price_amount,g.sale_amount,g.sale_count,v.gmt_create,g.goods_pic1
		from af_goods_verify v,af_goods g
		where g.is_delete =0 and v.is_delete =0 and g.id = v.goods_id
		and g.category_id = #{categoryId} and g.source = 'SELFSUPPORT' and  g.status = 'PUBLISH' order by v.gmt_create DESC
	</select>
	

</mapper>
