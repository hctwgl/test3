<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ald.fanbei.api.dal.dao.AfSmsRecordDao">
	<sql id="queryFields">
		id as rid,gmt_create,user_id,gmt_modified,verify_code,type,send_account,result,is_check,fail_count
	</sql>

	<insert id="addSmsRecord" parameterType="AfSmsRecordDo" useGeneratedKeys="true" keyProperty="rid">
		INSERT INTO af_code_record(user_id , verify_code , type , send_account,result)
		VALUES (
		    #{userId},
		    #{verifyCode},
		    #{type},
		    #{sendAccount},
		    #{result}
		)
	</insert>
	
	<select id="getLatestByUidType" resultType="AfSmsRecordDo">
		SELECT
			<include refid="queryFields" />
		FROM af_code_record WHERE is_delete = 0 AND send_account=#{mobile} AND type=#{type} AND gmt_create >= DATE_ADD(NOW(), INTERVAL -30 MINUTE) ORDER BY ID DESC LIMIT 1;
	</select>
	
	<update id="updateSmsIsCheck">
		UPDATE af_code_record SET gmt_modified = NOW(),is_check = 1 WHERE id=#{rid}
	</update>
	
	<update id="updateSmsFailCount">
		UPDATE af_code_record SET gmt_modified = NOW()
		<if test="failCount != null">
    			,fail_count=fail_count + #{failCount}
			</if>
		 WHERE id=#{rid}
	</update>
	
	<select id="getLatestByMobileCode" resultType="AfSmsRecordDo">
		SELECT
			<include refid="queryFields" />
		FROM af_code_record WHERE is_delete = 0 AND send_account=#{mobile} AND verify_code=#{verifyCode} ORDER BY ID DESC LIMIT 1;
	</select>
	
	<select id="countMobileCodeToday" resultType="java.lang.Integer">
		SELECT
			COUNT(*)
		FROM af_code_record 
		WHERE is_delete = 0 
		AND send_account=#{mobile} 
		AND type=#{type}
	    AND gmt_create <![CDATA[  >=  ]]> CAST(CAST(SYSDATE()AS DATE)AS DATETIME);
	</select>
	
</mapper>