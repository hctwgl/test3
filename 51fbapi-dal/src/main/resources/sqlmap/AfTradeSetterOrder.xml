<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ald.fanbei.api.dal.dao.AfTradeSettleOrderDao">

	<insert id="createSettleOrder" parameterType="com.ald.fanbei.api.dal.domain.AfTradeSettleOrderDo">
		<selectKey resultType="java.lang.Long" keyProperty="id" order="AFTER" >
	      SELECT LAST_INSERT_ID()
	    </selectKey>
	     INSERT INTO af_trade_settle_order
	     (
	     	details,
	     	business_id,
	     	business_name,
	     	status,
	     	balance_amount,
	     	batch_month,
	     	batch_delay_days,
	     	extractable_date,
	     	order_id,
	     	order_no,
	     	is_delete,
	     	creator,
	     	gmt_create,
	     	gmt_modified
	     )
	     values
	     (
	        #{details,jdbcType=VARCHAR},
	     	#{businessId,jdbcType=BIGINT},
	     	#{businessName,jdbcType=VARCHAR},
	     	#{status,jdbcType=VARCHAR},
	     	#{balanceAmount,jdbcType=DECIMAL},
	     	#{batchMonth,jdbcType=INTEGER},
	     	#{batchDelayDays,jdbcType=INTEGER},
	     	#{extractableDate,jdbcType=TIMESTAMP},
	     	#{orderId,jdbcType=BIGINT},
	     	#{orderNo,jdbcType=VARCHAR},
	     	#{isDelete,jdbcType=TINYINT},
	     	#{creator,jdbcType=VARCHAR},
	     	#{gmtCreate,jdbcType=TIMESTAMP},
	     	#{gmtModified,jdbcType=TIMESTAMP}
	     )
	</insert>
	
	<!-- 根据订单号来更新结算单提现中状态 -->
	<update id="batchUpdateSettleOrderStatus">
		update
		af_trade_settle_order t set status = #{status} , gmt_modified =now()
		WHERE status = 'EXTRACTING'
    	AND order_id IN
		<foreach collection="items" item="item" index="index"
			separator="," open="(" close=")">
			#{item}
		</foreach>
	</update>
	
	<update id="updateSettleOrder"  parameterType="com.ald.fanbei.api.dal.domain.AfTradeSettleOrderDo">
	 	UPDATE af_trade_settle_order
	 	<set>
	 		<if test="status != null">
	 			status = #{status,jdbcType=VARCHAR},
	 		</if>
	 		<if test="modifier != null">
	 			modifier = #{modifier,jdbcType=VARCHAR},
	 		</if>
	 		<if test="gmtModified != null">
	 			gmt_modified = #{gmtModified,jdbcType=TIMESTAMP}
	 		</if>
	 	</set>
	 	where status = 'NOT_EXTRACTABLE'
          AND order_id = #{orderId,jdbcType=BIGINT}
	 </update>
	
</mapper>
