<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- af_fund_side_account表: 资金方账户信息表模块 -->
<mapper namespace="com.ald.fanbei.api.dal.dao.AfFundSideAccountDao">
    
    <!--基本的sql查询字段 公共引用...-->
    <sql id="queryFields">
        id rid,fund_side_info_id,amount,frozen_amount,usable_amount,income_amount,gmt_modified,collect_capital,collect_interest,borrow_total_amount 
    </sql>
    
    <sql id="queryAliasFields">
        afsa.id rid,afsa.fund_side_info_id,afsa.amount,afsa.frozen_amount,afsa.usable_amount,afsa.income_amount,afsa.gmt_modified,afsa.collect_capital,afsa.collect_interest 
    </sql>
    
    <!-- 基本的sql查询条件公共引用 -->
    <sql id="commonCondition">
    	WHERE 1=1
        <if test="rid !=null">
            AND id  = #{rid,jdbcType=INTEGER}
        </if>
        <if test="fundSideInfoId != null and fundSideInfoId != ''">
            AND fund_side_info_id = #{fundSideInfoId,jdbcType=INTEGER}
        </if>
        <if test="amount != null and amount != ''">
            AND amount = #{amount,jdbcType=DECIMAL}
        </if>
        <if test="frozenAmount != null and frozenAmount != ''">
            AND frozen_amount = #{frozenAmount,jdbcType=DECIMAL}
        </if>
        <if test="usableAmount != null and usableAmount != ''">
            AND usable_amount = #{usableAmount,jdbcType=DECIMAL}
        </if>
        <if test="incomeAmount != null and incomeAmount != ''">
            AND income_amount = #{incomeAmount,jdbcType=DECIMAL}
        </if>
        <if test="gmtModified !=null">
            AND gmt_modified = #{gmtModified,jdbcType=TIMESTAMP}
        </if>
        <if test="collectCapital != null and collectCapital != ''">
            AND collect_capital = #{collectCapital,jdbcType=DECIMAL}
        </if>
        <if test="collectInterest != null and collectInterest != ''">
            AND collect_interest = #{collectInterest,jdbcType=DECIMAL}
        </if>
        <if test="borrowTotalAmount != null and borrowTotalAmount != ''">
            AND borrow_total_amount = #{borrowTotalAmount,jdbcType=DECIMAL}
        </if>
    </sql>

    
    <insert id="saveRecord" parameterType="com.ald.fanbei.api.dal.domain.AfFundSideAccountDo" keyProperty="rid">
    	<selectKey resultType="java.lang.Long" keyProperty="rid" order="AFTER" >
	      SELECT LAST_INSERT_ID()
	    </selectKey>
    
        INSERT INTO af_fund_side_account
        <trim prefix="(" suffix=")" suffixOverrides="," >
	        <if test="fundSideInfoId != null">        
	            fund_side_info_id,
	        </if>
	        <if test="amount != null">        
	            amount,
	        </if>
	        <if test="frozenAmount != null">        
	            frozen_amount,
	        </if>
	        <if test="usableAmount != null">        
	            usable_amount,
	        </if>
	        <if test="incomeAmount != null">        
	            income_amount,
	        </if>
	        <if test="gmtModified != null">        
	            gmt_modified,
	        </if>
	        <if test="collectCapital != null">        
	            collect_capital,
	        </if>
	        <if test="collectInterest != null">        
	            collect_interest,
	        </if>
	        <if test="borrowTotalAmount != null">        
	            borrow_total_amount,
	        </if>
        </trim>
        
        <trim prefix="values (" suffix=")" suffixOverrides="," >
		    <if test="fundSideInfoId != null" >
		       #{fundSideInfoId,jdbcType=INTEGER},
		    </if>
		    <if test="amount != null" >
		       #{amount,jdbcType=DECIMAL},
		    </if>
		    <if test="frozenAmount != null" >
		       #{frozenAmount,jdbcType=DECIMAL},
		    </if>
		    <if test="usableAmount != null" >
		       #{usableAmount,jdbcType=DECIMAL},
		    </if>
		    <if test="incomeAmount != null" >
		       #{incomeAmount,jdbcType=DECIMAL},
		    </if>
		    <if test="gmtModified != null" >
		       #{gmtModified,jdbcType=TIMESTAMP},
		    </if>
		    <if test="collectCapital != null" >
		       #{collectCapital,jdbcType=DECIMAL},
		    </if>
		    <if test="collectInterest != null" >
		       #{collectInterest,jdbcType=DECIMAL},
		    </if>
		    <if test="borrowTotalAmount != null" >
		       #{borrowTotalAmount,jdbcType=DECIMAL},
		    </if>
        </trim>
    </insert>
    
    <update id="updateById"  parameterType="com.ald.fanbei.api.dal.domain.AfFundSideAccountDo">
        UPDATE af_fund_side_account
          <set>
            <if test="fundSideInfoId != null and fundSideInfoId != '' ">        
                fund_side_info_id = #{fundSideInfoId,jdbcType=INTEGER},                
            </if>
            <if test="amount != null and amount != '' ">        
                amount = #{amount,jdbcType=DECIMAL},                
            </if>
            <if test="frozenAmount != null and frozenAmount != '' ">        
                frozen_amount = #{frozenAmount,jdbcType=DECIMAL},                
            </if>
            <if test="usableAmount != null and usableAmount != '' ">        
                usable_amount = #{usableAmount,jdbcType=DECIMAL},                
            </if>
            <if test="incomeAmount != null and incomeAmount != '' ">        
                income_amount = #{incomeAmount,jdbcType=DECIMAL},                
            </if>
            <if test="gmtModified != null and gmtModified != '' ">        
                gmt_modified = #{gmtModified,jdbcType=TIMESTAMP},                
            </if>
            <if test="collectCapital != null and collectCapital != '' ">        
                collect_capital = #{collectCapital,jdbcType=DECIMAL},                
            </if>
            <if test="collectInterest != null and collectInterest != '' ">        
                collect_interest = #{collectInterest,jdbcType=DECIMAL},                
            </if>
            <if test="borrowTotalAmount != null and borrowTotalAmount != '' ">        
                borrow_total_amount = #{borrowTotalAmount,jdbcType=DECIMAL}                
            </if>
        </set>    
        WHERE  id = #{rid ,jdbcType=BIGINT}
    </update>

	<select id="getById" resultType="com.ald.fanbei.api.dal.domain.AfFundSideAccountDo">
        SELECT
        <include refid="queryFields" />
        FROM af_fund_side_account
        WHERE  id=#{rid ,jdbcType=BIGINT}
        LIMIT 0,1
    </select>

	<select id="getByCommonCondition" resultType="com.ald.fanbei.api.dal.domain.AfFundSideAccountDo" parameterType="com.ald.fanbei.api.dal.domain.AfFundSideAccountDo">
        SELECT
        <include refid="queryFields" />
        FROM af_fund_side_account
        <include refid="commonCondition"/> 
        limit 0,1
    </select>
               
    <select id="getListByCommonCondition" resultType="com.ald.fanbei.api.dal.domain.AfFundSideAccountDo" parameterType="com.ald.fanbei.api.dal.domain.AfFundSideAccountDo">
        SELECT
        <include refid="queryFields" />
        FROM af_fund_side_account
        <include refid="commonCondition"/>
    </select>
    
     
	<select id="getRandomOneAccountsByMinUsableMoney" resultType="com.ald.fanbei.api.dal.domain.AfFundSideAccountDo">
        SELECT
			<include refid="queryAliasFields" />
		FROM
			af_fund_side_account afsa
		LEFT JOIN af_fund_side_info afsi ON afsa.fund_side_info_id = afsi.id
		WHERE
		<![CDATA[ 
		afsi.status = 'Y'
		AND afsa.usable_amount >= #{borrowAmount ,jdbcType=DECIMAL} 
		]]>
		ORDER BY RAND() LIMIT 1
    </select>
    
    <update id="updateRecordInfo"  parameterType="com.ald.fanbei.api.dal.domain.AfFundSideAccountDo">
        UPDATE af_fund_side_account
        <set>
            gmt_modified = now(), 
            <if test="amount != null and amount != '' ">        
                amount = amount + #{amount,jdbcType=DECIMAL},                
            </if>
            <if test="frozenAmount != null and frozenAmount != '' ">        
                frozen_amount = frozen_amount + #{frozenAmount,jdbcType=DECIMAL},                
            </if>
            <if test="usableAmount != null and usableAmount != '' ">        
                usable_amount = usable_amount + #{usableAmount,jdbcType=DECIMAL},                
            </if>
            <if test="incomeAmount != null and incomeAmount != '' ">        
                income_amount = income_amount + #{incomeAmount,jdbcType=DECIMAL},                
            </if>
            <if test="collectCapital != null and collectCapital != '' ">        
                collect_capital = collect_capital + #{collectCapital,jdbcType=DECIMAL},                
            </if>
            <if test="collectInterest != null and collectInterest != '' ">        
                collect_interest = collect_interest + #{collectInterest,jdbcType=DECIMAL},                
            </if>
            <if test="borrowTotalAmount != null and borrowTotalAmount != '' ">        
                borrow_total_amount = borrow_total_amount + #{borrowTotalAmount,jdbcType=DECIMAL}                
            </if>
        </set>    
        WHERE  id = #{rid ,jdbcType=BIGINT}  and <![CDATA[  usable_amount + #{usableAmount,jdbcType=DECIMAL} >=0 ]]>
         <if test="gmtModified != null ">        
                and gmt_modified <![CDATA[   <=  ]]> #{gmtModified}            
         </if>
    </update>
    
</mapper>
