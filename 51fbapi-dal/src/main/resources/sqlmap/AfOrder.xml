<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ald.fanbei.api.dal.dao.AfOrderDao">
	<sql id="queryFields">
		id rid,gmt_create,gmt_modified,user_id,order_no,third_order_no,third_detail_url,
		status,user_coupon_id,order_type,sec_type,goods_id,open_id,num_id,goods_name,goods_icon,count,
		price_amount,sale_amount,actual_amount,shop_name,pay_status,pay_type,pay_trade_no,gmt_pay,trade_no,
		gmt_rebated,mobile,gmt_finished,rebate_amount,commission_amount,bank_id,gmt_pay_end,service_provider,nper,risk_order_no,
		borrow_rate,coupon_amount,interest_free_json
	</sql>
	<sql id="queryAllFields">
		id rid,gmt_create,gmt_modified,user_id,order_no,third_order_no,third_detail_url,
		status,user_coupon_id,order_type,sec_type,goods_id,open_id,num_id,goods_name,goods_icon,count,
		price_amount,sale_amount,actual_amount,shop_name,pay_status,pay_type,pay_trade_no,gmt_pay,trade_no,
		gmt_rebated,mobile,gmt_finished,rebate_amount,commission_amount,bank_id,gmt_pay_end,service_provider,nper,risk_order_no,
		borrow_rate,coupon_amount,interest_free_json
	</sql>
	<insert id="createOrder" keyProperty="rid" useGeneratedKeys="true"  parameterType="AfOrderDo">
		INSERT INTO af_order(
		    gmt_create ,
		    gmt_modified ,
			<if test="userId != null">
		    	user_id , 
			</if>
			order_no , 
			<if test="userCouponId != null">
		    	user_coupon_id, 
			</if>
			<if test="payTradeNo != null">
		    	pay_trade_no, 
			</if>
			order_type , 
		    goods_id ,
		    open_id , 
		    <if test="numId != null" >
			num_id,
			</if>
			goods_name , 
			goods_icon , 
			count , 
			price_amount , 
			sale_amount , 
			actual_amount , 
			shop_name , 
			rebate_amount , 
			<if test="commissionAmount != null" >
			commission_amount,
			</if>
			nper,
			
			mobile,
			bank_id
			<if test="gmtPayEnd != null" >
				,gmt_pay_end
			</if>
			<if test="secType != null" >
				,sec_type
			</if>
			<if test="thirdOrderNo != null" >
				,third_order_no
			</if>
			<if test="thirdDetailUrl != null" >
				,third_detail_url
			</if>
			<if test="serviceProvider != null">
				,service_provider
			</if>
			<if test="interestFreeJson != null">
				,interest_free_json
			</if>
		)
		VALUES (
			<if test="gmtCreate != null">
		    	#{gmtCreate} ,
		    	#{gmtCreate} ,
			</if>
			<if test="gmtCreate == null">
				NOW(),
				NOW(),
			</if>
		    <if test="userId != null">
		    	#{userId},
			</if>
		    #{orderNo},
		    <if test="userCouponId != null">
		    	 #{userCouponId},
			</if>
			<if test="payTradeNo != null">
		    	 #{payTradeNo},
			</if>
		    #{orderType},
	    	#{goodsId},
	    	#{openId},
	    	<if test="numId != null" >
				#{numId},
			</if>
		    #{goodsName},
		    #{goodsIcon},
		    #{count},
		    #{priceAmount},
		    #{saleAmount},
		    #{actualAmount},
		    #{shopName},
		    #{rebateAmount},
		    <if test="commissionAmount != null" >
		    	#{commissionAmount},
		    </if>
		    #{nper},
		    #{mobile},
		    #{bankId}
		    <if test="gmtPayEnd != null">
		    	,#{gmtPayEnd}
		    </if>
		    <if test="secType != null">
		    	,#{secType}
		    </if>
		    <if test="thirdOrderNo != null" >
				,#{thirdOrderNo}
			</if>
			<if test="thirdDetailUrl != null" >
				,#{thirdDetailUrl}
			</if>
			<if test="serviceProvider != null">
				,#{serviceProvider}
			</if>
			<if test="interestFreeJson != null">
				,#{interestFreeJson}
			</if>
		)
	</insert>
	
	<insert id="createOrderList" parameterType="java.util.List" >
		INSERT INTO af_order(
			gmt_create , 
			gmt_modified , 
			user_id , 
			order_no , 
			third_order_no , 
			third_detail_url , 
			status , 
			user_coupon_id , 
			order_type , 
			sec_type , 
			goods_id , 
			open_id , 
			num_id , 
			goods_name , 
			goods_icon , 
			count , 
			price_amount , 
			sale_amount , 
			actual_amount , 
			shop_name , 
			pay_status , 
			pay_type , 
			pay_trade_no , 
			gmt_pay , 
			trade_no , 
			gmt_rebated , 
			mobile , 
			gmt_finished , 
			rebate_amount , 
			commission_amount ,
			bank_id , 
			gmt_pay_end
			)
		VALUES
		<foreach collection="items" separator="," item="item">
			(
    		NOW(),
    		NOW(),
    		#{item.userId},
    		#{item.orderNo},
    		#{item.thirdOrderNo},
    		#{item.thirdDetailUrl},
    		#{item.status},
    		#{item.userCouponId},
    		#{item.orderType},
    		#{item.secType},
    		#{item.goodsId},
    		#{item.openId},
    		#{item.numId},
    		#{item.goodsName},
    		#{item.goodsIcon},
    		#{item.count},
    		#{item.priceAmount},
    		#{item.saleAmount},
    		#{item.actualAmount},
    		#{item.shopName},
    		#{item.payStatus},
    		#{item.payType},
    		#{item.payTradeNo},
    		#{item.gmtPay},
    		#{item.tradeNo},
    		#{item.gmtRebated},
    		#{item.mobile},
    		#{item.gmtFinished},
    		#{item.rebateAmount},
    		#{item.commissionAmount},
    		#{item.bankId},
    		#{item.gmtPayEnd}
		)
		</foreach>
	</insert>
	
	<update id="updateOrderByOutTradeNo" parameterType="AfOrderDo">
		update af_order  set gmt_modified=NOW()
		<if test="userId != null">
		    ,user_id=#{userId}
		</if>
		<if test="orderNo != null">
		    ,order_no=#{orderNo}
		</if>
		<if test="status != null">
		    ,status=#{status}
		</if>
		<if test="userCouponId != null">
		    ,user_coupon_id=#{userCouponId}
		</if>
		<if test="orderType != null">
		    ,order_type=#{orderType}
		</if>
		<if test="goodsId != null">
		    ,goods_id=#{goodsId}
		</if>
		<if test="openId != null">
		    ,open_id=#{openId}
		</if>
		<if test="goodsName != null">
		    ,goods_name=#{goodsName}
		</if>
		<if test="goodsIcon != null">
		    ,goods_icon=#{goodsIcon}
		</if>
		<if test="count != null">
		    ,count=#{count}
		</if>
		<if test="priceAmount != null">
		    ,price_amount=#{priceAmount}
		</if>
		<if test="saleAmount != null">
		    ,sale_amount=#{saleAmount}
		</if>
		<if test="actualAmount != null">
		    ,actual_amount=#{actualAmount}
		</if>
		<if test="shopName != null">
		    ,shop_name=#{shopName}
		</if>
		<if test="payStatus != null">
		    ,pay_status=#{payStatus}
		</if>
		<if test="payType != null">
		    ,pay_type=#{payType}
		</if>
		<if test="payTradeNo != null">
		    ,pay_trade_no=#{payTradeNo}
		</if>
		<if test="gmtPay != null">
		    ,gmt_pay=#{gmtPay}
		</if>
		<if test="tradeNo != null">
		    ,trade_no=#{tradeNo}
		</if>
		<if test="rebateAmount != null">
		    ,rebate_amount=#{rebateAmount}
		</if>
		<if test="gmtRebated != null">
		    ,gmt_rebated=#{gmtRebated}
		</if>
		<if test="mobile != null">
		    ,mobile=#{mobile}
		</if>
		<if test="gmtFinished != null">
		    ,gmt_finished=#{gmtFinished}
		</if>
		<if test="commissionAmount != null">
		    ,commission_amount=#{commissionAmount}
		</if>
		where is_delete=0 and pay_trade_no = #{payTradeNo}
	</update>

	<update id="updateOrderByOrderNo" parameterType="AfOrderDo">
		update af_order  set gmt_modified=NOW()
		<if test="userId != null">
		    ,user_id=#{userId}
		</if>
		<if test="orderNo != null">
		    ,order_no=#{orderNo}
		</if>
		<if test="status != null">
		    ,status=#{status}
		</if>
		<if test="userCouponId != null">
		    ,user_coupon_id=#{userCouponId}
		</if>
		<if test="orderType != null">
		    ,order_type=#{orderType}
		</if>
		<if test="goodsId != null">
		    ,goods_id=#{goodsId}
		</if>
		<if test="openId != null">
		    ,open_id=#{openId}
		</if>
		<if test="goodsName != null">
		    ,goods_name=#{goodsName}
		</if>
		<if test="goodsIcon != null">
		    ,goods_icon=#{goodsIcon}
		</if>
		<if test="count != null">
		    ,count=#{count}
		</if>
		<if test="priceAmount != null">
		    ,price_amount=#{priceAmount}
		</if>
		<if test="saleAmount != null">
		    ,sale_amount=#{saleAmount}
		</if>
		<if test="actualAmount != null">
		    ,actual_amount=#{actualAmount}
		</if>
		<if test="shopName != null">
		    ,shop_name=#{shopName}
		</if>
		<if test="payStatus != null">
		    ,pay_status=#{payStatus}
		</if>
		<if test="payType != null">
		    ,pay_type=#{payType}
		</if>
		<if test="payTradeNo != null">
		    ,pay_trade_no=#{payTradeNo}
		</if>
		<if test="gmtPay != null">
		    ,gmt_pay=#{gmtPay}
		</if>
		<if test="tradeNo != null">
		    ,trade_no=#{tradeNo}
		</if>
		<if test="rebateAmount != null">
		    ,rebate_amount=#{rebateAmount}
		</if>
		<if test="gmtRebated != null">
		    ,gmt_rebated=#{gmtRebated}
		</if>
		<if test="mobile != null">
		    ,mobile=#{mobile}
		</if>
		<if test="gmtFinished != null">
		    ,gmt_finished=#{gmtFinished}
		</if>
		<if test="commissionAmount != null">
		    ,commission_amount=#{commissionAmount}
		</if>
		where is_delete=0 and order_no = #{orderNo} 
	</update>
	
	<select id="getCurrentLastOrderNo" resultType="java.lang.String">
		select order_no from af_order WHERE #{endDate} >= gmt_create AND gmt_create >=#{startDate} AND order_type = #{orderType} ORDER BY id DESC LIMIT 1;
	</select>
	
	<select id="getOrderInfoById" resultType="AfOrderDo">
		SELECT
			<include refid="queryAllFields"/>
		FROM
			af_order
		WHERE
			is_delete=0 AND id = #{rid} AND user_id = #{userId}
	</select>
	
	<select id="getOrderInfoByOrderNo" resultType="AfOrderDo">
		SELECT
			<include refid="queryFields"/>
		FROM
			af_order
		WHERE
			is_delete=0 AND order_no = #{orderNo} and order_type !='AGENTBUY'
	</select>
	
	<select id="getOrderInfoByRiskOrderNo" resultType="AfOrderDo">
		SELECT
			<include refid="queryFields"/>
		FROM
			af_order
		WHERE
			is_delete=0 AND risk_order_no = #{riskOrderNo} 
	</select>
	
	<select id="getOrderInfoByPayOrderNo" resultType="AfOrderDo">
		SELECT
			<include refid="queryFields"/>
		FROM
			af_order
		WHERE
			is_delete=0 AND pay_trade_no = #{payTradeNo}
	</select>
	
	<select id="getThirdOrderInfoByOrderTypeAndOrderNo" resultType="AfOrderDo">
		SELECT
			<include refid="queryFields"/>
		FROM
			af_order
		WHERE
			is_delete=0 
		AND 
			order_type = #{orderType}
		AND	
			third_order_no = #{thirdOrderNo}
	</select>
	
	<select id="getOrderListByStatus" resultType="AfOrderDo" parameterType="AfOrderQuery">
		SELECT
			id rid,gmt_create,gmt_modified,user_id,order_no,third_order_no,third_detail_url,
			status,user_coupon_id,order_type,sec_type,goods_id,open_id,num_id,goods_name,goods_icon,count,
			price_amount,sale_amount,actual_amount,shop_name,pay_status,pay_type,pay_trade_no,gmt_pay,trade_no,
			gmt_rebated,mobile,gmt_finished,rebate_amount,commission_amount,bank_id,gmt_pay_end,service_provider,nper,risk_order_no
		FROM
		
		(SELECT
			id,gmt_create,gmt_modified,user_id,order_no,third_order_no,third_detail_url,
			status,user_coupon_id,order_type,sec_type,goods_id,open_id,goods_name,goods_icon,count,num_id,
			price_amount,sale_amount,actual_amount,shop_name,pay_status,pay_type,pay_trade_no,gmt_pay,trade_no,
			gmt_rebated,mobile,gmt_finished,rebate_amount,commission_amount,bank_id,gmt_pay_end,service_provider,nper,risk_order_no
		FROM
			af_order a
		WHERE
			a.is_delete=0 and a.user_id = #{userId} 
		<if test="orderStatus == 'WC'" >
			and (a.status = 'NEW' or a.status = 'PAID')
		</if>
		<if test="orderStatus == 'WR'">
			and a.status = 'FINISHED'
		</if>
		<if test="orderStatus == 'AR'">
			and a.status = 'REBATED'
		</if>
<!-- 		and NOT EXISTS (SELECT 1 FROM af_order b WHERE b.status='NEW' AND a.id=b.id) -->
		AND
			a.order_type IN ('MOBILE','TAOBAO','TMALL','AGENTBUY')
		UNION ALL
		SELECT
			id,gmt_create,gmt_modified,user_id,order_no,third_order_no,third_detail_url,
			status,user_coupon_id,order_type,sec_type,goods_id,open_id,goods_name,goods_icon,count,num_id,
			price_amount,sale_amount,actual_amount,shop_name,pay_status,pay_type,pay_trade_no,gmt_pay,trade_no,
			gmt_rebated,mobile,gmt_finished,rebate_amount,commission_amount,bank_id,gmt_pay_end,service_provider,nper,risk_order_no
		FROM
			af_order a
		WHERE
			a.is_delete=0 and a.user_id = #{userId} 
		<if test="orderStatus == 'WC'" >
			and (a.status = 'NEW' or a.status = 'PAID')
		</if>
		<if test="orderStatus == 'WR'">
			and a.status = 'FINISHED'
		</if>
		<if test="orderStatus == 'AR'">
			and a.status = 'REBATED'
		</if>
		AND
			a.order_type = 'BOLUOME'
		) a
		order by a.gmt_create desc
	</select>
	
	<update id="updateOrder" parameterType="AfOrderDo" >
		UPDATE 
			af_order 
		SET 
			gmt_modified = NOW()
			<if test="userId != null">
    			,user_id=#{userId}
			</if>
			<if test="orderNo != null">
    			,order_no=#{orderNo}
			</if>
			<if test="thirdOrderNo != null">
    			,third_order_no=#{thirdOrderNo}
			</if>
			<if test="thirdDetailUrl != null">
    			,third_detail_url=#{thirdDetailUrl}
			</if>
			<if test="status != null">
    			,status=#{status}
			</if>
			<if test="userCouponId != null">
    			,user_coupon_id=#{userCouponId}
			</if>
			<if test="orderType != null">
    			,order_type=#{orderType}
			</if>
			<if test="secType != null">
    			,sec_type=#{secType}
			</if>
			<if test="goodsId != null">
    			,goods_id=#{goodsId}
			</if>
			<if test="openId != null">
    			,open_id=#{openId}
			</if>
			<if test="goodsName != null">
    			,goods_name=#{goodsName}
			</if>
			<if test="goodsIcon != null">
    			,goods_icon=#{goodsIcon}
			</if>
			<if test="count != null">
    			,count=#{count}
			</if>
			<if test="priceAmount != null">
    			,price_amount=#{priceAmount}
			</if>
			<if test="saleAmount != null">
    			,sale_amount=#{saleAmount}
			</if>
			<if test="actualAmount != null">
    			,actual_amount=#{actualAmount}
			</if>
			<if test="shopName != null">
    			,shop_name=#{shopName}
			</if>
			<if test="payStatus != null">
    			,pay_status=#{payStatus}
			</if>
			<if test="payType != null">
    			,pay_type=#{payType}
			</if>
			<if test="payTradeNo != null">
    			,pay_trade_no=#{payTradeNo}
			</if>
			<if test="gmtPay != null">
    			,gmt_pay=#{gmtPay}
			</if>
			<if test="tradeNo != null">
    			,trade_no=#{tradeNo}
			</if>
			<if test="gmtRebated != null">
    			,gmt_rebated=#{gmtRebated}
			</if>
			<if test="mobile != null">
    			,mobile=#{mobile}
			</if>
			<if test="gmtFinished != null">
    			,gmt_finished=#{gmtFinished}
			</if>
			<if test="rebateAmount != null">
    			,rebate_amount=#{rebateAmount}
			</if>
			<if test="commissionAmount != null">
    			,commission_amount=#{commissionAmount}
			</if>
			<if test="bankId != null">
    			,bank_id=#{bankId}
			</if>
			<if test="gmtPayEnd != null">
    			,gmt_pay_end=#{gmtPayEnd}
			</if>
			<if test="nper != null">
    			,nper=#{nper}
			</if>
			<if test="riskOrderNo != null">
    			,risk_order_no=#{riskOrderNo}
			</if>
			<if test="borrowRate != null">
    			,borrow_rate=#{borrowRate}
			</if>
			<if test="couponAmount != null">
    			,coupon_amount=#{couponAmount}
			</if>
			<if test="interestFreeJson != null">
    			,interest_free_json=#{interestFreeJson}
			</if>
		WHERE id = #{rid}
	</update>
	
	<select id="getOrderById" resultType="AfOrderDo">
		SELECT
			<include refid="queryAllFields"/>
		FROM
			af_order 
		WHERE
			is_delete=0 
		AND
			id = #{orderId}
	</select>
	
	<select id="getCurrentLastPayNo" resultType="java.lang.String">
		select pay_trade_no from af_order WHERE #{endDate} >= gmt_pay AND gmt_pay >=#{startDate} and gmt_pay is not null and order_type = 'BOLUOME' ORDER BY gmt_pay DESC LIMIT 1;
	</select>
	
	<select id="getNoBorrowOrder" resultType="AfOrderDo">
		select a.id rid,a.user_id,a.order_no,
		a.goods_name,
		a.price_amount,a.sale_amount,a.actual_amount,
		a.shop_name,a.nper
		from af_order a 
		left join af_borrow b on a.id = b.`order_id`  
		where a.order_type = 'BOLUOME' 
		and a.status in ('PAID','FINISHED','REBATED','WAITING_REFUND','DEAL_REFUNDING') 
		and a.pay_type = 'AP' and b.id is null
	</select>
	
	
	
</mapper>