<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- af_seckill_activity_goods表 -->
<mapper namespace="com.ald.fanbei.api.dal.dao.AfSeckillActivityGoodsDao">
    
    <!--基本的sql查询字段 公共引用...-->
    <sql id="queryFields">
        id rid,gmt_create,gmt_modified,special_price,goods_count,limit_count,goods_id,type,activity_id,creator,modifier,price_id 
    </sql>
    
    <!-- 基本的sql查询条件公共引用 -->
    <sql id="commonCondition">
    	WHERE is_delete = 0
        <if test="rid !=null">
            AND id  = #{rid,jdbcType=INTEGER}
        </if>
        <if test="gmtCreate !=null">
            AND gmt_create = #{gmtCreate,jdbcType=TIMESTAMP}
        </if>
        <if test="gmtModified !=null">
            AND gmt_modified = #{gmtModified,jdbcType=TIMESTAMP}
        </if>
        <if test="specialPrice != null and specialPrice != ''">
            AND special_price = #{specialPrice,jdbcType=DECIMAL}
        </if>
        <if test="goodsCount != null and goodsCount != ''">
            AND goods_count = #{goodsCount,jdbcType=INTEGER}
        </if>
        <if test="limitCount != null and limitCount != ''">
            AND limit_count = #{limitCount,jdbcType=VARCHAR}
        </if>
        <if test="goodsId != null and goodsId != ''">
            AND goods_id = #{goodsId,jdbcType=INTEGER}
        </if>
        <if test="type != null and type != ''">
            AND type = #{type,jdbcType=INTEGER}
        </if>
        <if test="activityId != null and activityId != ''">
            AND activity_id = #{activityId,jdbcType=INTEGER}
        </if>
        <if test="creator != null and creator != ''">
            AND creator = #{creator,jdbcType=VARCHAR}
        </if>
        <if test="modifier != null and modifier != ''">
            AND modifier = #{modifier,jdbcType=VARCHAR}
        </if>
        <if test="priceId != null and priceId != ''">
            AND price_id = #{priceId,jdbcType=INTEGER}
        </if>
    </sql>

    
    <insert id="saveRecord" parameterType="com.ald.fanbei.api.dal.domain.AfSeckillActivityGoodsDo" keyProperty="rid">
    	<selectKey resultType="java.lang.Long" keyProperty="rid" order="AFTER" >
	      SELECT LAST_INSERT_ID()
	    </selectKey>
    
        INSERT INTO af_seckill_activity_goods
        <trim prefix="(" suffix=")" suffixOverrides="," >
	        <if test="gmtCreate != null">        
	            gmt_create,
	        </if>
	        <if test="gmtModified != null">        
	            gmt_modified,
	        </if>
	        <if test="specialPrice != null">        
	            special_price,
	        </if>
	        <if test="goodsCount != null">        
	            goods_count,
	        </if>
	        <if test="limitCount != null">        
	            limit_count,
	        </if>
	        <if test="goodsId != null">        
	            goods_id,
	        </if>
	        <if test="type != null">        
	            type,
	        </if>
	        <if test="activityId != null">        
	            activity_id,
	        </if>
	        <if test="creator != null">        
	            creator,
	        </if>
	        <if test="modifier != null">        
	            modifier,
	        </if>
	        <if test="priceId != null">        
	            price_id,
	        </if>
        </trim>
        
        <trim prefix="values (" suffix=")" suffixOverrides="," >
		    <if test="gmtCreate != null" >
		       #{gmtCreate,jdbcType=TIMESTAMP},
		    </if>
		    <if test="gmtModified != null" >
		       #{gmtModified,jdbcType=TIMESTAMP},
		    </if>
		    <if test="specialPrice != null" >
		       #{specialPrice,jdbcType=DECIMAL},
		    </if>
		    <if test="goodsCount != null" >
		       #{goodsCount,jdbcType=INTEGER},
		    </if>
		    <if test="limitCount != null" >
		       #{limitCount,jdbcType=VARCHAR},
		    </if>
		    <if test="goodsId != null" >
		       #{goodsId,jdbcType=INTEGER},
		    </if>
		    <if test="type != null" >
		       #{type,jdbcType=INTEGER},
		    </if>
		    <if test="activityId != null" >
		       #{activityId,jdbcType=INTEGER},
		    </if>
		    <if test="creator != null" >
		       #{creator,jdbcType=VARCHAR},
		    </if>
		    <if test="modifier != null" >
		       #{modifier,jdbcType=VARCHAR},
		    </if>
		    <if test="priceId != null" >
		       #{priceId,jdbcType=INTEGER},
		    </if>
        </trim>
    </insert>
    
    <update id="updateById"  parameterType="com.ald.fanbei.api.dal.domain.AfSeckillActivityGoodsDo">
        UPDATE af_seckill_activity_goods
          <set>
            <if test="gmtCreate != null and gmtCreate != '' ">        
                gmt_create = #{gmtCreate,jdbcType=TIMESTAMP},                
            </if>
            <if test="gmtModified != null and gmtModified != '' ">        
                gmt_modified = #{gmtModified,jdbcType=TIMESTAMP},                
            </if>
            <if test="specialPrice != null and specialPrice != '' ">        
                special_price = #{specialPrice,jdbcType=DECIMAL},                
            </if>
            <if test="goodsCount != null and goodsCount != '' ">        
                goods_count = #{goodsCount,jdbcType=INTEGER},                
            </if>
            <if test="limitCount != null and limitCount != '' ">        
                limit_count = #{limitCount,jdbcType=VARCHAR},                
            </if>
            <if test="goodsId != null and goodsId != '' ">        
                goods_id = #{goodsId,jdbcType=INTEGER},                
            </if>
            <if test="type != null and type != '' ">        
                type = #{type,jdbcType=INTEGER},                
            </if>
            <if test="activityId != null and activityId != '' ">        
                activity_id = #{activityId,jdbcType=INTEGER},                
            </if>
            <if test="creator != null and creator != '' ">        
                creator = #{creator,jdbcType=VARCHAR},                
            </if>
            <if test="modifier != null and modifier != '' ">        
                modifier = #{modifier,jdbcType=VARCHAR},                
            </if>
            <if test="priceId != null and priceId != '' ">        
                price_id = #{priceId,jdbcType=INTEGER}                
            </if>
        </set>    
        WHERE is_delete = 0 AND id = #{rid ,jdbcType=BIGINT}
    </update>

	<select id="getById" resultType="com.ald.fanbei.api.dal.domain.AfSeckillActivityGoodsDo">
        SELECT
        <include refid="queryFields" />
        FROM af_seckill_activity_goods
        WHERE is_delete = 0 AND id=#{rid ,jdbcType=BIGINT}
        LIMIT 0,1
    </select>

	<select id="getByCommonCondition" resultType="com.ald.fanbei.api.dal.domain.AfSeckillActivityGoodsDo" parameterType="com.ald.fanbei.api.dal.domain.AfSeckillActivityGoodsDo">
        SELECT
        <include refid="queryFields" />
        FROM af_seckill_activity_goods
        <include refid="commonCondition"/> 
        limit 0,1
    </select>

    <select id="getActivityGoodsByGoodsId" resultType="com.ald.fanbei.api.dal.domain.AfSeckillActivityGoodsDo" parameterType="java.lang.Long">
        SELECT
        a.id rid,a.gmt_create,a.gmt_modified,a.special_price,a.limit_count,a.goods_id,a.price_id,a.activity_id
        FROM af_seckill_activity_goods a LEFT JOIN af_seckill_activity b ON (a.activity_id=b.id)
        WHERE a.is_delete=0 AND b.is_delete=0 AND b.is_disable=0 AND a.type=2 AND a.goods_id=#{goodsId}
    </select>

    <select id="getActivityPriceByPriceIdAndActId" resultType="AfSeckillActivityGoodsDto">
        SELECT
        a.id rid,a.special_price,a.limit_count,a.goods_id,a.price_id,b.type
        FROM af_seckill_activity_goods a LEFT JOIN af_seckill_activity b ON (a.activity_id=b.id)
        WHERE a.is_delete=0 AND a.type=2 AND b.is_delete=0 AND b.is_disable=0
        AND a.price_id=#{goodsPriceId} AND b.id=#{activityId}
        limit 1
    </select>

    <select id="getActivityInfoByPriceIdAndActId" resultType="AfSeckillActivityGoodsDto">
        SELECT
        a.id rid,a.gmt_create,a.gmt_modified,a.special_price,a.limit_count,a.goods_id,a.price_id,a.activity_id,
        b.gmt_start,b.gmt_end,b.close_time,b.goods_limit_count,b.type
        FROM af_seckill_activity_goods a LEFT JOIN af_seckill_activity b ON (a.activity_id=b.id)
        WHERE a.is_delete=0 AND b.is_delete=0 AND b.is_disable=0 AND a.type=2
        AND a.price_id=#{goodsPriceId} AND b.id=#{activityId}
        limit 1
    </select>

    <update id="updateActivityGoodsById" parameterType="AfSeckillActivityGoodsDo">
        UPDATE af_seckill_activity_goods SET gmt_modified=now(),limit_count=limit_count-#{limitCount}
        WHERE price_id=#{priceId} AND activity_id=#{activityId} AND is_delete=0
    </update>

    <select id="getActivityGoodsByGoodsIdAndActId" resultType="AfSeckillActivityGoodsDo">
        SELECT
        a.id rid,min(a.special_price) special_price,sum(a.limit_count) limit_count
        FROM af_seckill_activity_goods a LEFT JOIN af_goods_price b ON (a.price_id=b.id)
        WHERE a.is_delete=0 AND a.type=2 AND b.is_delete=0 AND b.is_sale = 'Y'
        AND a.goods_id=#{goodsId} AND a.activity_id=#{activityId} AND a.special_price>0
    </select>

    <select id="getActivityPricesByGoodsIdAndActId" resultType="AfSeckillActivityGoodsDto">
        SELECT
        a.id rid,a.special_price,a.limit_count,a.goods_id,a.price_id,b.type
        FROM af_seckill_activity_goods a LEFT JOIN af_seckill_activity b ON (a.activity_id=b.id)
        WHERE a.is_delete=0 AND a.type=2 AND b.is_delete=0 AND b.is_disable=0
        AND a.goods_id=#{goodsId} AND b.id=#{activityId}
    </select>

    <select id="getActivityGoodsByGoodsIds" resultType="AfSeckillActivityGoodsDo">
        SELECT
        a.id rid,min(a.special_price) special_price,a.goods_id
        FROM af_seckill_activity_goods a LEFT JOIN af_seckill_activity c ON (a.activity_id=c.id)
        LEFT JOIN af_goods_price b ON (a.price_id=b.id)
        WHERE a.is_delete=0 AND a.type=2 AND a.special_price>0
        AND c.is_delete=0 AND c.is_disable=0 AND b.is_delete=0 AND b.is_sale='Y'
        AND a.goods_id IN
        <foreach collection="items" item="item" index="index" separator="," open="(" close=")">
            #{item}
        </foreach>
        AND c.gmt_pstart <![CDATA[<=]]> now() AND c.gmt_end <![CDATA[>=]]> now()
        GROUP BY a.goods_id
    </select>

    <select id="getActivityGoodsByGoodsIdsAndActId" resultType="AfActGoodsDto">
        SELECT
        a.id rid,min(a.special_price) special_price,a.goods_id,g.name,g.goods_icon,g.thumbnail_icon,g.goods_url,
        g.price_amount,g.sale_amount,g.rebate_amount,g.rebate_rate,g.remark,g.source
        FROM af_seckill_activity_goods a LEFT JOIN af_goods g ON (a.goods_id=g.id)
        LEFT JOIN af_goods_price b ON (a.price_id=b.id)
        WHERE a.is_delete=0 AND a.type=2 AND a.special_price>0
        AND g.is_delete=0 AND b.is_delete=0 AND b.is_sale='Y'
        <if test="items != null and items != ''">
            AND a.goods_id IN
            <foreach collection="items" item="item" index="index" separator="," open="(" close=")">
                #{item}
            </foreach>
        </if>
        AND a.activity_id=#{activityId}
        GROUP BY a.goods_id
    </select>
    
    <select id="getActivityGoodsByActName" resultType="AfActGoodsDto">
        SELECT
        a.id rid,min(a.special_price) special_price,a.goods_id,g.name,g.goods_icon,g.thumbnail_icon,g.goods_url,
        g.price_amount,g.sale_amount,g.rebate_amount,g.rebate_rate,g.remark,g.source
        FROM af_seckill_activity_goods a LEFT JOIN af_goods g ON (a.goods_id=g.id)
        LEFT JOIN af_goods_price b ON (a.price_id=b.id)
        WHERE a.is_delete=0 AND a.type=2 AND a.special_price>0
        AND g.is_delete=0 AND b.is_delete=0 AND b.is_sale='Y'
        <if test="items != null and items != ''">
            AND a.goods_id IN
            <foreach collection="items" item="item" index="index" separator="," open="(" close=")">
                #{item}
            </foreach>
        </if>
        AND a.activity_id=#{activityId}
        GROUP BY a.goods_id
    </select>
    
    <select id="getHomePageSecKillGoods" resultType="com.ald.fanbei.api.dal.domain.dto.HomePageSecKillGoods"
    		parameterType="com.ald.fanbei.api.dal.domain.query.HomePageSecKillQuery">
	    SELECT
			min(a.special_price) activityAmount,
			a.goods_id,
			a.limit_count as total,
			g.`name` as goodName,
			g.goods_icon as goodsIcon,
			g.thumbnail_icon,
			g.goods_url as goodsUrl,
			g.price_amount,
			g.sale_amount,
			g.rebate_amount,
			g.rebate_rate,
			g.remark,
			IFNULL(COUNT(DISTINCT o.id), 0) AS volume,
			IF(s.id is null ,0,1) as subscribe,
			c.interest_free_id
		FROM
			af_seckill_activity y
		JOIN af_seckill_activity_goods a ON y.id = a.activity_id
		LEFT JOIN af_goods g ON (a.goods_id = g.id)
		LEFT JOIN af_goods_price b ON (a.price_id = b.id)
		LEFT JOIN af_seckill_activity_order o ON g.id = o.goods_id AND o.activity_id = y.id
		LEFT JOIN af_User_Goods_Sms s on s.goods_id = g.id 
			<if test="userId != null">
				and s.user_id = #{userId}
			</if>
		LEFT JOIN af_scheme_goods c on g.id = c.goods_id
		WHERE
			a.is_delete = 0
		AND y.is_delete = 0
		AND g.is_delete = 0
		AND b.is_delete = 0
		AND b.is_sale = 'Y'
		AND a.type = 2
		AND a.special_price > 0
		AND y.`name` = #{activityName}
		AND y.gmt_end >= #{dateStart}
		AND y.gmt_start <![CDATA[<=]]> #{dateEnd}
		GROUP BY a.goods_id
		order by a.sort DESC
    </select>
    
    <!-- ResourceH5配置的商品较少（可能超过10个），未进行分页   -->
     <select id="getHomePageSecKillGoodsByConfigureResourceH5" resultType="com.ald.fanbei.api.dal.domain.dto.HomePageSecKillGoods">
	SELECT
      MIN(a.special_price) activityAmount,
      g.id,
      a.limit_count AS total,
      g.`name` AS goodName,
      g.goods_icon AS goodsIcon,
      g.thumbnail_icon,
      g.goods_url AS goodsUrl,
      g.price_amount,
      g.sale_amount,
      g.rebate_amount,
      g.rebate_rate,
      g.remark,
      IFNULL(COUNT(DISTINCT o.id), 0) AS volume,
      IF(s.id IS NULL ,0,1) AS subscribe,
      c.interest_free_id
    FROM
      af_goods  g  
      
          LEFT JOIN  af_seckill_activity_goods  a ON g.`id` = a.`goods_id`  AND a.type = 2    AND a.is_delete = 0   AND a.special_price > 0 
          LEFT JOIN  af_seckill_activity Y ON  y.id = a.`activity_id`  AND y.is_delete = 0  AND y.gmt_end <![CDATA[>=]]> NOW()  AND y.gmt_start <![CDATA[<=]]> NOW()
          LEFT JOIN af_goods_price b ON (a.price_id = b.id)   AND b.is_delete = 0  AND b.is_sale = 'Y'
          LEFT JOIN af_seckill_activity_order o ON g.id = o.goods_id AND o.activity_id = y.id  
          LEFT JOIN af_User_Goods_Sms s ON s.goods_id = g.id  
          <if test="userId != null">
				and s.user_id = #{userId}
			</if>  
          LEFT JOIN af_scheme_goods c ON g.id = c.goods_id  
          WHERE
	          g.is_delete = 0
	           <if test="items != null and items != ''">
	             AND g.id IN
	            <foreach collection="items" item="item" index="index" separator="," open="(" close=")">
	                #{item}
	            </foreach>
	            </if>
	          AND g.is_delete = 0   
	          GROUP BY g.id

    </select>
     <select id="getHomePageSecKillGoodsByActivityModel" resultType="com.ald.fanbei.api.dal.domain.dto.HomePageSecKillGoods" parameterType="com.ald.fanbei.api.dal.domain.query.HomePageSecKillByActivityModelQuery">
	SELECT
      MIN(a.special_price) activityAmount,
      g.id,
      a.limit_count AS total,
      g.`name` AS goodName,
      g.goods_icon AS goodsIcon,
      g.thumbnail_icon,
      g.goods_url AS goodsUrl,
      g.price_amount,
      g.sale_amount,
      g.rebate_amount,
      g.rebate_rate,
      g.remark,
      IFNULL(COUNT(DISTINCT o.id), 0) AS volume,
      IF(s.id IS NULL ,0,1) AS subscribe,
      c.interest_free_id
    FROM
      af_goods  g  
     
          JOIN af_activity_model  m ON  m.`goods_id` = g.`id`
          JOIN af_activity ac ON ac.id = m.activity_id   
          LEFT JOIN  af_seckill_activity_goods  a ON g.`id` = a.`goods_id`  AND a.type = 2    AND a.is_delete = 0   AND a.special_price > 0 
          LEFT JOIN  af_seckill_activity Y ON  y.id = a.`activity_id`  AND y.is_delete = 0  AND y.gmt_end <![CDATA[>=]]> NOW()  AND y.gmt_start <![CDATA[<=]]> NOW()
          LEFT JOIN af_goods_price b ON (a.price_id = b.id)   AND b.is_delete = 0  AND b.is_sale = 'Y'
          LEFT JOIN af_seckill_activity_order o ON g.id = o.goods_id AND o.activity_id = y.id  
          LEFT JOIN af_User_Goods_Sms s ON s.goods_id = g.id  
          LEFT JOIN af_scheme_goods c ON g.id = c.goods_id  
          WHERE
	          g.is_delete = 0
	   AND    ac.`is_delete` = 0
	   AND    m.`is_delete` = 0
	   AND    ac.`type` = #{type}
	   AND    ac.`tag` = #{tag}  
	   AND    ac.`title1` = #{tabId}   
	   GROUP BY g.id
	          
	          

    </select>
    
    
</mapper>
