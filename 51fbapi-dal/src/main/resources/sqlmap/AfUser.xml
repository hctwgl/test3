<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ald.fanbei.api.dal.dao.AfUserDao">
	<sql id="queryAllFields">
		id rid,gmt_create,gmt_modified,user_name,password,salt,gender,nick,avatar,real_name,
		mobile,email,birthday,province,city,county,address,recommend_id,fail_count,
		recommend_code,majiabao_name
	</sql>
	
	<sql id="queryRecommendAllFields">
		u.id rid,u.gmt_create,u.user_name,u.nick,u.avatar,u.real_name,ual.amount,ua.realname_status
		
	</sql>

	<insert id="addUser" parameterType="AfUserDo" keyProperty="rid" useGeneratedKeys="true">
		INSERT INTO af_user
		(
			gmt_create,
			gmt_modified,
			user_name,
			password,
			salt,
			nick,
			mobile,
			recommend_id,
			register_channel_id,
			register_channel_point_id
			<if test="majiabaoName != null">
				,majiabao_name
			</if>
		)
		VALUES
		(
			NOW(),
			NOW(),
			#{userName},
			#{password},
			#{salt},
			#{nick},
			#{mobile},
			#{recommendId},
			#{registerChannelId},
			#{registerChannelPointId}
			<if test="majiabaoName != null">
				,#{majiabaoName}
			</if>
		)
	</insert>
	
	<select id="getUserById" resultType="AfUserDo">
		SELECT
			<include refid="queryAllFields" />
		FROM
			af_user
		WHERE
			is_delete = 0
		AND
			id = #{userId}
	</select>

	<select id="getUserByBorrowCashStatus" resultType="java.lang.Long">
		SELECT
		u.id
		FROM
		af_user u
		LEFT JOIN `af_user_auth` ua on u.id= ua.`user_id`
		LEFT JOIN `af_borrow_cash` bc on .bc.user_id= u.id
		WHERE
		u.is_delete = 0
		AND ua.risk_status= 'Y'
		and bc.`is_delete`= 0
		and bc.status in ('WAITTRANSED','TRANSEDING','TRANSED')
		and u.id = #{userId}
		limit 1
	</select>
	
	<select id="getUserIdByMobile" resultType="java.lang.Long">
		SELECT
			id
		FROM
			af_user
		WHERE
			is_delete = 0
		AND
			mobile = #{mobile}
		LIMIT 1
	</select>

	<select id="getUserByMobile" parameterType="java.lang.String" resultType="AfUserDo">
		SELECT
			<include refid="queryAllFields" />
		FROM
		af_user
		WHERE
		is_delete = 0
		AND
		mobile = #{mobile}
		LIMIT 1
	</select>

	<select id="getUserByRecommendCode" resultType="AfUserDo">
		SELECT
			<include refid="queryAllFields" />
		FROM
			af_user
		WHERE
			is_delete = 0
		AND
			recommend_code = #{recommendCode}
	</select>
	
	
	<select id="getRecommendUserByRecommendId" resultType="AfUserInvitationDto">
		SELECT
			<include refid="queryRecommendAllFields" />
		FROM
			af_user u
		LEFT JOIN 
			af_user_auth ua
		ON 
		  	ua.user_id = u.id
		AND
			ua.is_delete = 0	
	
		LEFT JOIN 
			af_user_account_log ual
		ON 
		  	ual.ref_id = u.id
	    AND
			ual.is_delete = 0
		AND
			ual.type = 'AUTHNAME'
		
		WHERE
			u.is_delete = 0
		
		AND
			u.recommend_id = #{recommendId} 
		LIMIT
		 	#{start},#{end}			
		
	</select>
	
	<select id="getUserByUserName" resultType="AfUserDo">
		SELECT
			<include refid="queryAllFields" />
		FROM
			af_user
		WHERE
			is_delete = 0
		AND
			user_name = #{userName}
	</select>

	<select id="getUserNameByUserId" parameterType="java.util.List" resultType="String">
		SELECT
    		user_name 
		FROM 
    		af_user 
       WHERE 
       	id 
       IN 
    <foreach collection="list" item="id" open="(" close=")"
    separator=",">
    #{id}
    </foreach>
	
	
	</select>
	
	<update id="updateUser" parameterType="AfUserDo">
		UPDATE
			af_user
		SET
			gmt_modified = NOW()
		<if test="userName != null">
			,user_name = #{userName}
		</if>
		<if test="password != null">
			,password = #{password}
		</if>
		<if test="salt != null">
			,salt = #{salt}
		</if>
		<if test="gender != null">
			,gender = #{gender}
		</if>
		<if test="nick != null">
			,nick = #{nick}
		</if>
		<if test="avatar != null">
			,avatar = #{avatar}
		</if>
		<if test="realName != null">
			,real_name = #{realName}
		</if>
		<if test="mobile != null">
			,mobile = #{mobile}
		</if>
		<if test="email != null">
			,email = #{email}
		</if>
		<if test="birthday != null">
			,birthday = #{birthday}
		</if>
		<if test="province != null">
			,province = #{province}
		</if>
		<if test="city != null">
			,city = #{city}
		</if>
		<if test="county != null">
			,county = #{county}
		</if>
		<if test="address != null">
			,address = #{address}
		</if>
		<if test="recommendId != null">
			,recommend_id = #{recommendId}
		</if>
		<if test="failCount != null">
			,fail_count = #{failCount}
		</if>
		<if test="recommendCode != null">
			,recommend_code = #{recommendCode}
		</if>
		<if test="majiabaoName != null">
			,majiabao_name = #{majiabaoName}
		</if>
		WHERE
			id = #{rid}
	</update>

	<select id="getUserRecommendCode" resultType="String">
		SELECT recommend_code from af_user
		where is_delete = 0 and id =#{userId}
	</select>
	
	<select id="getUserInfoByUserId" parameterType="java.lang.Long" resultType="AfUserDto">
		SELECT
			au.`real_name`,
			au.`user_name`,
			auaa.`id_number`
		FROM
			af_user au
		LEFT JOIN `af_user_account` auaa ON au.`id` = auaa.`user_id`
		WHERE au.id=#{userId} and au.is_delete = 0
	</select>

</mapper>