<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ald.fanbei.api.dal.dao.AfUserBankcardDao">
	<sql id="queryFields">
		id rid,gmt_create,gmt_modified,user_id,mobile,bank_code,card_number,is_main,bank_name,status,user_cust_no
	</sql>
	
	<sql id="queryWithFields">
		b.id rid,b.gmt_create,b.gmt_modified,b.user_id,b.mobile,b.bank_code,b.card_number,b.is_main,b.bank_name,b.status,b.user_cust_no,
		c.real_name,c.id_number
	</sql>
	
	<insert id="addUserBankcard" parameterType="AfUserBankcardDo" useGeneratedKeys="true" keyProperty="rid">
		INSERT INTO af_user_bankcard(gmt_create , gmt_modified , user_id , mobile , bank_code , card_number , is_main , bank_name , status)
		VALUES (
    		NOW(),
    		NOW(),
    		#{userId},
    		#{mobile},
    		#{bankCode},
    		#{cardNumber},
    		#{isMain},
    		#{bankName},
    		#{status}
		)
	</insert>
	
	<select id="getUserBankInfo" resultType="AfUserBankDto">
		SELECT
			<include refid="queryWithFields"/>
		FROM
			af_user_bankcard b
		LEFT JOIN
			af_user_account c
		ON
			b.is_delete=0 and b.user_id = c.user_id 
		WHERE
			b.is_delete=0 AND b.id=#{bankId}
	</select>
	
	
	<select id="getUserMainBankcardByUserId" resultType="AfUserBankcardDo">
		SELECT
			<include refid="queryFields"/>
		FROM
			af_user_bankcard
		WHERE
			is_delete=0 AND user_id = #{userId} AND is_main = 'Y' and status='B' limit 1
	</select>
	
	<select id="getUserBankcardByUserId" resultType="AfUserBankcardDo">
		SELECT
			<include refid="queryFields"/>
		FROM
			af_user_bankcard
		WHERE
			is_delete=0 
		AND 
			user_id = #{userId} 
		ORDER BY
			is_main 
		DESC
	</select>
	
	<update id="deleteUserBankcardByIdAndUserId">
		UPDATE 
			af_user_bankcard 
		SET 
			gmt_modified = NOW(),is_delete = 1 
		WHERE 
			id=#{rid} 
		AND 
			user_id = #{userId} 
	</update>
	<update id="updateUserBankcard"  parameterType="AfUserBankcardDo">
		UPDATE 
			af_user_bankcard 
		SET 
			gmt_modified = NOW()
		
		<if test="status != null">
			,status = #{status}
		</if>
		<if test="userCustNo != null">
			,user_cust_no = #{userCustNo}
		</if>
		<if test="cardNumber != null">
			,card_number = #{cardNumber}
		</if>
		<if test="isMain != null">
			,is_main = #{isMain}
		</if>
		<if test="bankCode != null">
			,bank_code = #{bankCode}
		</if>
		WHERE 
			id=#{rid} 
		AND 
			user_id = #{userId} 
		AND 	
			is_delete = 0 
	</update>
	
	<select id="getUserBankcardById" resultType="AfUserBankcardDo">
		SELECT
			<include refid="queryFields"/>
		FROM
			af_user_bankcard
		WHERE
			is_delete=0 AND id = #{rid}
	</select>
		<select id="getUserBankcardCountByUserId" resultType="java.lang.Integer">
		SELECT
			count(id)
		FROM
			af_user_bankcard
		WHERE
			is_delete=0 
		AND 
			user_id = #{userId} 

	</select>
</mapper>