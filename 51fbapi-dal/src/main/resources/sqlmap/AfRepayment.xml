<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ald.fanbei.api.dal.dao.AfRepaymentDao">
	<sql id="queryFields">
		id rid,gmt_create,gmt_modified,repay_no,repayment_amount,actual_amount,bill_ids,pay_trade_no,trade_no,user_coupon_id,coupon_amount,rebate_amount,
		status,user_id,card_number,card_name
	</sql>
	
	<insert id="addRepayment" parameterType="AfRepaymentDo" useGeneratedKeys="true" keyProperty="rid">
		INSERT INTO af_repayment(
		gmt_create , 
		gmt_modified , 
		repay_no , 
		name,
		repayment_amount , 
		actual_amount , 
		bill_ids , 
		pay_trade_no , 
		<if test="userCouponId !=null ">
		user_coupon_id , 
		</if>
		<if test="couponAmount !=null ">
		coupon_amount ,
		</if>
		rebate_amount , 
		status,
		user_id,
		card_number,
		card_name)
		VALUES (
    		#{gmtCreate},
    		#{gmtCreate},
    		#{repayNo},
    		#{name},
    		#{repaymentAmount},
    		#{actualAmount},
    		#{billIds},
    		#{payTradeNo},
    		<if test="userCouponId !=null ">
			#{userCouponId}, 
			</if>
			<if test="couponAmount !=null ">
			#{couponAmount},
			</if>
    		#{rebateAmount},
    		#{status},
    		#{userId},
    		#{cardNumber},
    		#{cardName}
		)
	</insert>
	
	<select id="getCurrentLastRepayNo" resultType="java.lang.String">
		select repay_no from af_repayment WHERE repay_no LIKE CONCAT(#{orderNoPre},"%") ORDER BY id DESC LIMIT 1;
	</select>
	
	<select id="getRepaymentById" resultType="AfRepaymentDo">
		select 
			<include refid="queryFields"/> 
		from af_repayment WHERE is_delete=0 and id=#{rid};
	</select>
	
	<select id="getRepaymentByPayTradeNo" resultType="AfRepaymentDo">
		select 
			<include refid="queryFields"/> 
		from af_repayment WHERE is_delete=0 and pay_trade_no=#{payTradeNo};
	</select>
	
	<update id="updateRepayment">
	update af_repayment set gmt_modified=NOW(),status=#{status}
	<if test="tradeNo != null">
	  ,trade_no=#{tradeNo} 
	</if>
	where id=#{rid}
	</update>
	
	<update id="updateRepaymentByAfRepaymentDo" parameterType="AfRepaymentDo" >
		UPDATE af_repayment SET gmt_modified = NOW()
			<if test="name != null">
    			,name=#{name}
			</if>
			<if test="repayNo != null">
    			,repay_no=#{repayNo}
			</if>
			<if test="repaymentAmount != null">
    			,repayment_amount=#{repaymentAmount}
			</if>
			<if test="actualAmount != null">
    			,actual_amount=#{actualAmount}
			</if>
			<if test="billIds != null">
    			,bill_ids=#{billIds}
			</if>
			<if test="payTradeNo != null">
    			,pay_trade_no=#{payTradeNo}
			</if>
			<if test="tradeNo != null">
    			,trade_no=#{tradeNo}
			</if>
			<if test="userCouponId != null">
    			,user_coupon_id=#{userCouponId}
			</if>
			<if test="couponAmount != null">
    			,coupon_amount=#{couponAmount}
			</if>
			<if test="rebateAmount != null">
    			,rebate_amount=#{rebateAmount}
			</if>
			<if test="status != null">
    			,status=#{status}
			</if>
			<if test="userId != null">
    			,user_id=#{userId}
			</if>
			<if test="cardNumber != null">
    			,card_number=#{cardNumber}
			</if>
			<if test="cardName != null">
    			,card_name=#{cardName}
			</if>
		WHERE id = #{rid}
	</update>
	
	<select id="getRepaymentListByIds" resultType="AfRepaymentDo">
		SELECT 
			<include refid="queryFields"/> 
		FROM 
			af_repayment 
		WHERE 
			is_delete=0 
		AND 
			id IN 
		<foreach collection="items" item="item" index="index" separator=","  open="(" close=")">
			#{item}
		</foreach>
	</select>
</mapper>