<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ald.fanbei.api.dal.dao.AfInterestFreeRulesDao">
	<sql id="queryFields">
		id rid,gmt_create,gmt_modified,name,rule_json
	</sql>
	<sql id="reduceSchemeFields">
		id as rid,gmt_create,gmt_modified,creator,modifier,name,is_open,interest_reduce_id,rule_type,tag,DATE_FORMAT(gmt_start,'%Y-%m-%d %H:%i:%s') gmt_start, DATE_FORMAT(gmt_end,'%Y-%m-%d %H:%i:%s')gmt_end,descr
	</sql>
	<sql id="reduceRuleFields">
		id as rid,gmt_create,gmt_modified,name,nper1,nper2,nper3,nper6,nper9,nper12
	</sql>
	<select id="getById" resultType="AfInterestFreeRulesDo">
		SELECT
			<include refid="queryFields" />
		FROM
			af_interest_free_rules
		WHERE
			is_delete =0
		AND
			id = #{id}
	</select>
	<select id="getReduceSchemeByGoodId" resultType="AfInterestReduceSchemeDo">
		SELECT rs.descr,rs.interest_reduce_id,rs.icon_mark FROM af_interest_reduce_goods rg LEFT JOIN  af_interest_reduce_scheme rs ON rs.id=rg.interest_reduce_scheme_id
WHERE  rg.is_delete=0 and rs.is_open='Y' AND unix_timestamp(NOW()) >= unix_timestamp(rs.gmt_start) AND unix_timestamp(rs.gmt_end) >= unix_timestamp(NOW()) and rs.is_delete=0

<if test="goodsId != null and goodsId != ''">
	and (rg.goods_id=#{goodsId} and rs.rule_type =0)
</if>
		<if test="brandId != null and brandId != ''">
			and 	(rg.goods_id=#{brandId} and rs.rule_type =1)
		</if>

		<if test="catogeryId != null and catogeryId != ''">
			and 	(rg.goods_id=#{catogeryId} and rs.rule_type =2)
		</if>
		<if test="brandId == null and goodsId == null and catogeryId == null">
			and rg.goods_id is NULL
		</if>
   ORDER BY rs.gmt_create DESC LIMIT 1
	</select>
	<select id="getReduceRuleById" resultType="AfInterestReduceRulesDo">
		SELECT <include refid="reduceRuleFields" /> FROM af_interest_reduce_rules WHERE id=#{rid} and is_delete=0
	</select>
</mapper>