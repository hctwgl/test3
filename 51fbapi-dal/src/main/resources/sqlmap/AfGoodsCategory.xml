<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ald.fanbei.api.dal.dao.AfGoodsCategoryDao">
	
	<sql id="activitySqlField">
		id,gmt_create,gmt_modified,creator,modifier,name,parent_id,is_show,sort,img_url,level
	</sql>


	<insert id="addGoodsCategory" parameterType="AfGoodsCategoryDo" useGeneratedKeys="true" keyProperty="rid">
		INSERT INTO af_goods_category(gmt_create , gmt_modified , creator , modifier , name , parent_id , is_show , sort , imgUrl , level)
		VALUES (
    		NOW(),
    		NOW(),
    		#{creator},
    		#{modifier},
    		#{name},
    		#{parentId},
    		#{isShow},
    		#{sort},
    		#{imgUrl},
    		#{level},
		)
	</insert>

	<update id="updateGoodsCategory" parameterType="AfGoodsCategoryDo" >
		UPDATE af_goods_category SET gmt_modified = NOW()
		<if test="isDelete != null">
			,is_delete=#{isDelete}
		</if>
		<if test="creator != null">
			,creator=#{creator}
		</if>
		<if test="modifier != null">
			,modifier=#{modifier}
		</if>
		<if test="name != null">
			,name=#{name}
		</if>
		<if test="parentId != null">
			,parent_id=#{parentId}
		</if>
		<if test="isShow != null">
			,is_show=#{isShow}
		</if>
		<if test="sort != null">
			,sort=#{sort}
		</if>
		<if test="imgurl != null">
			,imgurl=#{imgurl}
		</if>
		<if test="level != null">
			,level=#{level}
		</if>
		WHERE id = #{id}
	</update>

	<update id="deleteGoodsCategory" parameterType="java.lang.Long" >
		UPDATE af_goods_category SET is_delete = 1 WHERE id=#{rid}
	</update>

	<select id="selectOneLevel" resultType="AfGoodsCategoryDo">
		SELECT
			<include refid="activitySqlField"></include>
		FROM af_goods_category where level = 1 and is_delete = 0 and is_show = 'Y' and id  != 579  ORDER BY sort
	</select>

	<select id="selectSecondLevel" resultType="AfGoodsCategoryDo" parameterType="java.lang.Long">
		SELECT
			<include refid="activitySqlField"></include>
		FROM af_goods_category
		where parent_id = #{id}
		and is_delete = 0
		and is_show = 'Y'
		AND level = 2
		ORDER BY sort
	</select>

	<select id="selectThirdLevel" resultType="AfGoodsCategoryDo" parameterType="java.lang.Long">
		SELECT
		<include refid="activitySqlField"></include>
		FROM af_goods_category
		where parent_id = #{id}
		and is_delete = 0
		and is_show = 'Y'
		AND level = 3
		ORDER BY sort
	</select>

	<select id="selectGoodsInformation" parameterType="AfGoodsCategoryQuery" resultType="AfGoodsCategoryDto">
		SELECT
			g.source,g.rebate_amount,g.id,g.name,g.goods_icon,g.goods_url,g.num_id,g.price_amount,g.sale_amount,s.volume,g.sale_count,g.gmt_create,g.goods_pic1
	    FROM  af_goods g,af_goods_tbk s
		where s.category_id = #{id}
		and s.num_id = g.num_id
		and s.is_delete = 0
		and g.is_delete = 0
		and g.status = 'PUBLISH'
		order by g.gmt_create DESC
	</select>

	<select id="getParentDirectoryByName" resultType="AfGoodsCategoryDo"  parameterType="java.lang.String">
		SELECT
			id,SUBSTRING_INDEX(name,'@', 1) name,parent_id,is_show,sort,img_url,level
		FROM
			af_goods_category
		WHERE
			is_delete=0 
			AND level=1 
			AND parent_id = 0
			and name= #{name}
			limit 0,1
	</select>
	<select id="listByParentIdAndLevel" resultType="com.ald.fanbei.api.dal.domain.AfGoodsCategoryDo"  parameterType="com.ald.fanbei.api.dal.domain.AfGoodsCategoryDo">
		SELECT
				id,SUBSTRING_INDEX(name, '@', 1) name,parent_id,is_show,sort,img_url,level
		FROM
			af_goods_category
		WHERE
			is_delete = 0 
			AND level = #{level}
			AND parent_id = #{parentId}
			order by sort desc
	</select>

	<select id="getGoodsCategoryById" resultType="com.ald.fanbei.api.dal.domain.AfGoodsCategoryDo">
		SELECT
		<include refid="activitySqlField"></include>
		FROM
		af_goods_category
		WHERE
		is_delete=0 AND id = #{rid}
	</select>
</mapper>